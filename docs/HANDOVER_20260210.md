# RAKUDA 引き継ぎ書 - 2026年2月10日

## 実行方法

```bash
cd ~/Desktop/rakuda
claude --dangerously-skip-permissions
```

上記コマンドで起動後、この引き継ぎ書の内容をペーストして開始。

---

## 現在の状態

### 完了済みフェーズ
- **Phase 40: Joom出品ワークフロー** - 全サブフェーズ完了
- **Phase 41: 本番基盤構築（DevOps & Observability）** - 完了
  - Phase 41-A: Docker本番環境構築（entrypoint、自動マイグレーション）
  - Phase 41-B: 観測基盤（Sentry統合、BullMQジョブ失敗通知）
  - Phase 41-C: CI/CD強化（既存で完備済み）
- **Phase 42: 最小E2Eテスト** - 完了
- **Phase 43: カナリアリリース** - 実装完了・Phase 3まで実行済み

### カナリアリリース状況（2026-02-10時点）

| Phase | 出品数 | ステータス |
|-------|--------|-----------|
| Phase 1 | 3件 | ACTIVE |
| Phase 2 | 3件 | ACTIVE |
| Phase 3 | 19件 | 24件ACTIVE / 1件ERROR |
| **合計** | **25件** | **成功率96%** |

#### エラー商品
- Patek Philippe Calatrava Manual Watch（原因不明、Joom Portal要確認）

### 動作確認済み
- Joom OAuth認証（トークン有効期限: 2026-03-08）
- OpenAI GPT-4o翻訳（遅延初期化で修正済み）
- 禁制品チェック（バッテリー検出など）
- BullMQ非同期ジョブ処理（8ワーカー稼働確認）
- S3/MinIOストレージ（遅延初期化で修正済み）
- Sentry統合（DSN設定時のみ有効化）
- カナリアリリースUI・API

### 環境情報
- Node.js: v22.18.0
- Docker: PostgreSQL, Redis, MinIO稼働中
- 設定ファイル: `.env` に全認証情報設定済み

---

## カナリアリリースコマンド

```bash
# ステータス確認
npm run canary:status

# Phase 4 リリース（50件まで）
npm run canary:phase4

# Phase 5 リリース（100件まで）
npm run canary:phase5

# ロールバック（全出品停止）
npm run canary:rollback
```

### Web UI
- カナリアダッシュボード: http://localhost:3002/admin/canary
- ジョブキュー管理: http://localhost:3000/admin/queues

---

## 次期開発方針

### 推奨される次のステップ
1. Joom Merchant Portalで24件の出品状態を確認
2. Patek Philippeのエラー原因を調査
3. 問題なければ Phase 4（50件）→ Phase 5（100件）と段階的に拡大
4. 本番運用移行後、価格最適化・UI改善を検討

### Phase 4 実行手順
```bash
# 追加商品が必要な場合
npx tsx scripts/add-safe-products.ts

# Phase 4 実行
npm run canary:phase4
```

---

## 主要ファイル

### カナリアリリース関連
| ファイル | 説明 |
|---------|------|
| `scripts/canary-release.ts` | CLIスクリプト |
| `scripts/add-safe-products.ts` | テスト商品追加 |
| `apps/api/src/routes/admin.ts` | REST APIエンドポイント |
| `apps/web/src/app/admin/canary/page.tsx` | Web UI |

### 安全カテゴリ設定
```typescript
// scripts/canary-release.ts
const SAFE_CATEGORIES = [
  'watch', 'jewelry', 'bag', 'fashion',
  'accessory', 'interior', 'hobby', 'collectible', 'stationery'
];

const EXCLUDED_KEYWORDS = [
  'battery', 'knife', 'weapon', 'medicine',
  'cosmetic', 'food', 'liquid', 'alcohol',
  'fake', 'replica', 'copy'
];
```

---

## ディレクトリ構成

```
rakuda/
├── apps/
│   ├── api/           # Express.js API (port 3000)
│   ├── web/           # Next.js Frontend (port 3002)
│   │   └── e2e/       # Playwright E2Eテスト
│   └── worker/        # BullMQ Workers
├── packages/
│   ├── database/      # Prisma
│   ├── enrichment/    # AI翻訳・属性抽出
│   ├── config/        # 共通設定
│   └── logger/        # ロギング + Sentry統合
├── scripts/
│   ├── canary-release.ts   # カナリアリリース
│   └── add-safe-products.ts # テスト商品追加
├── docker-compose.yml      # 開発環境
├── docker-compose.prod.yml # 本番環境
└── docs/                   # 設計書
```

---

## 開発コマンド

```bash
# 開発サーバー起動
npm run dev

# テスト
npm run test:unit
npm run test:e2e

# ビルド
npm run build

# Docker
docker-compose up -d
docker-compose -f docker-compose.prod.yml up -d
```

---

## 技術的注意事項

### 遅延初期化パターン
以下のファイルは環境変数読み込みタイミングの問題で遅延初期化に修正済み:
- `apps/worker/src/lib/storage.ts` - S3Client
- `packages/enrichment/src/translator.ts` - OpenAI Client

### Prismaスキーマ注意点
- `Product.status`: `ProductStatus` enum（DRAFTは存在しない）
- `Listing.status`: `ListingStatus` enum（DISABLEDは存在しない、PAUSEDを使用）
- `Product` → `Source` リレーションは必須

### Sentry設定
- DSNは環境変数`SENTRY_DSN`で設定
- 開発環境ではSentryに送信しない
- BullMQのDLQ移動時のみ通知

---

## 最近のコミット

```
38a2fc5 docs: update handover with canary Phase 3 execution status
cfad282 feat: add safe category products script for canary testing
```

---

## 開発ログ
- Obsidian: `/開発ログ/rakuda_canary_phase3_20260210.md`
