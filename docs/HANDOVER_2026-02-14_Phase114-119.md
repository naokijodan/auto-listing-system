# RAKUDA 引き継ぎ書
## 2026年2月14日 Phase 114-119

---

## サマリー
**6 Phase完了**: eBay高度管理機能群（競合分析/自動価格/スケジュール/在庫補充/AI最適化/A/Bテスト）

---

## 完了機能一覧（業務フロー順）

| Phase | 機能名 | APIファイル | UIページ | 主要機能 | 依存 |
|-------|--------|------------|----------|----------|------|
| 114 | 競合分析 | `ebay-competitors.ts` | `/ebay/competitors` | 競合URL追跡、価格アラート、履歴 | CompetitorListing※ |
| 115 | 自動価格調整 | `ebay-auto-pricing.ts` | `/ebay/auto-pricing` | ルール管理、ドライラン、実行 | PricingRule, PriceChangeLog |
| 116 | スケジュール出品 | `ebay-scheduled.ts` | `/ebay/scheduled` | 予約作成、カレンダー、一括 | ScheduledListing |
| 117 | 在庫自動補充 | `ebay-auto-restock.ts` | `/ebay/auto-restock` | 低在庫アラート、発注管理 | RestockRule/Log/Order |
| 118 | 出品最適化 | `ebay-optimization.ts` | `/ebay/optimization` | AIタイトル改善、キーワード提案 | ListingOptimization, OpenAI |
| 119 | A/Bテスト | `ebay-ab-tests.ts` | `/ebay/ab-tests` | AI最適化の効果測定、統計的有意性 | ABTest, Phase 118連携 |

※ Phase 114は既存のCompetitorTrackerモデルを活用

---

## Phase間の連携関係

```
┌─────────────────────────────────────────────────────────────────┐
│                         eBay管理画面                              │
└─────────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│  Phase 114    │      │  Phase 116    │      │  Phase 117    │
│   競合分析    │      │ スケジュール   │      │  在庫補充     │
│ 価格追跡/ア   │      │  予約出品     │      │ 低在庫管理    │
│  ラート       │      │  カレンダー    │      │  発注管理     │
└───────┬───────┘      └───────────────┘      └───────────────┘
        │
        ▼ 競合価格データ
┌───────────────┐
│  Phase 115    │
│ 自動価格調整   │◀──────┐
│ ルールベース   │       │
└───────┬───────┘       │
        │               │
        ▼ 価格変更      │ 最適化提案の効果
┌───────────────┐       │
│  Phase 118    │       │
│  AI最適化     │───────┤
│タイトル/説明改善│       │
└───────┬───────┘       │
        │               │
        ▼ A/Bテスト作成  │
┌───────────────┐       │
│  Phase 119    │───────┘
│  A/Bテスト    │
│ 効果測定/有意性│
└───────────────┘
```

### 重要な連携: Phase 118 → 119

**データフロー**:
1. AI最適化でタイトル/説明/キーワードの改善提案を生成
2. 提案からA/Bテストを作成（コントロール＝元の値、バリアント＝AI提案）
3. イベント追跡（インプレッション、クリック、購入）
4. 統計的有意性を判定（Z検定、95%信頼区間）
5. 勝者バリアントを全体に適用

**A/Bテスト指標**:
- `CONVERSION_RATE` - コンバージョン率（閲覧→購入）
- `CLICK_RATE` - クリック率
- `REVENUE` - 収益

---

## 追加Prismaモデル

### 新規追加

| モデル | Phase | 用途 |
|--------|-------|------|
| `ScheduledListing` | 116 | スケジュール出品（日時、ステータス） |
| `RestockRule` | 117 | 補充ルール（閾値、補充数） |
| `RestockLog` | 117 | 補充履歴 |
| `RestockOrder` | 117 | 発注管理 |
| `ListingOptimization` | 118 | 最適化提案（タイプ、元値、提案値） |

### 既存モデル（Phase 119で活用）

| モデル | 用途 |
|--------|------|
| `ABTest` | A/Bテスト設定（Phase 77で作成済み） |
| `ABTestVariant` | バリアント（コントロール/テスト） |
| `ABTestAssignment` | リスティングへの割り当て |

---

## BullMQジョブ詳細

| ジョブ名 | キュー | Phase | トリガー | 入力 | 出力 | 再試行 |
|---------|--------|-------|---------|------|------|--------|
| `check-competitor-price` | INVENTORY | 114 | 手動/スケジュール | competitorId | 価格更新 | 3回 |
| `sync-ebay-price` | INVENTORY | 115 | 価格調整実行後 | listingId, newPrice | eBay API更新 | 3回 |
| `publish-scheduled-listing` | LISTING | 116 | 予約時刻到達 | scheduleId, listingId | 出品実行 | 3回 |
| `resume-listing` | INVENTORY | 117 | 在庫復活時 | productId | 出品再開 | 3回 |
| `generate-optimization` | LISTING | 118 | 一括生成時 | listingId | AI提案生成 | 2回 |
| `sync-ebay-listing` | LISTING | 118 | 最適化適用後 | listingId | eBay更新 | 3回 |

---

## 監視・アラート

### 推奨監視項目
- BullMQ失敗ジョブ数（閾値: 5件/時）
- 自動価格調整の実行回数（異常な急増を検知）
- OpenAI API呼び出し回数・コスト
- 低在庫アラート数
- A/Bテストの有意差検出率

---

## 次回推奨Phase

### 推奨: Phase 120（多言語対応）

**理由**:
1. Phase 119でA/Bテスト基盤が完成
2. 海外マーケットプレイスでは多言語対応が必須
3. タイトル・説明文の多言語化で市場拡大

**Phase 120 想定機能**:
- タイトル・説明文の多言語翻訳（英語以外）
- 言語別テンプレート
- 自動言語検出

### 代替候補
- Phase 121: eBayプロモーション連携
- Phase 122: レポート自動生成

---

## ファイル構成

```
apps/api/src/routes/
├── ebay-competitors.ts      # Phase 114
├── ebay-auto-pricing.ts     # Phase 115
├── ebay-scheduled.ts        # Phase 116
├── ebay-auto-restock.ts     # Phase 117
├── ebay-optimization.ts     # Phase 118
└── ebay-ab-tests.ts         # Phase 119

apps/web/src/app/ebay/
├── competitors/page.tsx     # Phase 114
├── auto-pricing/page.tsx    # Phase 115
├── scheduled/page.tsx       # Phase 116
├── auto-restock/page.tsx    # Phase 117
├── optimization/page.tsx    # Phase 118
└── ab-tests/page.tsx        # Phase 119
```

---

## 引き継ぎ文（コピペ用）

```
Phase 114-119完了。eBay高度管理機能群を実装。
- 競合分析: 競合URL追跡、価格アラート
- 自動価格調整: ルールベース、競合追従、ドライラン
- スケジュール出品: 予約出品、カレンダービュー
- 在庫自動補充: 低在庫アラート、発注管理
- 出品最適化: AIタイトル・説明改善（OpenAI GPT-4o）
- A/Bテスト: AI最適化の効果測定、統計的有意性判定

Phase 118→119の連携が重要（AI最適化→A/Bテスト）。
次回はPhase 120（多言語対応）推奨。
```

---

## コミット履歴

| コミット | 内容 |
|---------|------|
| `0aa810b` | Phase 114 eBay競合分析 |
| `6f5cb85` | Phase 115 eBay自動価格調整 |
| `db12b5d` | Phase 116-118 スケジュール/在庫補充/最適化 |
| (新規) | Phase 119 eBay A/Bテスト |
