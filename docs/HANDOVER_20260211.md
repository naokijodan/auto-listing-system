# RAKUDA 引き継ぎ書 - 2026年2月11日

## 実行方法

```bash
cd ~/Desktop/rakuda
claude --dangerously-skip-permissions
```

上記コマンドで起動後、この引き継ぎ書の内容をペーストして開始。

---

## 現在の状態

### 完了済み
- **Phase 40: Joom出品ワークフロー** - 全サブフェーズ完了
- **Phase 41: 本番基盤構築（DevOps & Observability）** - 完了
  - Phase 41-A: Docker本番環境構築（entrypoint、自動マイグレーション）
  - Phase 41-B: 観測基盤（Sentry統合、BullMQジョブ失敗通知）
  - Phase 41-C: CI/CD強化（既存で完備済み：GHCR、レイヤーキャッシュ）

### 動作確認済み
- Joom OAuth認証（トークン有効期限: 2026-03-08）
- OpenAI GPT-4o翻訳（遅延初期化で修正済み）
- 禁制品チェック（バッテリー検出など）
- BullMQ非同期ジョブ処理（8ワーカー稼働確認）
- S3/MinIOストレージ（遅延初期化で修正済み）
- Sentry統合（DSN設定時のみ有効化）

### テストカバレッジ
- workerパッケージ: 80%以上達成（1154テスト全パス）

### 環境情報
- Node.js: v22.18.0
- Docker: PostgreSQL, Redis, MinIO稼働中
- 設定ファイル: `.env` に全認証情報設定済み

---

## Phase 41 実装詳細（2026-02-10完了）

### 41-A: Docker本番環境構築
- [x] `docker-entrypoint.sh` 作成（自動マイグレーション）
- [x] Dockerfile更新（ENTRYPOINT追加）
- [x] 非rootユーザー実行（既存）
- [x] ヘルスチェック（既存）
- [x] ログローテーション（既存）

### 41-B: 観測基盤（Observability）
- [x] Sentry統合（`@rakuda/logger`）
- [x] BullMQジョブ失敗時のSentry通知（DLQ移動時のみ）
- [x] ノイズ対策（一時的なネットワークエラーはフィルタ）
- [x] 機密情報マスク

### 41-C: CI/CD強化
- [x] GitHub Actionsデプロイパイプライン（既存）
- [x] 自動テスト実行（既存）
- [x] Docker イメージビルド・プッシュ（既存、GHCR）
- [x] レイヤーキャッシュ（既存、type=gha）

---

## 3者協議による次期開発方針（2026-02-10実施）

### 参加者
- Claude (Opus 4.5)
- GPT-5
- Gemini

### 次期優先順位
1. **Phase 42: 最小E2Eテスト** - 次のセッション
2. **Phase 43: カナリアリリース** - 基盤完成後

### Phase 42 詳細設計

#### 最小E2Eテスト（Playwright）
- [ ] 商品データ入力 → AI翻訳 → Joom出品リクエストの1本道
- [ ] 目的: デプロイごとのリグレッション検知
- [ ] 網羅的テストは後回し

### Phase 43 詳細設計

#### カナリアリリース戦略
- [ ] 特定カテゴリ（安全な商品）で数点のみ出品
- [ ] ログ監視で問題検出
- [ ] 段階的に出品数を拡大

---

## 重要な技術的注意事項

### 遅延初期化パターン
以下のファイルは環境変数読み込みタイミングの問題で遅延初期化に修正済み:
- `apps/worker/src/lib/storage.ts` - S3Client
- `packages/enrichment/src/translator.ts` - OpenAI Client

新しいAPIクライアントを追加する際は同様のパターンを適用すること。

### Sentry設定
- DSNは環境変数`SENTRY_DSN`で設定
- 開発環境ではSentryに送信しない
- BullMQのDLQ移動時のみ通知（ノイズ対策）

### Prismaスキーマ
- `Product.status` は `ProductStatus` enum を使用（DRAFT は存在しない）
- `Product` は `Source` へのリレーションが必須

---

## 作業完了時の必須タスク

1. **Gitコミット・プッシュ** - 変更完了後に必ず実行
2. **Obsidianノート作成** - `/開発ログ/rakuda_phase42_*.md`
3. **この引き継ぎ書の更新** - 次セッション用に状態を更新

---

## ファイル構成（主要）

```
rakuda/
├── apps/
│   ├── api/           # Express.js API (port 3000)
│   ├── web/           # Next.js Frontend (port 3002)
│   └── worker/        # BullMQ Workers
├── packages/
│   ├── database/      # Prisma
│   ├── enrichment/    # AI翻訳・属性抽出
│   ├── config/        # 共通設定
│   └── logger/        # ロギング + Sentry統合
├── docker-compose.yml      # 開発環境
├── docker-compose.prod.yml # 本番環境
├── docker-entrypoint.sh    # コンテナ起動スクリプト
└── docs/                   # 設計書
```

---

## 開発コマンド

```bash
# 開発サーバー起動
npm run dev

# ワーカー起動
cd apps/worker && npm run dev

# テスト
npm run test:unit
npm run test:coverage

# Prisma
npx prisma generate --schema=packages/database/prisma/schema.prisma
npx prisma migrate dev --schema=packages/database/prisma/schema.prisma

# Docker
docker-compose up -d
docker-compose ps

# 本番Docker
docker-compose -f docker-compose.prod.yml up -d
```
