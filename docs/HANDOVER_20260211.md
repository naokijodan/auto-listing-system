# RAKUDA 引き継ぎ書 - 2026年2月11日

## 実行方法

```bash
cd ~/Desktop/rakuda
claude --dangerously-skip-permissions
```

上記コマンドで起動後、この引き継ぎ書の内容をペーストして開始。

---

## 現在の状態

### 完了済み
- **Phase 40: Joom出品ワークフロー** - 全サブフェーズ完了
- **Phase 41: 本番基盤構築（DevOps & Observability）** - 完了
  - Phase 41-A: Docker本番環境構築（entrypoint、自動マイグレーション）
  - Phase 41-B: 観測基盤（Sentry統合、BullMQジョブ失敗通知）
  - Phase 41-C: CI/CD強化（既存で完備済み：GHCR、レイヤーキャッシュ）
- **Phase 42: 最小E2Eテスト** - 完了
  - Joom出品フローE2Eテスト作成
  - クリティカルパステスト
  - API統合テスト
- **Phase 43: カナリアリリース** - 完了・実行済み
  - カナリアリリーススクリプト作成
  - 安全カテゴリ判定ロジック
  - 段階的出品（Phase 1-5）
  - ロールバック機能
  - Web UI（/admin/canary）
  - REST API（/api/admin/canary/*）
  - **Phase 3実行済み**: 25件出品（20件ACTIVE、5件PUBLISHING）

### 動作確認済み
- Joom OAuth認証（トークン有効期限: 2026-03-08）
- OpenAI GPT-4o翻訳（遅延初期化で修正済み）
- 禁制品チェック（バッテリー検出など）
- BullMQ非同期ジョブ処理（8ワーカー稼働確認）
- S3/MinIOストレージ（遅延初期化で修正済み）
- Sentry統合（DSN設定時のみ有効化）
- カナリアリリースUI・API

### テストカバレッジ
- workerパッケージ: 80%以上達成（1154テスト全パス）
- E2Eテスト: joom-publish-flow.spec.ts追加

### 環境情報
- Node.js: v22.18.0
- Docker: PostgreSQL, Redis, MinIO稼働中
- 設定ファイル: `.env` に全認証情報設定済み

---

## Phase 42 実装詳細（最小E2Eテスト）

### 作成ファイル
- `apps/web/e2e/joom-publish-flow.spec.ts`

### テスト内容
- 商品 → 翻訳 → Joom出品のフロー確認
- API統合テスト（ヘルスチェック、商品一覧、出品一覧）
- ジョブキュー動作確認
- エラーハンドリング確認
- スモークテスト（全クリティカルページの表示確認）

---

## Phase 43 実装詳細（カナリアリリース）

### 作成ファイル
- `scripts/canary-release.ts` - CLIスクリプト
- `apps/api/src/routes/admin.ts` - APIエンドポイント追加
- `apps/web/src/app/admin/canary/page.tsx` - Web UI

### コマンド
```bash
# ステータス確認
npm run canary:status

# Phase 1 リリース（3件）
npm run canary:phase1

# Phase 2 リリース（10件）
npm run canary:phase2

# Phase 3 リリース（25件）
npm run canary:phase3

# ロールバック
npm run canary:rollback
```

### API エンドポイント
- `GET /api/admin/canary/status` - ステータス取得
- `POST /api/admin/canary/release` - リリース実行
- `POST /api/admin/canary/rollback` - ロールバック

### 安全カテゴリ（禁制品リスクが低い）
- ウォッチ、アクセサリー、ジュエリー
- バッグ、ファッション
- インテリア、ホビー、コレクション
- 文房具

### 除外キーワード
- バッテリー、リチウム、電池
- ナイフ、刃物、武器
- 医薬品、化粧品、食品
- 液体、アルコール
- 偽物、レプリカ、コピー

---

## 重要な技術的注意事項

### 遅延初期化パターン
以下のファイルは環境変数読み込みタイミングの問題で遅延初期化に修正済み:
- `apps/worker/src/lib/storage.ts` - S3Client
- `packages/enrichment/src/translator.ts` - OpenAI Client

### Sentry設定
- DSNは環境変数`SENTRY_DSN`で設定
- 開発環境ではSentryに送信しない
- BullMQのDLQ移動時のみ通知（ノイズ対策）

### Prismaスキーマ
- `Product.status` は `ProductStatus` enum を使用（DRAFT は存在しない）
- `Listing.status` は `ListingStatus` enum を使用（DISABLED は存在しない、PAUSEDを使用）
- `Product` は `Source` へのリレーションが必須

---

## 次期開発方針

### 推奨される次のステップ
1. ✅ カナリアリリース Phase 1-3 実行済み（25件出品中）
2. Joom Merchant Portalで出品状態を確認
3. 問題なければ Phase 4（50件）→ Phase 5（100件）と段階的に拡大
4. 本番運用移行後、価格最適化・UI改善を検討

### カナリアリリース現状（2026-02-10）
- Phase 1: 3件 ACTIVE
- Phase 2: 3件 ACTIVE
- Phase 3: 19件追加（20件ACTIVE、5件PUBLISHING）
- 合計: 25件（Phase 3上限達成）
- 成功率: 80%以上

---

## ファイル構成（主要）

```
rakuda/
├── apps/
│   ├── api/           # Express.js API (port 3000)
│   ├── web/           # Next.js Frontend (port 3002)
│   │   └── e2e/       # Playwright E2Eテスト
│   └── worker/        # BullMQ Workers
├── packages/
│   ├── database/      # Prisma
│   ├── enrichment/    # AI翻訳・属性抽出
│   ├── config/        # 共通設定
│   └── logger/        # ロギング + Sentry統合
├── scripts/
│   └── canary-release.ts  # カナリアリリーススクリプト
├── docker-compose.yml      # 開発環境
├── docker-compose.prod.yml # 本番環境
├── docker-entrypoint.sh    # コンテナ起動スクリプト
└── docs/                   # 設計書
```

---

## 開発コマンド

```bash
# 開発サーバー起動
npm run dev

# テスト
npm run test:unit
npm run test:e2e

# ビルド
npm run build

# カナリアリリース
npm run canary:status
npm run canary:phase1

# Docker
docker-compose up -d
docker-compose -f docker-compose.prod.yml up -d
```
