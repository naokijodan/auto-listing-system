// Prisma Schema for Auto Listing System
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// 仕入元情報
// ========================================
model Source {
  id        String     @id @default(cuid())
  type      SourceType
  name      String
  url       String?
  isActive  Boolean    @default(true)
  metadata  Json       @default("{}")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  products Product[]

  @@map("sources")
}

enum SourceType {
  MERCARI
  YAHOO_AUCTION
  YAHOO_FLEA
  RAKUMA
  RAKUTEN
  AMAZON
  TAKAYAMA
  JOSHIN
  OTHER
}

// ========================================
// 統一商品モデル
// ========================================
model Product {
  id String @id @default(cuid())

  // ソース情報
  sourceId     String
  source       Source @relation(fields: [sourceId], references: [id])
  sourceItemId String // 元サイトの商品ID
  sourceUrl    String
  sourceHash   String? // 差分検知用ハッシュ

  // 基本情報（原文）
  title       String
  description String @db.Text
  price       Int // 仕入価格（円）

  // 翻訳済み情報
  titleEn       String?
  descriptionEn String? @db.Text

  // 商品属性
  category   String?
  brand      String?
  condition  String?
  weight     Int? // グラム
  attributes Json   @default("{}") // AI抽出属性

  // 画像
  images          String[] // 元画像URL
  processedImages String[] // 白抜き後URL（MinIO/S3）

  // セラー情報
  sellerId   String?
  sellerName String?

  // ステータス
  status            ProductStatus @default(PENDING_SCRAPE)
  translationStatus ProcessStatus @default(PENDING)
  imageStatus       ProcessStatus @default(PENDING)
  lastError         String?       @db.Text

  // タイムスタンプ
  scrapedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  listings Listing[]
  jobLogs  JobLog[]

  // Phase 36: AI機能強化
  pricePredictions PricePrediction[]
  competitorPrices CompetitorPrice[]

  @@unique([sourceId, sourceItemId])
  @@index([status])
  @@index([sourceHash])
  @@index([createdAt])
  @@map("products")
}

enum ProductStatus {
  PENDING_SCRAPE
  SCRAPED
  PROCESSING_IMAGES
  TRANSLATING
  READY_TO_REVIEW
  APPROVED
  PUBLISHING
  ACTIVE
  SOLD
  OUT_OF_STOCK
  ERROR
  DELETED
}

enum ProcessStatus {
  PENDING
  PROCESSING
  COMPLETED
  ERROR
}

// ========================================
// 出品情報（マーケットプレイス別）
// ========================================
model Listing {
  id String @id @default(cuid())

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  marketplace          Marketplace
  marketplaceListingId String? // eBay/Joom の出品ID

  // 価格情報
  listingPrice Float // 出品価格（USD）
  shippingCost Float? // 送料
  currency     String @default("USD")

  // マーケット固有データ（JSONB）
  marketplaceData Json @default("{}")

  // ステータス
  status       ListingStatus @default(DRAFT)
  errorMessage String?       @db.Text

  // 在庫自動化制御（Phase 17）
  autoStatusEnabled Boolean   @default(true)  // 自動停止/再開の有効化
  pausedByInventory Boolean   @default(false) // 在庫切れによる自動停止中
  resumeAt          DateTime?                 // 遅延再開予定日時

  // タイムスタンプ
  listedAt  DateTime?
  soldAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // リレーション
  inventoryAlerts InventoryAlert[]
  sales           Sale[]

  @@unique([productId, marketplace])
  @@index([marketplace, status])
  @@index([marketplaceListingId])
  @@index([pausedByInventory, resumeAt])
  @@map("listings")
}

enum Marketplace {
  JOOM
  EBAY
}

enum ListingStatus {
  DRAFT
  PENDING_PUBLISH
  PUBLISHING
  ACTIVE
  PAUSED
  SOLD
  ENDED
  ERROR
}

// ========================================
// ジョブログ
// ========================================
model JobLog {
  id String @id @default(cuid())

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  jobId        String // BullMQ Job ID
  queueName    String
  jobType      String
  status       JobStatus
  payload      Json      @default("{}")
  result       Json?
  errorMessage String?   @db.Text

  startedAt   DateTime
  completedAt DateTime?
  duration    Int? // ミリ秒

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([queueName, status])
  @@index([createdAt])
  @@index([jobId])
  @@map("job_logs")
}

enum JobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  DEAD_LETTER
}

// ========================================
// 価格計算設定
// ========================================
model PriceSetting {
  id String @id @default(cuid())

  name        String      @unique
  marketplace Marketplace

  // 手数料
  platformFeeRate Float // プラットフォーム手数料率
  paymentFeeRate  Float // 決済手数料率

  // マージン
  targetProfitRate Float // 目標利益率
  adRate           Float @default(0) // 広告費率

  // 為替
  exchangeRate   Float // USD/JPY
  exchangeBuffer Float @default(0) // 為替バッファ

  // カテゴリ別設定（オプション）
  categorySettings Json @default("{}")

  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("price_settings")
}

// ========================================
// eBay シッピングポリシー
// ========================================
model ShippingPolicy {
  id String @id @default(cuid())

  name   String
  region String // US, EU, ASIA など

  // 配送方法
  carrier String // ePacket, Cpass, EMS など

  // 送料テーブル（重量別）
  shippingTable Json // { "100": 880, "200": 1060, ... }

  // 燃油サーチャージ
  fuelSurcharge Float @default(0)

  // 関税設定
  dutyThreshold Float? // 関税閾値（USD）
  dutyRate      Float? // 関税率

  // 追加設定
  handlingTime Int    @default(1) // 発送準備日数
  metadata     Json   @default("{}")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([region, carrier])
  @@map("shipping_policies")
}

// ========================================
// 為替レート履歴
// ========================================
model ExchangeRate {
  id String @id @default(cuid())

  fromCurrency String @default("JPY")
  toCurrency   String @default("USD")
  rate         Float

  fetchedAt DateTime @default(now())
  source    String   @default("manual") // manual, api, etc.

  @@index([fromCurrency, toCurrency, fetchedAt])
  @@map("exchange_rates")
}

// ========================================
// 翻訳プロンプト設定
// ========================================
model TranslationPrompt {
  id String @id @default(cuid())

  name        String  @unique // プロンプト名
  category    String? // 対象カテゴリ（nullはデフォルト）
  marketplace String? // joom, ebay, null=共通

  // プロンプト内容
  systemPrompt String @db.Text // システムプロンプト
  userPrompt   String @db.Text // ユーザープロンプトテンプレート

  // 抽出する属性
  extractAttributes String[] // ["brand", "model", "color", ...]

  // 追加指示
  additionalInstructions String? @db.Text
  seoKeywords            String[] // SEO推奨ワード

  // 設定
  priority  Int     @default(0) // 優先度（高いほど優先）
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  templates ListingTemplate[]

  @@index([category, marketplace])
  @@map("translation_prompts")
}

// ========================================
// eBay カテゴリマッピング
// ========================================
model EbayCategoryMapping {
  id String @id @default(cuid())

  sourceCategory String // 元カテゴリ（日本語）
  ebayCategoryId String // eBayカテゴリID
  ebayCategoryName String // eBayカテゴリ名

  // Item Specifics テンプレート
  itemSpecifics Json @default("{}")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  templates ListingTemplate[]

  @@unique([sourceCategory])
  @@map("ebay_category_mappings")
}

// ========================================
// 出品テンプレート
// ========================================
model ListingTemplate {
  id String @id @default(cuid())

  name        String @unique // テンプレート名
  description String? // 説明

  // カテゴリマッピングへの参照
  categoryMappingId String?
  categoryMapping   EbayCategoryMapping? @relation(fields: [categoryMappingId], references: [id])

  // 翻訳プロンプトへの参照
  translationPromptId String?
  translationPrompt   TranslationPrompt? @relation(fields: [translationPromptId], references: [id])

  // 価格設定
  profitRate Float @default(30) // 目標利益率 (%)
  minProfit  Float @default(500) // 最低利益額 (円)

  // 出品設定
  titleTemplate       String? @db.Text // タイトルテンプレート
  descriptionTemplate String? @db.Text // 説明文テンプレート
  conditionMapping    Json    @default("{}") // コンディション変換マップ

  // デフォルト値
  defaultWeight       Int?    // デフォルト重量 (g)
  defaultShippingDays String? // 配送日数

  // 設定
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryMappingId])
  @@map("listing_templates")
}

// ========================================
// マーケットプレイス認証情報
// ========================================
model MarketplaceCredential {
  id String @id @default(cuid())

  marketplace Marketplace
  name        String      @default("default") // アカウント名

  // 認証情報（暗号化推奨）
  credentials Json // { clientId, clientSecret, accessToken, refreshToken, ... }

  // トークン有効期限
  tokenExpiresAt        DateTime?
  refreshTokenExpiresAt DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([marketplace, name])
  @@index([marketplace, isActive])
  @@map("marketplace_credentials")
}

// ========================================
// OAuth状態管理（CSRF対策）
// ========================================
model OAuthState {
  id String @id @default(cuid())

  state     String   @unique
  provider  String // EBAY, JOOM, etc.
  expiresAt DateTime
  metadata  Json     @default("{}")

  createdAt DateTime @default(now())

  @@index([provider, expiresAt])
  @@map("oauth_states")
}

// ========================================
// 通知
// ========================================
model Notification {
  id String @id @default(cuid())

  type      NotificationType
  title     String
  message   String           @db.Text
  severity  NotificationSeverity @default(INFO)

  // 関連データ
  productId String?
  listingId String?
  jobLogId  String?
  metadata  Json @default("{}")

  // ステータス
  isRead    Boolean  @default(false)
  readAt    DateTime?

  createdAt DateTime @default(now())

  @@index([isRead, createdAt])
  @@index([type])
  @@map("notifications")
}

enum NotificationType {
  SCRAPE_COMPLETE
  SCRAPE_FAILED
  TRANSLATE_COMPLETE
  TRANSLATE_FAILED
  IMAGE_COMPLETE
  IMAGE_FAILED
  PUBLISH_COMPLETE
  PUBLISH_FAILED
  OUT_OF_STOCK
  PRICE_CHANGE
  SYSTEM
  // 注文関連
  ORDER_RECEIVED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  ORDER_REFUNDED
  ORDER_DISPUTE
}

enum NotificationSeverity {
  INFO
  WARNING
  ERROR
  SUCCESS
}

// ========================================
// 通知チャンネル設定
// ========================================
model NotificationChannel {
  id String @id @default(cuid())

  channel NotificationChannelType
  name    String // チャンネル名（例: "メイン Slack", "緊急用 LINE"）

  // 認証情報
  webhookUrl String? // Slack, Discord
  token      String? // LINE Notify
  email      String? // メールアドレス（EMAIL チャンネル用）

  // SMTP設定（EMAIL チャンネル用、環境変数のオーバーライド）
  smtpHost   String?
  smtpPort   Int?
  smtpUser   String?
  smtpPass   String?
  smtpSecure Boolean @default(true)

  // 通知設定
  enabledTypes NotificationChannelEventType[] // 有効な通知タイプ
  minSeverity  NotificationSeverity @default(INFO) // 最低重要度

  // マーケットプレイスフィルター（Phase 45）
  // 空配列 = 全マーケットプレイスの通知を受信
  // 特定のマーケットプレイスのみ = そのマーケットの通知のみ受信
  marketplaceFilter Marketplace[] @default([])

  // 状態
  isActive     Boolean   @default(true)
  lastUsedAt   DateTime?
  lastError    String?
  errorCount   Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channel, isActive])
  @@map("notification_channels")
}

enum NotificationChannelType {
  SLACK
  DISCORD
  LINE
  EMAIL
}

enum NotificationChannelEventType {
  // ジョブ関連
  JOB_COMPLETE
  JOB_FAILED
  // 注文関連
  ORDER_RECEIVED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_CANCELLED
  ORDER_REFUNDED
  // 在庫関連
  OUT_OF_STOCK
  PRICE_CHANGE
  INVENTORY_LOW
  // 出品関連
  LISTING_PUBLISHED
  LISTING_ERROR
  LISTING_SOLD
  // システム
  DAILY_REPORT
  SYSTEM_ERROR
  EXCHANGE_RATE
}

// ========================================
// 注文管理
// ========================================
model Order {
  id String @id @default(cuid())

  // マーケットプレイス情報
  marketplace        Marketplace
  marketplaceOrderId String // eBay/Joomの注文ID

  // 購入者情報
  buyerUsername String
  buyerEmail    String?
  buyerName     String?

  // 配送先住所
  shippingAddress Json // { street, city, state, postalCode, country }

  // 金額情報
  subtotal     Float // 商品小計
  shippingCost Float // 送料
  tax          Float @default(0) // 税金
  total        Float // 合計金額
  currency     String @default("USD")

  // マーケット手数料
  marketplaceFee Float @default(0)
  paymentFee     Float @default(0)

  // ステータス
  status        OrderStatus     @default(PENDING)
  paymentStatus PaymentStatus   @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)

  // 追跡情報
  trackingNumber  String?
  trackingCarrier String?
  shippedAt       DateTime?

  // 生データ（デバッグ・参照用）
  rawData Json @default("{}")

  // タイムスタンプ
  orderedAt DateTime // マーケットプレイスでの注文日時
  paidAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 関連
  sales Sale[]

  @@unique([marketplace, marketplaceOrderId])
  @@index([status])
  @@index([marketplace, orderedAt])
  @@index([buyerUsername])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  DISPUTE
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  RETURNED
}

// ========================================
// 売上明細
// ========================================
model Sale {
  id String @id @default(cuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id])
  productId String?

  // 商品情報
  sku          String
  title        String
  quantity     Int    @default(1)
  unitPrice    Float
  totalPrice   Float

  // 利益計算
  costPrice    Float? // 仕入価格（円）
  profitJpy    Float? // 利益（円）
  profitRate   Float? // 利益率（%）

  // マーケットプレイス商品ID
  marketplaceItemId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([listingId])
  @@index([productId])
  @@index([sku])
  @@map("sales")
}

// ========================================
// Webhookイベント（履歴・デバッグ用）
// ========================================
model WebhookEvent {
  id String @id @default(cuid())

  // ソース情報
  provider  String // EBAY, JOOM
  eventType String // ORDER_CREATED, PAYMENT_COMPLETE, etc.

  // ペイロード
  payload       Json
  headers       Json @default("{}")
  signature     String?

  // 処理状態（Phase 15強化）
  status           WebhookEventStatus @default(PENDING)
  processedAt      DateTime?
  errorMessage     String?            @db.Text
  retryCount       Int                @default(0)
  maxRetries       Int                @default(5)
  lastAttemptedAt  DateTime?
  nextRetryAt      DateTime?

  // 関連
  orderId   String?
  listingId String?

  // 生成されたメッセージ
  customerMessages CustomerMessage[]

  createdAt DateTime @default(now())

  @@index([provider, eventType])
  @@index([status])
  @@index([status, nextRetryAt])
  @@index([createdAt])
  @@map("webhook_events")
}

enum WebhookEventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  FATAL      // リトライ上限到達または回復不能エラー
  IGNORED
}

// ========================================
// アラートルール（Phase 26）
// ========================================
model AlertRule {
  id                 String   @id @default(cuid())
  name               String
  eventType          String
  conditions         Json     @default("[]")
  severity           String   @default("info")
  channels           String[]
  cooldownMinutes    Int      @default(30)
  batchWindowMinutes Int      @default(5)
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([eventType])
  @@index([isActive])
  @@map("alert_rules")
}

// ========================================
// アラートログ（Phase 26）
// ========================================
model AlertLog {
  id        String    @id @default(cuid())
  ruleId    String?
  eventType String
  severity  String
  title     String
  message   String    @db.Text
  metadata  Json?
  channels  String[]
  status    String    @default("pending")
  batchId   String?
  sentAt    DateTime?
  errorMsg  String?
  createdAt DateTime  @default(now())

  @@index([eventType, createdAt])
  @@index([status])
  @@index([batchId])
  @@map("alert_logs")
}

// ========================================
// スケジュールレポート（Phase 32）
// ========================================
model ScheduledReport {
  id        String @id @default(cuid())
  name      String
  reportType String // 'daily' | 'weekly' | 'monthly' | 'custom'

  // スケジュール設定
  cronExpression String           // cron式（例: "0 9 * * *" = 毎日9時）
  timezone       String @default("Asia/Tokyo")
  isActive       Boolean @default(true)

  // レポート設定
  format        String @default("markdown") // 'json' | 'markdown' | 'csv'
  includeCharts Boolean @default(false)
  customQuery   Json?  // カスタムフィルター条件

  // 配信設定
  deliveryChannels String[] // チャンネルID or 'email:xxx@example.com'
  emailRecipients  String[] // メールアドレス
  emailSubject     String?

  // 実行履歴
  lastRunAt      DateTime?
  lastRunStatus  String?   // 'success' | 'failed'
  lastRunError   String?
  nextRunAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, nextRunAt])
  @@index([reportType])
  @@map("scheduled_reports")
}

// スケジュールレポート実行ログ
model ScheduledReportLog {
  id        String   @id @default(cuid())
  reportId  String
  status    String   // 'running' | 'success' | 'failed'
  startedAt DateTime @default(now())
  endedAt   DateTime?
  duration  Int?     // 実行時間（ミリ秒）
  error     String?
  metadata  Json?    // 結果サマリーなど

  @@index([reportId, startedAt])
  @@map("scheduled_report_logs")
}

// ========================================
// 価格履歴（Phase 28）
// ========================================
model PriceHistory {
  id         String   @id @default(cuid())
  listingId  String
  price      Float
  currency   String   @default("USD")
  source     String   // 'manual' | 'rule' | 'ai' | 'competitor' | 'initial'
  metadata   Json?    // 追加情報（変更理由など）
  recordedAt DateTime @default(now())

  @@index([listingId, recordedAt])
  @@index([recordedAt])
  @@map("price_histories")
}

// ========================================
// 競合価格ログ（Phase 28）
// ========================================
model CompetitorPriceLog {
  id                   String   @id @default(cuid())
  competitorIdentifier String   // 競合商品識別子（URL or ID）
  listingId            String?  // 関連する自社出品
  productId            String?  // 関連する自社商品
  marketplace          String   // 競合のマーケットプレイス
  price                Float
  currency             String   @default("USD")
  title                String?  // 競合商品タイトル
  url                  String?  // 競合商品URL
  metadata             Json?    // 追加データ
  recordedAt           DateTime @default(now())

  // Phase 29: 拡張フィールド
  conditionRank    String?  // コンディションランク (A/B/C/D/unknown)
  matchConfidence  Float?   // マッチング確度 (0-1)
  isVerified       Boolean  @default(false) // 人間による検証済み
  verifiedBy       String?  // 検証者
  verifiedAt       DateTime? // 検証日時
  sellerRating     Float?   // 出品者評価
  stockStatus      String?  // 在庫状態 (in_stock/low_stock/out_of_stock)
  shippingCost     Float?   // 送料
  priceChange      Float?   // 前回からの価格変動
  priceChangePercent Float? // 前回からの価格変動率

  // トラッカー参照
  trackerId        String?
  tracker          CompetitorTracker? @relation(fields: [trackerId], references: [id])

  @@index([listingId, recordedAt])
  @@index([productId, recordedAt])
  @@index([competitorIdentifier, recordedAt])
  @@index([recordedAt])
  @@index([trackerId])
  @@index([isVerified])
  @@map("competitor_price_logs")
}

// ========================================
// 競合トラッキング設定（Phase 29）
// ========================================
model CompetitorTracker {
  id                   String   @id @default(cuid())
  listingId            String?  // 関連する自社出品
  productId            String?  // 関連する自社商品
  competitorIdentifier String   // 競合商品識別子
  marketplace          String   // 競合のマーケットプレイス
  url                  String   // 競合商品URL
  title                String?  // 競合商品タイトル

  // マッチング情報
  matchMethod          String   @default("manual") // manual/keyword/barcode/ai
  matchConfidence      Float    @default(1.0) // マッチング確度
  isVerified           Boolean  @default(false) // 人間による検証済み
  verifiedBy           String?
  verifiedAt           DateTime?

  // トラッキング設定
  isActive             Boolean  @default(true)
  checkInterval        Int      @default(360) // チェック間隔（分）
  alertOnPriceDrop     Boolean  @default(true)
  alertOnPriceRise     Boolean  @default(false)
  alertThresholdPercent Float   @default(5.0) // アラート閾値（%）
  autoAdjustPrice      Boolean  @default(false) // 自動価格調整

  // 最終チェック情報
  lastPrice            Float?
  lastCheckedAt        DateTime?
  lastError            String?
  consecutiveErrors    Int      @default(0)

  // タイムスタンプ
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // リレーション
  priceLogs            CompetitorPriceLog[]

  @@unique([listingId, competitorIdentifier])
  @@index([listingId])
  @@index([productId])
  @@index([isActive])
  @@index([lastCheckedAt])
  @@map("competitor_trackers")
}

// ========================================
// 競合アラート（Phase 29）
// ========================================
model CompetitorAlert {
  id               String   @id @default(cuid())
  trackerId        String
  listingId        String?
  productId        String?

  // アラート内容
  alertType        String   // price_drop/price_rise/out_of_stock/new_competitor
  severity         String   @default("medium") // low/medium/high/critical
  title            String
  message          String   @db.Text

  // 価格情報
  ourPrice         Float?
  competitorPrice  Float?
  priceDiff        Float?
  priceDiffPercent Float?

  // ステータス
  status           String   @default("pending") // pending/acknowledged/resolved/dismissed
  acknowledgedBy   String?
  acknowledgedAt   DateTime?
  resolvedAt       DateTime?

  // メタデータ
  metadata         Json?
  createdAt        DateTime @default(now())

  @@index([listingId])
  @@index([productId])
  @@index([status])
  @@index([alertType])
  @@index([createdAt])
  @@map("competitor_alerts")
}

// ========================================
// 価格推奨（Phase 28）
// ========================================
model PriceRecommendation {
  id               String   @id @default(cuid())
  listingId        String
  productId        String?

  // 価格情報
  currentPrice     Float
  recommendedPrice Float
  minPrice         Float?   // ルールによる下限
  maxPrice         Float?   // ルールによる上限

  // 推奨の詳細
  confidence       Float    @default(0.5) // 0-1 信頼度
  reason           Json     // 推奨根拠（JSON）
  impact           Json?    // 影響試算（JSON）
  ruleId           String?  // 適用されたルールID

  // ステータス
  status           PriceRecommendationStatus @default(PENDING)
  expiresAt        DateTime

  // 処理履歴
  approvedBy       String?  // 承認者
  approvedAt       DateTime?
  appliedAt        DateTime?
  rejectedReason   String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([listingId, status])
  @@index([status, expiresAt])
  @@index([createdAt])
  @@map("price_recommendations")
}

enum PriceRecommendationStatus {
  PENDING    // 承認待ち
  APPROVED   // 承認済み（適用待ち）
  REJECTED   // 却下
  APPLIED    // 適用済み
  EXPIRED    // 期限切れ
  CANCELLED  // キャンセル
}

// ========================================
// 価格ルール（Phase 28）
// ========================================
model PricingRule {
  id          String   @id @default(cuid())
  name        String
  description String?

  // ルールタイプ
  type        PricingRuleType

  // ルール定義
  conditions  Json     // 適用条件（JSON配列）
  actions     Json     // アクション定義（JSON配列）

  // 適用範囲
  marketplace String?  // null = 全マーケットプレイス
  category    String?  // null = 全カテゴリ

  // 優先度と状態
  priority    Int      @default(0) // 高いほど優先
  isActive    Boolean  @default(true)

  // 安全設定
  safetyConfig Json?   // サーキットブレーカー設定

  // 統計
  appliedCount Int     @default(0)
  lastAppliedAt DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type, isActive])
  @@index([priority])
  @@map("pricing_rules")
}

enum PricingRuleType {
  COMPETITOR_FOLLOW  // 競合追従
  MIN_MARGIN         // 最低利益率維持
  MAX_DISCOUNT       // 最大値下げ制限
  DEMAND_BASED       // 需要ベース
  TIME_BASED         // 時間ベース（滞留日数など）
  CUSTOM             // カスタム
}

// ========================================
// 価格変更ログ（Phase 28）
// ========================================
model PriceChangeLog {
  id               String   @id @default(cuid())
  listingId        String
  recommendationId String?

  // 価格変更
  oldPrice         Float
  newPrice         Float
  currency         String   @default("USD")
  changePercent    Float    // 変更率（%）

  // 変更理由
  source           String   // 'manual' | 'rule' | 'ai' | 'auto'
  ruleId           String?
  reason           String?

  // プラットフォーム更新
  platformUpdated  Boolean  @default(false)
  platformError    String?

  createdAt        DateTime @default(now())

  @@index([listingId, createdAt])
  @@index([source, createdAt])
  @@map("price_change_logs")
}

// ========================================
// マーケットプレイス同期設定（Phase 44-B）
// ========================================
model MarketplaceSyncSetting {
  id             String    @id @default(cuid())
  marketplace    String    // 'JOOM' | 'EBAY'
  syncType       String    // 'INVENTORY' | 'ORDER' | 'PRICE'
  cronExpression String    // cron式
  isEnabled      Boolean   @default(true)
  lastRunAt      DateTime?
  nextRunAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([marketplace, syncType])
  @@index([isEnabled])
  @@map("marketplace_sync_settings")
}

// ========================================
// 在庫履歴（Phase 41）
// ========================================
model InventoryLog {
  id          String   @id @default(cuid())
  productId   String
  listingId   String?

  // 在庫・価格情報
  price       Int      // 仕入価格（円）
  stock       Int      @default(1) // 在庫数
  isAvailable Boolean  @default(true)

  // 変動検知
  priceChanged   Boolean @default(false)
  stockChanged   Boolean @default(false)
  previousPrice  Int?
  previousStock  Int?

  // メタデータ
  sourceUrl   String?
  checkedAt   DateTime @default(now())
  metadata    Json     @default("{}")

  @@index([productId, checkedAt])
  @@index([checkedAt])
  @@map("inventory_logs")
}

// ========================================
// 自動化判定用ログ（Phase 41）
// ========================================
model ShadowLog {
  id        String   @id @default(cuid())

  // サービス・操作
  service   String   // 'profit-guard' | 'order-processor' | 'inventory-sync'
  operation String   // 'check' | 'process' | 'decide'

  // 入力・出力
  input     Json     // 入力データ
  output    Json     // 出力データ（判定結果など）

  // 判定結果
  decision      String?  // 'approve' | 'reject' | 'hold'
  decisionReason String?
  isDryRun      Boolean  @default(true)

  // パフォーマンス
  durationMs    Int?

  createdAt DateTime @default(now())

  @@index([service, createdAt])
  @@index([decision, createdAt])
  @@map("shadow_logs")
}

// ========================================
// 利益率閾値設定（Phase 41）
// ========================================
model ProfitThreshold {
  id          String   @id @default(cuid())

  marketplace String   // 'JOOM' | 'EBAY' | 'ALL'
  category    String?  // カテゴリ（nullはデフォルト）

  // 閾値
  minProfitRate     Float @default(10)  // 最低利益率 (%)
  minProfitAmount   Int   @default(500) // 最低利益額（円）
  alertProfitRate   Float @default(15)  // アラート閾値 (%)

  // 設定
  isActive    Boolean  @default(true)
  isDryRun    Boolean  @default(true) // Dry Runモード

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([marketplace, category])
  @@map("profit_thresholds")
}

// ========================================
// 通知イベント（Phase 45+）
// ========================================
model NotificationEvent {
  id          String   @id @default(cuid())
  type        String   // ORDER_RECEIVED, PROFIT_ALERT, STOCK_OUT, etc.
  channel     String   // SLACK, DISCORD, WEBHOOK
  status      String   @default("PENDING") // PENDING, SENT, FAILED, ACTION_TAKEN
  payload     Json     // 通知内容
  referenceId String?  // 注文ID、商品IDなど
  referenceType String? // ORDER, PRODUCT, LISTING
  actionTaken String?  // 実行されたアクション
  actionBy    String?  // アクション実行者
  sentAt      DateTime?
  error       String?
  retryCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type, status])
  @@index([referenceId, referenceType])
  @@index([createdAt])
  @@map("notification_events")
}

// ========================================
// メッセージテンプレート（Phase 16）
// ========================================
model MessageTemplate {
  id          String   @id @default(cuid())

  // テンプレート識別
  name        String   @unique // テンプレート名（例: order_confirmation_en）
  description String?  // 説明

  // イベントトリガー
  triggerEvent MessageTriggerEvent // ORDER_CONFIRMED, SHIPPED, DELIVERED, etc.
  marketplace  Marketplace?        // null = 全マーケットプレイス

  // テンプレート内容
  language    String   @default("en") // en, ja, etc.
  subject     String   // 件名テンプレート
  body        String   @db.Text // 本文テンプレート（プレースホルダー対応）
  bodyHtml    String?  @db.Text // HTML版本文（オプション）

  // プレースホルダー定義
  // {{buyer_name}}, {{order_id}}, {{tracking_number}}, etc.
  placeholders String[] // 使用可能なプレースホルダー一覧

  // 設定
  isActive    Boolean  @default(true)
  priority    Int      @default(0) // 同一イベントで複数テンプレートがある場合の優先度

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  customerMessages CustomerMessage[]

  @@unique([triggerEvent, marketplace, language])
  @@index([triggerEvent, isActive])
  @@map("message_templates")
}

enum MessageTriggerEvent {
  ORDER_CONFIRMED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  ORDER_REFUNDED
  TRACKING_UPDATED
  CUSTOM
}

// ========================================
// 顧客メッセージ（Phase 16）
// ========================================
model CustomerMessage {
  id            String   @id @default(cuid())

  // 関連情報
  orderId       String?
  listingId     String?
  webhookEventId String?
  webhookEvent  WebhookEvent? @relation(fields: [webhookEventId], references: [id])

  templateId    String?
  template      MessageTemplate? @relation(fields: [templateId], references: [id])

  // 宛先情報
  marketplace   Marketplace
  buyerUsername String
  buyerEmail    String?

  // メッセージ内容（レンダリング済み）
  subject       String
  body          String   @db.Text
  bodyHtml      String?  @db.Text

  // 送信状態
  status        MessageStatus @default(PENDING)
  sendingAttempts Int         @default(0)
  maxAttempts   Int           @default(3)
  lastAttemptedAt DateTime?
  sentAt        DateTime?
  errorMessage  String?       @db.Text

  // マーケットプレイス応答
  marketplaceMessageId String? // 送信後のメッセージID
  marketplaceResponse Json?    // APIレスポンス

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([orderId])
  @@index([status])
  @@index([status, lastAttemptedAt])
  @@index([marketplace, buyerUsername])
  @@map("customer_messages")
}

enum MessageStatus {
  PENDING
  SENDING
  SENT
  FAILED
  FATAL  // リトライ上限到達または回復不能エラー
}

// ========================================
// 在庫アラート（Phase 17）
// ========================================
model InventoryAlert {
  id          String   @id @default(cuid())

  // 関連
  productId   String?
  listingId   String?
  listing     Listing? @relation(fields: [listingId], references: [id])

  // イベント情報
  alertType   InventoryAlertType
  severity    AlertSeverity      @default(MEDIUM)

  // 在庫状態（変動前後）
  previousStock     Int?
  currentStock      Int?
  previousAvailable Boolean?
  currentAvailable  Boolean?

  // 判定理由
  reason            String   @db.Text // 例: "在庫数が0になったため自動停止"
  thresholdUsed     Int?              // 判定に使用した閾値

  // アクション
  actionTaken       InventoryAlertAction?
  actionDetails     Json?             // 詳細情報（遅延時間等）

  // 通知
  notificationSent  Boolean  @default(false)
  notificationId    String?  // 送信した通知のID

  // 抑制情報
  suppressed        Boolean  @default(false) // スパム抑制でスキップ
  suppressReason    String?

  createdAt         DateTime @default(now())

  @@index([productId, createdAt])
  @@index([listingId, createdAt])
  @@index([alertType, createdAt])
  @@index([actionTaken, createdAt])
  @@map("inventory_alerts")
}

enum InventoryAlertType {
  STOCK_OUT           // 在庫切れ
  STOCK_LOW           // 在庫僅少
  STOCK_RECOVERED     // 在庫復活
  LISTING_PAUSED      // リスティング停止
  LISTING_RESUMED     // リスティング再開
  PRICE_CHANGED       // 価格変動
  AVAILABILITY_CHANGED // 販売状態変更
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum InventoryAlertAction {
  PAUSE_LISTING       // リスティング停止
  RESUME_LISTING      // リスティング再開
  SCHEDULE_RESUME     // 遅延再開スケジュール
  NOTIFY_ONLY         // 通知のみ
  NONE                // アクションなし
}

// ========================================
// 売上サマリー（Phase 18）
// ========================================
model SalesSummary {
  id            String   @id @default(cuid())

  // 集計期間
  periodType    SalesPeriodType  // DAILY, WEEKLY, MONTHLY
  periodStart   DateTime
  periodEnd     DateTime

  // フィルター条件
  marketplace   Marketplace?     // null = 全マーケットプレイス
  category      String?          // null = 全カテゴリ

  // 売上サマリー
  orderCount    Int      @default(0)
  itemCount     Int      @default(0)  // 販売数量
  grossRevenue  Float    @default(0)  // 売上総額（USD）
  shippingTotal Float    @default(0)  // 送料総額
  feeTotal      Float    @default(0)  // 手数料総額
  netRevenue    Float    @default(0)  // 純売上

  // 利益サマリー（原価データがある場合）
  costTotal     Float?           // 仕入総額（円）
  profitTotal   Float?           // 利益総額（円）
  profitRate    Float?           // 利益率（%）

  // ベストセラー（JSON）
  topProducts   Json     @default("[]") // [{productId, title, quantity, revenue}]
  topCategories Json     @default("[]") // [{category, quantity, revenue}]

  // メタデータ
  calculatedAt  DateTime @default(now())
  isComplete    Boolean  @default(false) // 集計完了フラグ

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([periodType, periodStart, marketplace, category])
  @@index([periodType, periodStart])
  @@index([marketplace, periodStart])
  @@map("sales_summaries")
}

enum SalesPeriodType {
  DAILY
  WEEKLY
  MONTHLY
}

// ========================================
// Phase 19: データエクスポート
// ========================================

model ExportJob {
  id            String   @id @default(cuid())

  // エクスポート種別
  exportType    ExportType
  format        ExportFormat   @default(CSV)

  // フィルター条件
  filters       Json     @default("{}")  // {startDate, endDate, marketplace, status, etc.}

  // 実行状態
  status        ExportJobStatus @default(PENDING)
  progress      Int      @default(0)     // 0-100
  totalRows     Int?
  processedRows Int      @default(0)

  // ファイル情報
  fileName      String?
  filePath      String?              // S3/ローカルパス
  fileSize      Int?                 // bytes
  downloadUrl   String?              // 署名付きURL
  expiresAt     DateTime?            // ダウンロード期限

  // エラー情報
  errorMessage  String?  @db.Text

  // スケジュール設定（定期エクスポート用）
  isScheduled   Boolean  @default(false)
  cronExpression String?
  nextRunAt     DateTime?

  // メタデータ
  requestedBy   String?              // ユーザーID/APIキー
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([exportType, status])
  @@index([status, createdAt])
  @@index([isScheduled, nextRunAt])
  @@map("export_jobs")
}

enum ExportType {
  ORDERS           // 注文データ
  PRODUCTS         // 商品データ
  LISTINGS         // 出品データ
  SALES_SUMMARY    // 売上サマリー
  INVENTORY        // 在庫データ
  AUDIT_LOG        // 監査ログ
  CUSTOMER_MESSAGES // 顧客メッセージ
}

enum ExportFormat {
  CSV
  EXCEL
  JSON
}

enum ExportJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ========================================
// Phase 20: 監査ログ
// ========================================

model AuditLog {
  id            String   @id @default(cuid())

  // 操作者情報
  actorType     ActorType        // USER, SYSTEM, API, WEBHOOK
  actorId       String?          // ユーザーID or APIキーID
  actorName     String?          // 表示名
  ipAddress     String?

  // 操作対象
  entityType    AuditEntityType  // PRODUCT, LISTING, ORDER, etc.
  entityId      String?          // 対象のID
  entityName    String?          // 対象の名前（検索用）

  // 操作内容
  action        AuditAction      // CREATE, UPDATE, DELETE, etc.
  description   String   @db.Text // 操作の説明

  // 変更内容
  previousValue Json?            // 変更前の値
  newValue      Json?            // 変更後の値
  changedFields String[]         // 変更されたフィールド名

  // メタデータ
  metadata      Json     @default("{}")  // 追加情報（リクエストID、ユーザーエージェント等）
  severity      AuditSeverity @default(INFO)

  createdAt     DateTime @default(now())

  @@index([entityType, entityId])
  @@index([actorType, actorId])
  @@index([action, createdAt])
  @@index([severity, createdAt])
  @@index([createdAt])
  @@map("audit_logs")
}

enum ActorType {
  USER
  SYSTEM
  API
  WEBHOOK
  SCHEDULER
}

enum AuditEntityType {
  PRODUCT
  LISTING
  ORDER
  SALE
  INVENTORY_ALERT
  WEBHOOK_EVENT
  CUSTOMER_MESSAGE
  PRICE_RECOMMENDATION
  EXPORT_JOB
  SETTINGS
  MARKETPLACE_CREDENTIAL
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  PUBLISH
  UNPUBLISH
  PAUSE
  RESUME
  APPROVE
  REJECT
  EXPORT
  IMPORT
  SYNC
  SEND
  LOGIN
  LOGOUT
}

enum AuditSeverity {
  DEBUG
  INFO
  WARNING
  ERROR
  CRITICAL
}

// ========================================
// Phase 21: システム設定管理
// ========================================

model SystemSetting {
  id            String   @id @default(cuid())

  // 設定キー（ユニーク）
  key           String   @unique
  category      SettingCategory  @default(GENERAL)

  // 設定値
  value         String   @db.Text
  valueType     SettingValueType @default(STRING)
  defaultValue  String?  @db.Text

  // メタデータ
  label         String?          // 表示名
  description   String?  @db.Text // 説明
  isSecret      Boolean  @default(false)  // シークレット値（マスク表示）
  isReadOnly    Boolean  @default(false)  // 読み取り専用
  validationRule String?          // バリデーションルール（JSON Schema等）

  // 変更履歴
  version       Int      @default(1)
  lastChangedBy String?
  lastChangedAt DateTime @default(now())

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 設定履歴
  history       SettingHistory[]

  @@index([category])
  @@index([key])
  @@map("system_settings")
}

model SettingHistory {
  id            String   @id @default(cuid())

  settingId     String
  setting       SystemSetting @relation(fields: [settingId], references: [id], onDelete: Cascade)

  // 変更内容
  previousValue String?  @db.Text
  newValue      String   @db.Text
  version       Int

  // 変更者
  changedBy     String?
  changedAt     DateTime @default(now())
  changeReason  String?

  @@index([settingId, changedAt])
  @@map("setting_histories")
}

enum SettingCategory {
  GENERAL        // 一般設定
  SCHEDULER      // スケジューラー設定
  NOTIFICATION   // 通知設定
  MARKETPLACE    // マーケットプレイス設定
  PRICING        // 価格設定
  INVENTORY      // 在庫設定
  EXPORT         // エクスポート設定
  SECURITY       // セキュリティ設定
  INTEGRATION    // 外部連携設定
}

enum SettingValueType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  ARRAY
  SECRET
}

// ========================================
// Phase 22: API使用量・レート制限管理
// ========================================

model ApiKey {
  id            String   @id @default(cuid())

  // キー情報
  name          String           // キー名
  keyHash       String   @unique // ハッシュ化されたAPIキー
  keyPrefix     String           // キーの先頭部分（表示用）

  // 権限
  permissions   String[]         // 許可されたエンドポイント/操作
  rateLimit     Int      @default(1000)  // 1時間あたりのリクエスト上限
  dailyLimit    Int?             // 1日あたりのリクエスト上限

  // ステータス
  isActive      Boolean  @default(true)
  expiresAt     DateTime?

  // メタデータ
  description   String?
  createdBy     String?
  lastUsedAt    DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 使用量記録
  usageLogs     ApiUsageLog[]

  @@index([keyHash])
  @@index([isActive, expiresAt])
  @@map("api_keys")
}

model ApiUsageLog {
  id            String   @id @default(cuid())

  // APIキー（nullの場合は認証なしリクエスト）
  apiKeyId      String?
  apiKey        ApiKey?  @relation(fields: [apiKeyId], references: [id])

  // リクエスト情報
  endpoint      String           // エンドポイントパス
  method        String           // HTTP メソッド
  statusCode    Int              // レスポンスステータス
  responseTime  Int              // レスポンス時間（ミリ秒）

  // クライアント情報
  ipAddress     String?
  userAgent     String?

  // 使用量
  requestSize   Int?             // リクエストサイズ（bytes）
  responseSize  Int?             // レスポンスサイズ（bytes）

  // エラー情報
  errorCode     String?
  errorMessage  String?

  createdAt     DateTime @default(now())

  @@index([apiKeyId, createdAt])
  @@index([endpoint, createdAt])
  @@index([createdAt])
  @@map("api_usage_logs")
}

model RateLimitRecord {
  id            String   @id @default(cuid())

  // 識別子（APIキーID or IPアドレス）
  identifier    String
  identifierType RateLimitIdentifierType

  // カウンター
  windowStart   DateTime         // ウィンドウ開始時刻
  windowSize    Int              // ウィンドウサイズ（秒）
  requestCount  Int      @default(0)

  // 制限情報
  isBlocked     Boolean  @default(false)
  blockedUntil  DateTime?
  blockReason   String?

  updatedAt     DateTime @updatedAt

  @@unique([identifier, windowStart])
  @@index([identifier, windowStart])
  @@index([isBlocked, blockedUntil])
  @@map("rate_limit_records")
}

model ApiUsageSummary {
  id            String   @id @default(cuid())

  // 集計期間
  periodType    UsagePeriodType  // HOURLY, DAILY, MONTHLY
  periodStart   DateTime
  periodEnd     DateTime

  // 対象
  apiKeyId      String?          // null = 全体
  endpoint      String?          // null = 全エンドポイント

  // 統計
  totalRequests Int      @default(0)
  successCount  Int      @default(0)
  errorCount    Int      @default(0)
  avgResponseTime Float?
  maxResponseTime Int?
  totalRequestSize  BigInt?
  totalResponseSize BigInt?

  // 上位エンドポイント
  topEndpoints  Json     @default("[]")

  calculatedAt  DateTime @default(now())

  @@unique([periodType, periodStart, apiKeyId, endpoint])
  @@index([periodType, periodStart])
  @@index([apiKeyId, periodStart])
  @@map("api_usage_summaries")
}

enum RateLimitIdentifierType {
  API_KEY
  IP_ADDRESS
  USER_ID
}

enum UsagePeriodType {
  HOURLY
  DAILY
  MONTHLY
}

// ========================================
// Phase 23: ユーザー管理/RBAC
// ========================================

model User {
  id            String   @id @default(cuid())

  // 認証情報
  email         String   @unique
  passwordHash  String?          // nullの場合はOAuth専用
  emailVerified Boolean  @default(false)
  emailVerifiedAt DateTime?

  // プロフィール
  name          String?
  avatar        String?

  // ステータス
  status        UserStatus @default(ACTIVE)
  lastLoginAt   DateTime?
  lastLoginIp   String?

  // 二要素認証
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  // リレーション
  roles         UserRole[]
  sessions      UserSession[]
  apiKeys       UserApiKey[]
  auditLogs     UserAuditLog[]

  // Phase 33: セキュリティ強化
  securityEvents   SecurityEvent[]
  loginAttempts    LoginAttempt[]
  deviceSessions   DeviceSession[]
  twoFactorAuth    TwoFactorAuth?
  twoFactorChallenges TwoFactorChallenge[]
  passwordHistory  PasswordHistory[]

  // Phase 35: ワークフロー自動化
  createdWorkflows Workflow[]
  createdAutomationRules AutomationRule[]
  approvalActions  ApprovalAction[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@map("users")
}

model Role {
  id            String   @id @default(cuid())

  // ロール情報
  name          String   @unique
  displayName   String
  description   String?

  // 権限
  permissions   Permission[]

  // システムロール（削除不可）
  isSystem      Boolean  @default(false)

  // リレーション
  users         UserRole[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([name])
  @@map("roles")
}

model Permission {
  id            String   @id @default(cuid())

  // 権限情報
  resource      String           // 対象リソース（products, orders, etc.）
  action        PermissionAction // 操作種別

  // リレーション
  roleId        String
  role          Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())

  @@unique([roleId, resource, action])
  @@index([resource, action])
  @@map("permissions")
}

model UserRole {
  id            String   @id @default(cuid())

  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  roleId        String
  role          Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  // 付与情報
  grantedBy     String?
  grantedAt     DateTime @default(now())
  expiresAt     DateTime?        // 期限付きロール

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model UserSession {
  id            String   @id @default(cuid())

  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // セッション情報
  token         String   @unique
  refreshToken  String?  @unique
  userAgent     String?
  ipAddress     String?

  // 有効期限
  expiresAt     DateTime
  refreshExpiresAt DateTime?

  // ステータス
  isActive      Boolean  @default(true)
  revokedAt     DateTime?
  revokedReason String?

  createdAt     DateTime @default(now())
  lastUsedAt    DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([isActive, expiresAt])
  @@map("user_sessions")
}

model UserApiKey {
  id            String   @id @default(cuid())

  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // キー情報
  name          String
  keyHash       String   @unique
  keyPrefix     String

  // 権限（ユーザーの権限をオーバーライド）
  scopes        String[]         // 許可されたスコープ
  permissions   Json     @default("[]") // カスタム権限

  // ステータス
  isActive      Boolean  @default(true)
  expiresAt     DateTime?
  lastUsedAt    DateTime?

  // 使用制限
  rateLimit     Int      @default(1000)
  dailyLimit    Int?

  // Phase 33: セキュリティ強化
  policy        ApiKeyPolicy?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([keyHash])
  @@map("user_api_keys")
}

model UserAuditLog {
  id            String   @id @default(cuid())

  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 操作情報
  action        String           // login, logout, password_change, etc.
  description   String   @db.Text

  // コンテキスト
  ipAddress     String?
  userAgent     String?
  metadata      Json     @default("{}")

  // 結果
  success       Boolean  @default(true)
  errorMessage  String?

  createdAt     DateTime @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@map("user_audit_logs")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  MANAGE      // 全権限
  EXPORT
  IMPORT
  APPROVE
  PUBLISH
}

// ========================================
// Phase 24: Webhook管理の強化
// ========================================

model WebhookEndpoint {
  id            String   @id @default(cuid())

  // エンドポイント情報
  name          String
  url           String
  description   String?

  // 認証設定
  authType      WebhookAuthType @default(NONE)
  authConfig    Json     @default("{}")  // {secret, header, token, etc.}

  // 署名設定
  signatureEnabled Boolean @default(true)
  signatureSecret  String?         // HMAC署名用シークレット
  signatureHeader  String  @default("X-Webhook-Signature")
  signatureAlgorithm String @default("sha256")

  // イベント設定
  events        WebhookEventType[]
  filters       Json     @default("{}")  // イベントフィルター条件

  // リトライ設定
  retryEnabled  Boolean  @default(true)
  maxRetries    Int      @default(5)
  retryDelayMs  Int      @default(1000)
  retryBackoffMultiplier Float @default(2.0)

  // タイムアウト
  timeoutMs     Int      @default(30000)

  // ステータス
  isActive      Boolean  @default(true)
  lastDeliveryAt DateTime?
  lastDeliveryStatus String?
  consecutiveFailures Int @default(0)
  disabledAt    DateTime?
  disabledReason String?

  // 統計
  totalDeliveries Int     @default(0)
  successfulDeliveries Int @default(0)
  failedDeliveries Int    @default(0)

  // リレーション
  deliveries    WebhookDelivery[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isActive])
  @@index([events])
  @@map("webhook_endpoints")
}

model WebhookDelivery {
  id            String   @id @default(cuid())

  endpointId    String
  endpoint      WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  // イベント情報
  eventType     String
  eventId       String?          // 元イベントのID
  payload       Json

  // リクエスト情報
  requestHeaders Json    @default("{}")
  requestBody   String   @db.Text

  // レスポンス情報
  responseStatus Int?
  responseHeaders Json?
  responseBody  String?  @db.Text
  responseTimeMs Int?

  // 配信状態
  status        WebhookDeliveryStatus @default(PENDING)
  attemptCount  Int      @default(0)
  maxAttempts   Int      @default(5)
  nextRetryAt   DateTime?

  // エラー情報
  errorType     String?          // timeout, connection_error, http_error, etc.
  errorMessage  String?  @db.Text

  // 署名
  signature     String?

  deliveredAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([endpointId, createdAt])
  @@index([status, nextRetryAt])
  @@index([eventType, createdAt])
  @@map("webhook_deliveries")
}

model WebhookSecret {
  id            String   @id @default(cuid())

  // プロバイダー情報
  provider      String   @unique  // EBAY, JOOM, STRIPE, etc.

  // シークレット情報
  secret        String           // 署名検証用シークレット
  algorithm     String   @default("sha256")
  headerName    String   @default("X-Webhook-Signature")

  // 検証設定
  verifyTimestamp Boolean @default(true)
  timestampToleranceSeconds Int @default(300)

  // ステータス
  isActive      Boolean  @default(true)
  lastVerifiedAt DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([provider])
  @@map("webhook_secrets")
}

enum WebhookAuthType {
  NONE
  BASIC
  BEARER
  API_KEY
  HMAC
  CUSTOM
}

enum WebhookEventType {
  // 注文関連
  ORDER_CREATED
  ORDER_UPDATED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  ORDER_REFUNDED
  // 商品関連
  PRODUCT_CREATED
  PRODUCT_UPDATED
  PRODUCT_DELETED
  // 出品関連
  LISTING_PUBLISHED
  LISTING_UPDATED
  LISTING_ENDED
  LISTING_SOLD
  // 在庫関連
  INVENTORY_LOW
  INVENTORY_OUT
  INVENTORY_UPDATED
  // 価格関連
  PRICE_CHANGED
  PRICE_RECOMMENDATION
  // システム関連
  SYSTEM_ERROR
  SYSTEM_ALERT
}

enum WebhookDeliveryStatus {
  PENDING
  SENDING
  DELIVERED
  FAILED
  RETRYING
  EXHAUSTED    // リトライ上限到達
}

// ========================================
// Phase 25: バックアップ/リストア
// ========================================

model Backup {
  id            String   @id @default(cuid())

  // バックアップ情報
  name          String
  description   String?
  backupType    BackupType       @default(FULL)

  // 含まれるデータ
  includeProducts   Boolean @default(true)
  includeListings   Boolean @default(true)
  includeOrders     Boolean @default(true)
  includeSettings   Boolean @default(true)
  includeTemplates  Boolean @default(true)
  includeCredentials Boolean @default(false)  // 認証情報は暗号化

  // ファイル情報
  fileName      String?
  filePath      String?          // S3/ローカルパス
  fileSize      BigInt?
  checksum      String?          // SHA256

  // 暗号化
  isEncrypted   Boolean  @default(true)
  encryptionKey String?          // 暗号化キーのヒント（実キーは別管理）

  // 統計
  productCount  Int?
  listingCount  Int?
  orderCount    Int?
  settingCount  Int?

  // ステータス
  status        BackupStatus @default(PENDING)
  progress      Int          @default(0)
  errorMessage  String?      @db.Text

  // 実行情報
  createdBy     String?
  startedAt     DateTime?
  completedAt   DateTime?

  // スケジュール
  isScheduled   Boolean  @default(false)
  scheduleId    String?

  // 保持期間
  expiresAt     DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([backupType, status])
  @@index([createdAt])
  @@index([isScheduled])
  @@map("backups")
}

model BackupSchedule {
  id            String   @id @default(cuid())

  // スケジュール情報
  name          String
  description   String?
  cronExpression String         // cron式
  timezone      String   @default("Asia/Tokyo")

  // バックアップ設定
  backupType    BackupType @default(INCREMENTAL)
  includeProducts   Boolean @default(true)
  includeListings   Boolean @default(true)
  includeOrders     Boolean @default(true)
  includeSettings   Boolean @default(true)
  includeTemplates  Boolean @default(true)
  includeCredentials Boolean @default(false)

  // 暗号化設定
  isEncrypted   Boolean  @default(true)

  // 保持設定
  retentionDays Int      @default(30)
  maxBackups    Int      @default(10)

  // ステータス
  isActive      Boolean  @default(true)
  lastRunAt     DateTime?
  lastRunStatus String?
  nextRunAt     DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isActive, nextRunAt])
  @@map("backup_schedules")
}

model RestoreJob {
  id            String   @id @default(cuid())

  // リストア元
  backupId      String?          // 既存バックアップから
  uploadedFile  String?          // アップロードファイルから

  // リストア設定
  restoreType   RestoreType @default(FULL)
  restoreProducts   Boolean @default(true)
  restoreListings   Boolean @default(true)
  restoreOrders     Boolean @default(false)  // 注文は慎重に
  restoreSettings   Boolean @default(true)
  restoreTemplates  Boolean @default(true)

  // 競合解決
  conflictStrategy ConflictStrategy @default(SKIP)

  // ステータス
  status        RestoreStatus @default(PENDING)
  progress      Int           @default(0)

  // 統計
  totalItems    Int?
  processedItems Int          @default(0)
  skippedItems  Int           @default(0)
  failedItems   Int           @default(0)

  // エラー情報
  errorMessage  String?       @db.Text
  errorDetails  Json          @default("[]")

  // 実行情報
  createdBy     String?
  startedAt     DateTime?
  completedAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("restore_jobs")
}

enum BackupType {
  FULL          // 完全バックアップ
  INCREMENTAL   // 増分バックアップ
  DIFFERENTIAL  // 差分バックアップ
  SETTINGS_ONLY // 設定のみ
}

enum BackupStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
  EXPIRED
}

enum RestoreType {
  FULL          // 完全リストア
  SELECTIVE     // 選択的リストア
  SETTINGS_ONLY // 設定のみ
}

enum RestoreStatus {
  PENDING
  VALIDATING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
  ROLLED_BACK
}

enum ConflictStrategy {
  SKIP          // 既存をスキップ
  OVERWRITE     // 上書き
  MERGE         // マージ（可能な場合）
  RENAME        // リネームして両方保持
}

// ========================================
// Phase 26: ダッシュボードウィジェット
// ========================================

model DashboardWidget {
  id            String   @id @default(cuid())

  // ウィジェット情報
  name          String
  description   String?
  widgetType    WidgetType

  // 表示設定
  title         String
  subtitle      String?
  icon          String?          // アイコン名
  color         String?          // テーマカラー

  // データ設定
  dataSource    String           // データソース識別子
  query         Json             @default("{}")  // クエリ条件
  aggregation   String?          // 集計方法
  timeRange     String?          // 時間範囲（last_24h, last_7d, etc.）

  // 表示オプション
  displayOptions Json            @default("{}")  // グラフオプション等
  refreshInterval Int            @default(300)   // 更新間隔（秒）

  // 閾値設定（アラート用）
  thresholds    Json             @default("[]")  // [{value, color, label}]

  // 権限
  requiredPermission String?     // 必要な権限

  // システムウィジェット
  isSystem      Boolean  @default(false)
  isActive      Boolean  @default(true)

  // リレーション
  dashboardItems DashboardItem[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([widgetType])
  @@index([isActive])
  @@map("dashboard_widgets")
}

model Dashboard {
  id            String   @id @default(cuid())

  // ダッシュボード情報
  name          String
  description   String?
  slug          String   @unique  // URLスラッグ

  // 所有者
  userId        String?          // null = システムダッシュボード
  isDefault     Boolean  @default(false)
  isPublic      Boolean  @default(false)

  // レイアウト設定
  layout        Json             @default("[]")  // グリッドレイアウト
  columns       Int      @default(12)

  // テーマ
  theme         String   @default("light")

  // リレーション
  items         DashboardItem[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([slug])
  @@index([isDefault])
  @@map("dashboards")
}

model DashboardItem {
  id            String   @id @default(cuid())

  dashboardId   String
  dashboard     Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  widgetId      String
  widget        DashboardWidget @relation(fields: [widgetId], references: [id], onDelete: Cascade)

  // グリッド位置
  x             Int      @default(0)
  y             Int      @default(0)
  width         Int      @default(4)
  height        Int      @default(3)

  // カスタム設定（ウィジェットデフォルトのオーバーライド）
  customTitle   String?
  customOptions Json     @default("{}")

  // 表示順
  order         Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([dashboardId, widgetId])
  @@index([dashboardId])
  @@map("dashboard_items")
}

model WidgetData {
  id            String   @id @default(cuid())

  // データ識別
  widgetType    WidgetType
  dataKey       String           // キャッシュキー

  // データ
  value         Json
  metadata      Json     @default("{}")

  // キャッシュ情報
  calculatedAt  DateTime @default(now())
  expiresAt     DateTime

  @@unique([widgetType, dataKey])
  @@index([expiresAt])
  @@map("widget_data")
}

model KpiSnapshot {
  id            String   @id @default(cuid())

  // スナップショット期間
  periodType    KpiPeriodType
  periodStart   DateTime
  periodEnd     DateTime

  // KPI値
  kpiType       KpiType
  value         Float
  previousValue Float?           // 前期比較用
  changePercent Float?

  // メタデータ
  breakdown     Json     @default("{}")  // 内訳データ
  metadata      Json     @default("{}")

  calculatedAt  DateTime @default(now())

  @@unique([periodType, periodStart, kpiType])
  @@index([kpiType, periodStart])
  @@map("kpi_snapshots")
}

enum WidgetType {
  // 数値系
  METRIC        // 単一指標
  COUNTER       // カウンター
  GAUGE         // ゲージ
  PROGRESS      // 進捗バー

  // グラフ系
  LINE_CHART    // 折れ線グラフ
  BAR_CHART     // 棒グラフ
  PIE_CHART     // 円グラフ
  AREA_CHART    // エリアチャート

  // リスト系
  TABLE         // テーブル
  LIST          // リスト
  LEADERBOARD   // ランキング

  // その他
  MAP           // 地図
  HEATMAP       // ヒートマップ
  TIMELINE      // タイムライン
  STATUS        // ステータス表示
  ALERT         // アラートリスト
}

enum KpiPeriodType {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum KpiType {
  // 売上系
  TOTAL_REVENUE
  GROSS_PROFIT
  NET_PROFIT
  PROFIT_MARGIN
  AVERAGE_ORDER_VALUE

  // 注文系
  ORDER_COUNT
  ITEM_COUNT
  CONVERSION_RATE
  RETURN_RATE

  // 在庫系
  ACTIVE_LISTINGS
  OUT_OF_STOCK_COUNT
  INVENTORY_VALUE

  // パフォーマンス系
  API_REQUESTS
  ERROR_RATE
  RESPONSE_TIME

  // 顧客系
  NEW_CUSTOMERS
  REPEAT_CUSTOMERS
  CUSTOMER_SATISFACTION
}

// ========================================
// Phase 27: 通知チャンネル拡張
// ========================================

model NotificationDispatch {
  id            String   @id @default(cuid())

  // 通知チャンネル
  channelId     String
  channelType   NotificationChannelType

  // 通知内容
  eventType     String           // 通知イベント種別
  title         String
  message       String   @db.Text
  severity      NotificationSeverity @default(INFO)

  // ペイロード
  payload       Json     @default("{}")
  formattedPayload Json?          // チャンネル別フォーマット済み

  // 送信状態
  status        NotificationDispatchStatus @default(PENDING)
  attemptCount  Int      @default(0)
  maxAttempts   Int      @default(3)
  nextRetryAt   DateTime?

  // レスポンス
  providerResponse Json?
  providerMessageId String?

  // エラー情報
  errorCode     String?
  errorMessage  String?  @db.Text

  // タイムスタンプ
  scheduledAt   DateTime?        // 予約送信
  sentAt        DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([channelId, status])
  @@index([status, nextRetryAt])
  @@index([eventType, createdAt])
  @@map("notification_dispatches")
}

model NotificationTemplate {
  id            String   @id @default(cuid())

  // テンプレート情報
  name          String   @unique
  description   String?
  eventType     String           // トリガーイベント

  // チャンネル別テンプレート
  slackTemplate   Json?          // Slack Block Kit形式
  discordTemplate Json?          // Discord Embed形式
  lineTemplate    Json?          // LINE Flex Message形式
  emailTemplate   Json?          // HTML/テキスト

  // プレースホルダー
  placeholders  String[]         // 使用可能な変数

  // 設定
  isActive      Boolean  @default(true)
  isSystem      Boolean  @default(false)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([eventType])
  @@map("notification_templates")
}

model NotificationPreference {
  id            String   @id @default(cuid())

  // ユーザー/グループ
  userId        String?
  groupId       String?

  // 通知設定
  eventType     String
  channels      String[]         // 有効なチャンネルID
  isEnabled     Boolean  @default(true)

  // 頻度設定
  frequency     NotificationFrequency @default(IMMEDIATE)
  digestHour    Int?             // ダイジェスト送信時刻（0-23）
  quietHoursStart Int?           // 通知停止開始時刻
  quietHoursEnd   Int?           // 通知停止終了時刻

  // フィルター
  minSeverity   NotificationSeverity @default(INFO)
  filters       Json     @default("{}")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, eventType])
  @@index([userId])
  @@index([eventType])
  @@map("notification_preferences")
}

enum NotificationDispatchStatus {
  PENDING
  SCHEDULED
  SENDING
  SENT
  FAILED
  CANCELLED
}

enum NotificationFrequency {
  IMMEDIATE     // 即時
  HOURLY        // 1時間ごとのダイジェスト
  DAILY         // 日次ダイジェスト
  WEEKLY        // 週次ダイジェスト
}

// ========================================
// Phase 28: レポート機能の強化
// ========================================

model Report {
  id            String   @id @default(cuid())

  // レポート情報
  name          String
  description   String?
  reportType    ReportType

  // テンプレート
  templateId    String?
  template      ReportTemplate? @relation(fields: [templateId], references: [id])

  // パラメータ
  parameters    Json     @default("{}")  // {startDate, endDate, filters, etc.}
  timeRange     String?          // last_7d, last_30d, custom

  // 出力設定
  format        ReportFormat @default(PDF)
  orientation   String   @default("portrait")  // portrait, landscape
  paperSize     String   @default("A4")

  // ファイル情報
  fileName      String?
  filePath      String?
  fileSize      Int?
  mimeType      String?

  // ステータス
  status        ReportStatus @default(PENDING)
  progress      Int      @default(0)
  errorMessage  String?  @db.Text

  // 実行情報
  generatedBy   String?
  startedAt     DateTime?
  completedAt   DateTime?

  // 有効期限
  expiresAt     DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([reportType, status])
  @@index([generatedBy, createdAt])
  @@map("reports")
}

model ReportTemplate {
  id            String   @id @default(cuid())

  // テンプレート情報
  name          String   @unique
  description   String?
  reportType    ReportType

  // レイアウト設定
  layout        Json     @default("{}")  // ページレイアウト
  sections      Json     @default("[]")  // セクション定義
  header        Json?            // ヘッダー設定
  footer        Json?            // フッター設定

  // スタイル
  theme         String   @default("default")
  customStyles  Json     @default("{}")
  logoUrl       String?

  // データソース
  dataSources   Json     @default("[]")  // クエリ定義
  charts        Json     @default("[]")  // グラフ設定

  // 設定
  isActive      Boolean  @default(true)
  isSystem      Boolean  @default(false)

  // リレーション
  reports       Report[]
  schedules     ReportScheduleConfig[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([reportType])
  @@map("report_templates")
}

model ReportScheduleConfig {
  id            String   @id @default(cuid())

  // スケジュール情報
  name          String
  description   String?
  cronExpression String
  timezone      String   @default("Asia/Tokyo")

  // テンプレート
  templateId    String
  template      ReportTemplate @relation(fields: [templateId], references: [id])

  // パラメータ
  parameters    Json     @default("{}")
  format        ReportFormat @default(PDF)

  // 配信設定
  recipients    String[]         // メールアドレス
  channels      String[]         // 通知チャンネルID
  uploadToStorage Boolean @default(true)

  // ステータス
  isActive      Boolean  @default(true)
  lastRunAt     DateTime?
  lastRunStatus String?
  nextRunAt     DateTime?

  // 保持設定
  retentionDays Int      @default(30)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isActive, nextRunAt])
  @@map("report_schedule_configs")
}

model ReportExecution {
  id            String   @id @default(cuid())

  // スケジュール参照
  scheduleId    String?
  reportId      String?

  // 実行情報
  status        ReportStatus @default(PENDING)
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  duration      Int?             // ミリ秒

  // 結果
  filePath      String?
  fileSize      Int?
  recipientCount Int?
  deliveryStatus Json     @default("[]")  // 配信結果

  // エラー
  errorMessage  String?  @db.Text

  @@index([scheduleId, startedAt])
  @@index([status])
  @@map("report_executions")
}

enum ReportType {
  SALES_SUMMARY       // 売上サマリー
  ORDER_DETAIL        // 注文詳細
  INVENTORY_STATUS    // 在庫状況
  PRODUCT_PERFORMANCE // 商品パフォーマンス
  PROFIT_ANALYSIS     // 利益分析
  CUSTOMER_ANALYSIS   // 顧客分析
  MARKETPLACE_COMPARISON // マーケットプレイス比較
  AUDIT_REPORT        // 監査レポート
  CUSTOM              // カスタム
}

enum ReportFormat {
  PDF
  EXCEL
  CSV
  HTML
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
  CANCELLED
  EXPIRED
}

// ========================================
// Phase 29: バッチ処理の最適化
// ========================================

model BatchJob {
  id          String   @id @default(cuid())

  // ジョブ定義
  name        String           // ジョブ名
  description String?
  jobType     BatchJobType     // ジョブタイプ

  // 設定
  config      Json     @default("{}") // ジョブ固有設定
  concurrency Int      @default(1)    // 並列数
  stepSize    Int      @default(100)  // ステップあたりの処理件数
  timeout     Int      @default(3600) // タイムアウト（秒）
  retryPolicy Json     @default("{}") // リトライポリシー

  // スケジュール
  isScheduled  Boolean  @default(false)
  cronExpression String?
  nextRunAt    DateTime?

  // メタデータ
  isActive    Boolean  @default(true)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 関連
  executions  BatchExecution[]

  @@index([jobType])
  @@index([isScheduled, nextRunAt])
  @@map("batch_jobs")
}

model BatchExecution {
  id          String   @id @default(cuid())

  // ジョブ参照
  jobId       String
  job         BatchJob @relation(fields: [jobId], references: [id])

  // 実行状態
  status      BatchExecutionStatus @default(PENDING)

  // 進捗追跡
  totalItems        Int?     // 確定総件数（null=推定中）
  estimatedItems    Int?     // 推定総件数
  processedItems    Int      @default(0)
  successItems      Int      @default(0)
  errorItems        Int      @default(0)
  skippedItems      Int      @default(0)

  // 進捗率
  progressPercent   Float    @default(0)
  progressType      BatchProgressType @default(ESTIMATED) // 推定/確定

  // 実行情報
  workerId    String?          // 実行ワーカーID
  queueJobId  String?          // BullMQ ジョブID
  parameters  Json     @default("{}") // 実行パラメータ
  result      Json?            // 実行結果

  // キャンセル
  cancelRequested Boolean @default(false)
  cancelReason    String?
  cancelledBy     String?
  cancelledAt     DateTime?

  // タイムスタンプ
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // エラー
  errorMessage String?  @db.Text
  errorDetails Json?

  // 関連
  steps       BatchStep[]

  @@index([jobId, createdAt])
  @@index([status])
  @@index([workerId])
  @@map("batch_executions")
}

model BatchStep {
  id          String   @id @default(cuid())

  // 実行参照
  executionId String
  execution   BatchExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  // ステップ情報
  stepNumber  Int              // ステップ番号（0始まり）
  stepKey     String?          // 冪等性キー（再実行時の識別用）
  status      BatchStepStatus  @default(PENDING)

  // 処理範囲
  startOffset Int              // 開始オフセット
  endOffset   Int              // 終了オフセット
  itemCount   Int      @default(0) // このステップの件数

  // 処理結果
  processedCount Int   @default(0)
  successCount   Int   @default(0)
  errorCount     Int   @default(0)
  skippedCount   Int   @default(0)

  // 詳細
  output      Json?            // ステップ出力
  errors      Json     @default("[]") // エラー詳細

  // タイムスタンプ
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([executionId, stepNumber])
  @@unique([executionId, stepKey])
  @@index([status])
  @@map("batch_steps")
}

model BatchEvent {
  id          String   @id @default(cuid())

  // イベント情報
  executionId String
  stepId      String?
  eventType   BatchEventType

  // データ
  data        Json     @default("{}")

  // タイムスタンプ
  timestamp   DateTime @default(now())

  @@index([executionId, timestamp])
  @@index([eventType])
  @@map("batch_events")
}

enum BatchJobType {
  PRODUCT_SYNC        // 商品同期
  PRICE_UPDATE        // 価格更新
  INVENTORY_CHECK     // 在庫チェック
  ORDER_SYNC          // 注文同期
  IMAGE_PROCESSING    // 画像処理
  LISTING_PUBLISH     // 出品公開
  DATA_EXPORT         // データエクスポート
  DATA_IMPORT         // データインポート
  CLEANUP             // クリーンアップ
  NOTIFICATION_SEND   // 通知送信
  REPORT_GENERATE     // レポート生成
  CUSTOM              // カスタム
}

enum BatchExecutionStatus {
  PENDING     // 待機中
  QUEUED      // キュー投入済み
  RUNNING     // 実行中
  PAUSED      // 一時停止
  COMPLETED   // 完了
  FAILED      // 失敗
  CANCELLED   // キャンセル
  TIMEOUT     // タイムアウト
}

enum BatchStepStatus {
  PENDING     // 待機中
  RUNNING     // 実行中
  COMPLETED   // 完了
  FAILED      // 失敗
  SKIPPED     // スキップ
}

enum BatchProgressType {
  ESTIMATED   // 推定
  KNOWN       // 確定
}

enum BatchEventType {
  EXECUTION_STARTED
  EXECUTION_COMPLETED
  EXECUTION_FAILED
  EXECUTION_CANCELLED
  STEP_STARTED
  STEP_COMPLETED
  STEP_FAILED
  PROGRESS_UPDATED
  CANCEL_REQUESTED
}

// ========================================
// Phase 30: 多言語対応（i18n）
// ========================================

model TranslationNamespace {
  id          String   @id @default(cuid())

  // 名前空間
  name        String   @unique   // 例: common, checkout, product, error
  description String?

  // メタデータ
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 関連
  keys        TranslationKey[]

  @@map("translation_namespaces")
}

model TranslationKey {
  id          String   @id @default(cuid())

  // キー情報
  namespaceId String
  namespace   TranslationNamespace @relation(fields: [namespaceId], references: [id])

  key         String           // 例: title, description, button.submit
  description String?          // キーの説明（翻訳者向けコンテキスト）
  context     String?          // 使用コンテキスト（画面名など）
  screenshot  String?          // スクリーンショットURL

  // プレースホルダー
  placeholders Json   @default("[]") // 例: ["name", "count"]

  // メタデータ
  isActive    Boolean  @default(true)
  maxLength   Int?             // 最大文字数制限
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 関連
  translations Translation[]

  @@unique([namespaceId, key])
  @@index([key])
  @@map("translation_keys")
}

model Translation {
  id          String   @id @default(cuid())

  // キー参照
  keyId       String
  translationKey TranslationKey @relation(fields: [keyId], references: [id], onDelete: Cascade)

  // 言語
  locale      String           // 例: ja, en, zh, zh-TW, ko, es, de, fr

  // 翻訳
  value       String   @db.Text

  // 品質管理
  status      TranslationStatus @default(UNTRANSLATED)
  source      TranslationSource @default(MANUAL)
  reviewedBy  String?
  reviewedAt  DateTime?

  // バージョン管理
  version     Int      @default(1)

  // メタデータ
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([keyId, locale])
  @@index([locale])
  @@index([status])
  @@map("translations")
}

model SupportedLocale {
  id          String   @id @default(cuid())

  // 言語情報
  code        String   @unique   // 例: ja, en, zh-TW
  name        String             // 例: 日本語, English
  nativeName  String             // 例: 日本語, English

  // 方向
  direction   TextDirection @default(LTR)

  // フォールバック
  fallbackLocale String?         // フォールバック先言語コード

  // 設定
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)

  // メタデータ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("supported_locales")
}

model TranslationHistory {
  id          String   @id @default(cuid())

  // 翻訳参照
  translationId String

  // 変更内容
  oldValue    String?  @db.Text
  newValue    String   @db.Text
  oldStatus   TranslationStatus?
  newStatus   TranslationStatus

  // 変更者
  changedBy   String?
  changeReason String?

  // タイムスタンプ
  createdAt   DateTime @default(now())

  @@index([translationId, createdAt])
  @@map("translation_histories")
}

enum TranslationStatus {
  UNTRANSLATED    // 未翻訳
  MACHINE         // 機械翻訳
  DRAFT           // 下書き
  PENDING_REVIEW  // レビュー待ち
  APPROVED        // 承認済み
  PUBLISHED       // 公開済み
}

enum TranslationSource {
  MANUAL          // 手動入力
  MACHINE_GOOGLE  // Google翻訳
  MACHINE_DEEPL   // DeepL
  MACHINE_GPT     // GPT
  IMPORTED        // インポート
}

enum TextDirection {
  LTR             // 左から右
  RTL             // 右から左
}

// ========================================
// Phase 31: パフォーマンス最適化
// ========================================

model CacheConfig {
  id          String   @id @default(cuid())

  // キャッシュ設定
  name        String   @unique   // キャッシュ名（例: products, categories）
  description String?
  cacheType   CacheType @default(QUERY)

  // TTL設定
  ttlSeconds  Int      @default(300)  // デフォルト5分
  maxEntries  Int?                    // 最大エントリ数

  // 無効化設定
  tags        String[] @default([])   // タグベース無効化用
  invalidateOn String[] @default([])  // 無効化トリガー（例: product.update）

  // 統計
  hitCount    Int      @default(0)
  missCount   Int      @default(0)
  evictCount  Int      @default(0)

  // メタデータ
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 関連
  entries     CacheEntry[]

  @@map("cache_configs")
}

model CacheEntry {
  id          String   @id @default(cuid())

  // キャッシュ参照
  configId    String
  config      CacheConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  // キー・値
  cacheKey    String           // キャッシュキー
  value       Json             // キャッシュ値
  valueHash   String?          // 値のハッシュ（検証用）

  // タグ
  tags        String[] @default([])

  // 有効期限
  expiresAt   DateTime

  // メタデータ
  hitCount    Int      @default(0)
  lastHitAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([configId, cacheKey])
  @@index([expiresAt])
  @@index([tags])
  @@map("cache_entries")
}

model QueryPerformance {
  id          String   @id @default(cuid())

  // クエリ情報
  queryHash   String           // クエリのハッシュ
  queryText   String   @db.Text // クエリテキスト（サニタイズ済み）
  operation   String           // SELECT, INSERT, UPDATE, DELETE
  tableName   String?          // 主テーブル名

  // パフォーマンス
  executionTime Float          // 実行時間（ミリ秒）
  rowsExamined  Int?           // 検査行数
  rowsReturned  Int?           // 返却行数

  // 問題検出
  isSlowQuery   Boolean @default(false)
  hasN1Problem  Boolean @default(false)
  suggestions   Json    @default("[]")  // 最適化提案

  // コンテキスト
  endpoint      String?         // APIエンドポイント
  requestId     String?         // リクエストID
  userId        String?

  // タイムスタンプ
  recordedAt    DateTime @default(now())

  @@index([queryHash])
  @@index([isSlowQuery, recordedAt])
  @@index([tableName])
  @@map("query_performances")
}

model QueryStats {
  id          String   @id @default(cuid())

  // 集計期間
  periodStart DateTime
  periodEnd   DateTime
  periodType  StatsPeriodType @default(HOURLY)

  // クエリ識別
  queryHash   String
  tableName   String?

  // 統計
  executionCount Int    @default(0)
  totalTime      Float  @default(0)   // 合計実行時間
  avgTime        Float  @default(0)   // 平均実行時間
  maxTime        Float  @default(0)   // 最大実行時間
  minTime        Float  @default(0)   // 最小実行時間
  p95Time        Float?               // 95パーセンタイル
  p99Time        Float?               // 99パーセンタイル

  // 問題
  slowQueryCount Int    @default(0)
  n1ProblemCount Int    @default(0)

  @@unique([periodStart, periodType, queryHash])
  @@index([periodStart, periodType])
  @@map("query_stats")
}

enum CacheType {
  QUERY       // クエリ結果キャッシュ
  DATA        // データキャッシュ
  PAGE        // ページキャッシュ
  FRAGMENT    // フラグメントキャッシュ
  SESSION     // セッションキャッシュ
  API         // API レスポンスキャッシュ
}

enum StatsPeriodType {
  MINUTELY
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
}

// ========================================
// Phase 32: 監視・アラート
// ========================================

model MetricDefinition {
  id          String   @id @default(cuid())

  // メトリクス定義
  name        String   @unique   // 例: system.cpu.usage, business.orders.count
  displayName String             // 表示名
  description String?
  unit        String?            // 単位（%, ms, count等）

  // 分類
  category    MetricCategory
  metricType  MetricType @default(GAUGE)

  // 収集設定
  collectInterval Int  @default(60)  // 収集間隔（秒）
  retentionDays   Int  @default(30)  // 保持日数

  // メタデータ
  isActive    Boolean  @default(true)
  tags        String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 関連
  snapshots   MetricSnapshot[]
  alertRules  MetricAlertRule[]

  @@map("metric_definitions")
}

model MetricSnapshot {
  id          String   @id @default(cuid())

  // メトリクス参照
  metricId    String
  metric      MetricDefinition @relation(fields: [metricId], references: [id], onDelete: Cascade)

  // 値
  value       Float
  minValue    Float?
  maxValue    Float?
  avgValue    Float?
  count       Int?     // カウンター系メトリクス用

  // ラベル（ディメンション）
  labels      Json     @default("{}")  // 例: { "host": "server-1", "endpoint": "/api/products" }

  // タイムスタンプ
  timestamp   DateTime @default(now())

  @@index([metricId, timestamp])
  @@index([timestamp])
  @@map("metric_snapshots")
}

model MetricAlertRule {
  id          String   @id @default(cuid())

  // ルール定義
  name        String
  description String?
  metricId    String
  metric      MetricDefinition @relation(fields: [metricId], references: [id])

  // 条件
  condition   MetricAlertCondition
  threshold   Float
  duration    Int      @default(60)   // 判定期間（秒）
  comparison  MetricAlertComparison

  // 重要度
  severity    MetricAlertSeverity @default(WARNING)

  // 通知設定
  channelIds  String[] @default([])   // 通知チャンネルID
  notifyInterval Int   @default(300)  // 再通知間隔（秒）
  maxNotifications Int @default(5)    // 最大通知回数

  // Playbook
  playbookUrl String?          // 対応手順書URL
  runbook     Json?            // 対応手順（JSON形式）

  // メタデータ
  isActive    Boolean  @default(true)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 関連
  alerts      MetricAlert[]

  @@index([metricId])
  @@index([severity, isActive])
  @@map("metric_alert_rules")
}

model MetricAlert {
  id          String   @id @default(cuid())

  // ルール参照
  ruleId      String
  rule        MetricAlertRule @relation(fields: [ruleId], references: [id])

  // アラート状態
  status      MetricAlertStatus @default(FIRING)
  severity    MetricAlertSeverity

  // 値
  currentValue Float           // 現在値
  threshold    Float           // しきい値

  // 詳細
  message     String   @db.Text
  labels      Json     @default("{}")
  annotations Json     @default("{}")

  // 対応状況
  assignedTo  String?
  assignedAt  DateTime?
  acknowledgedBy String?
  acknowledgedAt DateTime?
  resolvedBy  String?
  resolvedAt  DateTime?
  resolution  String?  @db.Text

  // 通知
  notificationCount Int @default(0)
  lastNotifiedAt DateTime?

  // タイムスタンプ
  firedAt     DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 関連
  history     MetricAlertHistory[]

  @@index([ruleId, status])
  @@index([status, firedAt])
  @@index([severity, status])
  @@map("metric_alerts")
}

model MetricAlertHistory {
  id          String   @id @default(cuid())

  // アラート参照
  alertId     String
  alert       MetricAlert @relation(fields: [alertId], references: [id], onDelete: Cascade)

  // 変更内容
  action      MetricAlertAction
  oldStatus   MetricAlertStatus?
  newStatus   MetricAlertStatus?

  // 詳細
  comment     String?  @db.Text
  changedBy   String?

  // タイムスタンプ
  createdAt   DateTime @default(now())

  @@index([alertId, createdAt])
  @@map("metric_alert_histories")
}

model SystemHealth {
  id          String   @id @default(cuid())

  // システム情報
  hostname    String?
  component   String           // api, worker, database, redis

  // リソース使用率
  cpuUsage    Float?           // CPU使用率（%）
  memoryUsage Float?           // メモリ使用率（%）
  diskUsage   Float?           // ディスク使用率（%）

  // パフォーマンス
  responseTime Float?          // 平均レスポンス時間（ms）
  requestCount Int?            // リクエスト数
  errorCount   Int?            // エラー数
  errorRate    Float?          // エラー率（%）

  // 接続
  activeConnections Int?       // アクティブ接続数
  queuedJobs       Int?        // キュー内ジョブ数

  // ステータス
  status      HealthStatus @default(HEALTHY)
  lastError   String?

  // タイムスタンプ
  recordedAt  DateTime @default(now())

  @@index([component, recordedAt])
  @@index([status])
  @@map("system_health")
}

enum MetricCategory {
  SYSTEM      // システムメトリクス
  BUSINESS    // ビジネスメトリクス
  PERFORMANCE // パフォーマンスメトリクス
  SECURITY    // セキュリティメトリクス
  CUSTOM      // カスタムメトリクス
}

enum MetricType {
  GAUGE       // ゲージ（現在値）
  COUNTER     // カウンター（累積値）
  HISTOGRAM   // ヒストグラム
  SUMMARY     // サマリー
}

enum MetricAlertCondition {
  ABOVE       // 以上
  BELOW       // 以下
  EQUAL       // 等しい
  NOT_EQUAL   // 等しくない
  INCREASE_BY // 増加率
  DECREASE_BY // 減少率
}

enum MetricAlertComparison {
  GT          // より大きい
  GTE         // 以上
  LT          // より小さい
  LTE         // 以下
  EQ          // 等しい
  NE          // 等しくない
}

enum MetricAlertSeverity {
  CRITICAL    // 緊急
  WARNING     // 警告
  INFO        // 情報
}

enum MetricAlertStatus {
  FIRING      // 発火中
  ACKNOWLEDGED // 確認済み
  RESOLVED    // 解決済み
  SILENCED    // 抑制中
}

enum MetricAlertAction {
  CREATED     // 作成
  ACKNOWLEDGED // 確認
  ASSIGNED    // アサイン
  ESCALATED   // エスカレーション
  RESOLVED    // 解決
  SILENCED    // 抑制
  REOPENED    // 再オープン
  COMMENTED   // コメント
  NOTIFIED    // 通知
}

enum HealthStatus {
  HEALTHY     // 正常
  DEGRADED    // 劣化
  UNHEALTHY   // 異常
  UNKNOWN     // 不明
}

// ========================================
// Phase 33: セキュリティ強化
// ========================================

model SecurityEvent {
  id          String   @id @default(cuid())

  // イベント情報
  eventType   SecurityEventType
  severity    SecurityEventSeverity @default(INFO)
  description String
  details     Json     @default("{}")

  // アクター情報
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  apiKeyId    String?
  ipAddress   String?
  userAgent   String?  @db.Text
  deviceId    String?

  // リソース情報
  resourceType String?
  resourceId   String?
  action       String?

  // 結果
  success     Boolean  @default(true)
  errorCode   String?
  errorMessage String?

  // タイムスタンプ
  occurredAt  DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([eventType, occurredAt])
  @@index([userId, occurredAt])
  @@index([ipAddress, occurredAt])
  @@index([severity])
  @@map("security_events")
}

model LoginAttempt {
  id          String   @id @default(cuid())

  // ユーザー情報
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  email       String?
  username    String?

  // 接続情報
  ipAddress   String
  userAgent   String?  @db.Text
  deviceFingerprint String?
  geoLocation Json?    // { country, city, region }

  // 結果
  success     Boolean  @default(false)
  failureReason LoginFailureReason?
  mfaRequired Boolean  @default(false)
  mfaCompleted Boolean @default(false)

  // ブルートフォース保護
  attemptCount Int     @default(1)
  isBlocked    Boolean @default(false)
  blockedUntil DateTime?

  // タイムスタンプ
  attemptedAt DateTime @default(now())

  @@index([email, attemptedAt])
  @@index([ipAddress, attemptedAt])
  @@index([userId, attemptedAt])
  @@index([isBlocked])
  @@map("login_attempts")
}

model DeviceSession {
  id          String   @id @default(cuid())

  // ユーザー情報
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // デバイス情報
  deviceId    String
  deviceName  String?
  deviceType  DeviceType @default(UNKNOWN)
  browser     String?
  browserVersion String?
  os          String?
  osVersion   String?

  // 接続情報
  ipAddress   String
  geoLocation Json?    // { country, city, region }

  // セッション状態
  isTrusted   Boolean  @default(false)
  isActive    Boolean  @default(true)
  lastActivityAt DateTime @default(now())

  // タイムスタンプ
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @default(now())
  revokedAt   DateTime?

  @@unique([userId, deviceId])
  @@index([userId, isActive])
  @@index([lastActivityAt])
  @@map("device_sessions")
}

model TwoFactorAuth {
  id          String   @id @default(cuid())

  // ユーザー情報
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 2FA設定
  method      TwoFactorMethod
  isEnabled   Boolean  @default(false)
  isVerified  Boolean  @default(false)

  // TOTP用
  totpSecret  String?  // 暗号化済み
  totpUri     String?

  // バックアップコード
  backupCodes String[] // 暗号化済み
  backupCodesUsed Int  @default(0)

  // SMS/Email用
  phoneNumber String?
  email       String?

  // 使用履歴
  lastUsedAt  DateTime?
  useCount    Int      @default(0)

  // タイムスタンプ
  enabledAt   DateTime?
  verifiedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("two_factor_auth")
}

model TwoFactorChallenge {
  id          String   @id @default(cuid())

  // ユーザー情報
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // チャレンジ情報
  method      TwoFactorMethod
  code        String?  // 送信されたコード（SMS/Email用）
  expiresAt   DateTime

  // 状態
  isUsed      Boolean  @default(false)
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)

  // タイムスタンプ
  createdAt   DateTime @default(now())
  usedAt      DateTime?

  @@index([userId, createdAt])
  @@index([expiresAt])
  @@map("two_factor_challenges")
}

model ApiKeyPolicy {
  id          String   @id @default(cuid())

  // 対象
  apiKeyId    String   @unique
  apiKey      UserApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  // 有効期限
  expiresAt   DateTime?
  maxUsageCount Int?   // 最大使用回数
  currentUsageCount Int @default(0)

  // IP制限
  allowedIps  String[] // 許可IPアドレス（CIDR対応）
  deniedIps   String[] // 拒否IPアドレス

  // スコープ制限
  scopes      String[] // 許可スコープ（例: read:products, write:orders）
  isReadOnly  Boolean  @default(false)

  // レート制限
  rateLimit   Int?     // リクエスト/分
  rateLimitWindow Int  @default(60) // 秒

  // 使用統計
  lastUsedAt  DateTime?
  lastUsedIp  String?

  // タイムスタンプ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("api_key_policies")
}

model PasswordPolicy {
  id          String   @id @default(cuid())

  // 識別
  name        String   @unique
  description String?
  isDefault   Boolean  @default(false)

  // パスワード要件
  minLength   Int      @default(8)
  maxLength   Int      @default(128)
  requireUppercase Boolean @default(true)
  requireLowercase Boolean @default(true)
  requireNumbers   Boolean @default(true)
  requireSymbols   Boolean @default(false)
  forbiddenPatterns String[] // 禁止パターン

  // 履歴・有効期限
  passwordHistoryCount Int @default(5) // 過去N個のパスワードを禁止
  maxAgeDays   Int?     // パスワード有効期限（日）
  warnBeforeDays Int?   // 期限切れ警告（日前）

  // ロックアウト
  maxFailedAttempts Int @default(5)
  lockoutDurationMinutes Int @default(30)

  // ステータス
  isActive    Boolean  @default(true)

  // タイムスタンプ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("password_policies")
}

model PasswordHistory {
  id          String   @id @default(cuid())

  // ユーザー情報
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // パスワード情報
  passwordHash String  // 過去のパスワードハッシュ

  // タイムスタンプ
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
  @@map("password_histories")
}

// ========================================
// Phase 34: 外部連携強化
// ========================================

model ExternalIntegration {
  id          String   @id @default(cuid())

  // 識別
  name        String   @unique
  displayName String
  description String?
  type        IntegrationType
  provider    String   // google, freee, yayoi, moneyforward

  // 設定
  config      Json     @default("{}") // プロバイダ固有設定
  webhookUrl  String?  // コールバックURL
  scopes      String[] // 要求スコープ

  // ステータス
  isEnabled   Boolean  @default(true)
  isConfigured Boolean @default(false)
  lastHealthCheck DateTime?
  healthStatus IntegrationHealthStatus @default(UNKNOWN)

  // 統計
  totalSyncs  Int      @default(0)
  successfulSyncs Int  @default(0)
  failedSyncs Int      @default(0)

  // タイムスタンプ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  credentials IntegrationCredential[]
  syncLogs    IntegrationSyncLog[]
  analyticsEvents AnalyticsEvent[]
  accountingExports AccountingExport[]

  @@map("external_integrations")
}

model IntegrationCredential {
  id          String   @id @default(cuid())

  // 連携情報
  integrationId String
  integration ExternalIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  // 認証タイプ
  authType    IntegrationAuthType

  // OAuth用
  accessToken String?  @db.Text // 暗号化済み
  refreshToken String? @db.Text // 暗号化済み
  tokenType   String?
  scope       String?
  expiresAt   DateTime?

  // APIキー用
  apiKey      String?  @db.Text // 暗号化済み
  apiSecret   String?  @db.Text // 暗号化済み

  // Basic認証用
  username    String?
  password    String?  // 暗号化済み

  // 追加情報
  accountId   String?  // 外部サービスのアカウントID
  metadata    Json     @default("{}")

  // ステータス
  isValid     Boolean  @default(true)
  lastValidatedAt DateTime?
  lastRefreshedAt DateTime?

  // タイムスタンプ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([integrationId, isValid])
  @@map("integration_credentials")
}

model IntegrationSyncLog {
  id          String   @id @default(cuid())

  // 連携情報
  integrationId String
  integration ExternalIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  // 同期情報
  syncType    IntegrationSyncType
  direction   SyncDirection
  entityType  String?  // products, orders, etc.
  entityCount Int      @default(0)

  // 実行情報
  status      IntegrationSyncStatus
  startedAt   DateTime @default(now())
  completedAt DateTime?
  duration    Int?     // ミリ秒

  // 結果
  successCount Int     @default(0)
  failureCount Int     @default(0)
  skippedCount Int     @default(0)

  // エラー情報
  errorCode   String?
  errorMessage String? @db.Text
  errorDetails Json?

  // リトライ情報
  retryCount  Int      @default(0)
  maxRetries  Int      @default(3)
  nextRetryAt DateTime?

  // タイムスタンプ
  createdAt   DateTime @default(now())

  @@index([integrationId, createdAt])
  @@index([status])
  @@index([syncType])
  @@map("integration_sync_logs")
}

model AnalyticsEvent {
  id          String   @id @default(cuid())

  // 連携情報
  integrationId String
  integration ExternalIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  // イベント情報
  eventName   String
  eventCategory String?
  eventLabel  String?
  eventValue  Float?
  parameters  Json     @default("{}")

  // ユーザー情報
  userId      String?
  sessionId   String?
  clientId    String?

  // 送信状態
  status      AnalyticsEventStatus @default(PENDING)
  sentAt      DateTime?
  retryCount  Int      @default(0)

  // エラー情報
  errorMessage String?

  // タイムスタンプ
  occurredAt  DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([integrationId, status])
  @@index([eventName, occurredAt])
  @@index([status, createdAt])
  @@map("analytics_events")
}

model AccountingExport {
  id          String   @id @default(cuid())

  // 連携情報
  integrationId String
  integration ExternalIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  // エクスポート設定
  exportType  AccountingExportType
  periodStart DateTime
  periodEnd   DateTime
  format      AccountingFormat @default(CSV)

  // データ範囲
  includeOrders Boolean @default(true)
  includeRefunds Boolean @default(true)
  includeShipping Boolean @default(true)
  includeFees Boolean @default(true)

  // 実行情報
  status      AccountingExportStatus @default(PENDING)
  startedAt   DateTime?
  completedAt DateTime?

  // 結果
  totalRecords Int     @default(0)
  totalAmount  Float   @default(0)
  currency    String  @default("JPY")

  // ファイル情報
  fileUrl     String?
  fileSize    Int?

  // エラー情報
  errorMessage String?

  // タイムスタンプ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([integrationId, createdAt])
  @@index([status])
  @@map("accounting_exports")
}

model AccountingMapping {
  id          String   @id @default(cuid())

  // マッピング情報
  provider    String   // freee, yayoi, moneyforward
  sourceField String   // RAKUDAのフィールド
  targetField String   // 外部サービスのフィールド
  transformation String? // 変換ルール

  // カテゴリマッピング
  categoryType AccountingCategoryType?
  categoryCode String?
  categoryName String?

  // ステータス
  isActive    Boolean  @default(true)

  // タイムスタンプ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, sourceField])
  @@map("accounting_mappings")
}

// ========================================
// Phase 33-34 Enums
// ========================================

enum SecurityEventType {
  LOGIN_SUCCESS
  LOGIN_FAILURE
  LOGOUT
  PASSWORD_CHANGE
  PASSWORD_RESET_REQUEST
  PASSWORD_RESET_COMPLETE
  MFA_ENABLED
  MFA_DISABLED
  MFA_CHALLENGE_SUCCESS
  MFA_CHALLENGE_FAILURE
  API_KEY_CREATED
  API_KEY_REVOKED
  API_KEY_USED
  SESSION_CREATED
  SESSION_REVOKED
  PERMISSION_GRANTED
  PERMISSION_REVOKED
  ROLE_ASSIGNED
  ROLE_REMOVED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  SUSPICIOUS_ACTIVITY
  DATA_EXPORT
  DATA_DELETE
}

enum SecurityEventSeverity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum LoginFailureReason {
  INVALID_CREDENTIALS
  ACCOUNT_LOCKED
  ACCOUNT_DISABLED
  MFA_REQUIRED
  MFA_FAILED
  IP_BLOCKED
  RATE_LIMITED
  SESSION_EXPIRED
  INVALID_TOKEN
}

enum DeviceType {
  DESKTOP
  MOBILE
  TABLET
  API_CLIENT
  UNKNOWN
}

enum TwoFactorMethod {
  TOTP        // Time-based One-Time Password
  SMS         // SMS認証
  EMAIL       // メール認証
  BACKUP_CODE // バックアップコード
}

enum IntegrationType {
  ANALYTICS   // 分析ツール
  ACCOUNTING  // 会計ソフト
  MARKETING   // マーケティング
  SHIPPING    // 配送
  PAYMENT     // 決済
  CRM         // 顧客管理
  CUSTOM      // カスタム
}

enum IntegrationAuthType {
  OAUTH2
  API_KEY
  BASIC
  BEARER
  CUSTOM
}

enum IntegrationHealthStatus {
  HEALTHY
  DEGRADED
  UNHEALTHY
  UNKNOWN
}

enum IntegrationSyncType {
  FULL        // 全件同期
  INCREMENTAL // 差分同期
  MANUAL      // 手動同期
  WEBHOOK     // Webhook起動
  SCHEDULED   // スケジュール同期
}

enum SyncDirection {
  INBOUND     // 外部→RAKUDA
  OUTBOUND    // RAKUDA→外部
  BIDIRECTIONAL // 双方向
}

enum IntegrationSyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
  PARTIAL     // 一部成功
}

enum AnalyticsEventStatus {
  PENDING
  SENT
  FAILED
  RETRYING
}

enum AccountingExportType {
  SALES       // 売上
  PURCHASES   // 仕入
  EXPENSES    // 経費
  JOURNAL     // 仕訳
  FULL        // 全部
}

enum AccountingFormat {
  CSV
  JSON
  XML
  FREEE
  YAYOI
  MONEYFORWARD
}

enum AccountingExportStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum AccountingCategoryType {
  REVENUE     // 収益
  COST        // 原価
  EXPENSE     // 経費
  ASSET       // 資産
  LIABILITY   // 負債
}

// ========================================
// Phase 35: ワークフロー自動化
// ========================================

// ワークフロー定義
model Workflow {
  id          String   @id @default(cuid())

  // 基本情報
  name        String
  description String?  @db.Text
  version     Int      @default(1)

  // トリガー設定
  triggerType WorkflowTriggerType
  triggerConfig Json   @default("{}") // イベント名、スケジュール等

  // 設定
  isActive    Boolean  @default(true)
  priority    Int      @default(0)
  timeout     Int      @default(3600000) // タイムアウト（ミリ秒）
  maxRetries  Int      @default(3)

  // オーナー
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)

  // 統計
  totalExecutions Int  @default(0)
  successfulExecutions Int @default(0)
  failedExecutions Int @default(0)

  // タイムスタンプ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  steps       WorkflowStep[]
  executions  WorkflowExecution[]

  @@index([triggerType, isActive])
  @@index([createdById])
  @@map("workflows")
}

// ワークフローステップ
model WorkflowStep {
  id          String   @id @default(cuid())

  // ワークフロー
  workflowId  String
  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // ステップ情報
  name        String
  description String?
  order       Int      // 実行順序

  // ステップタイプ
  stepType    WorkflowStepType

  // 設定（タイプ別）
  config      Json     @default("{}") // アクション、条件、承認者等

  // 条件分岐
  condition   Json?    // 実行条件
  onSuccess   String?  // 成功時の次ステップID
  onFailure   String?  // 失敗時の次ステップID

  // エラーハンドリング
  retryOnError Boolean @default(true)
  maxRetries  Int      @default(3)
  retryDelay  Int      @default(60000) // リトライ間隔（ミリ秒）

  // タイムスタンプ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  executions  WorkflowStepExecution[]

  @@index([workflowId, order])
  @@map("workflow_steps")
}

// ワークフロー実行インスタンス
model WorkflowExecution {
  id          String   @id @default(cuid())

  // ワークフロー
  workflowId  String
  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // トリガー情報
  triggeredBy WorkflowTriggerSource
  triggeredById String? // ユーザーID or システムID
  triggerData Json     @default("{}") // トリガーデータ

  // 対象エンティティ
  entityType  String?  // Product, Order, Listing等
  entityId    String?

  // 実行状態
  status      WorkflowExecutionStatus @default(PENDING)
  currentStepId String?

  // コンテキスト
  context     Json     @default("{}") // 実行中の変数・データ

  // 実行情報
  startedAt   DateTime?
  completedAt DateTime?
  duration    Int?     // ミリ秒

  // エラー情報
  errorCode   String?
  errorMessage String? @db.Text
  errorDetails Json?

  // リトライ
  retryCount  Int      @default(0)

  // タイムスタンプ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  stepExecutions WorkflowStepExecution[]
  approvalRequests ApprovalRequest[]

  @@index([workflowId, status])
  @@index([entityType, entityId])
  @@index([status, createdAt])
  @@map("workflow_executions")
}

// ワークフローステップ実行
model WorkflowStepExecution {
  id          String   @id @default(cuid())

  // 実行インスタンス
  executionId String
  execution   WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  // ステップ
  stepId      String
  step        WorkflowStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  // 実行状態
  status      WorkflowStepStatus @default(PENDING)

  // 入出力
  input       Json     @default("{}") // ステップへの入力
  output      Json?    // ステップの出力

  // 実行情報
  startedAt   DateTime?
  completedAt DateTime?
  duration    Int?     // ミリ秒

  // エラー情報
  errorCode   String?
  errorMessage String? @db.Text

  // リトライ
  retryCount  Int      @default(0)

  // タイムスタンプ
  createdAt   DateTime @default(now())

  @@index([executionId, stepId])
  @@index([status])
  @@map("workflow_step_executions")
}

// 承認リクエスト
model ApprovalRequest {
  id          String   @id @default(cuid())

  // ワークフロー実行
  executionId String?
  execution   WorkflowExecution? @relation(fields: [executionId], references: [id], onDelete: SetNull)

  // 承認情報
  title       String
  description String?  @db.Text
  requestType ApprovalRequestType

  // 対象エンティティ
  entityType  String   // Product, Order, Listing, PriceChange等
  entityId    String

  // 変更内容
  currentValue Json?   // 変更前の値
  proposedValue Json?  // 提案された値
  changeReason String? @db.Text

  // 承認者設定
  requiredApprovers Int @default(1) // 必要な承認数
  approverRoleIds String[] // 承認可能なロールID
  approverUserIds String[] // 承認可能なユーザーID

  // 期限
  deadline    DateTime?

  // エスカレーション設定
  escalationEnabled Boolean @default(false)
  escalationDelay Int?     // エスカレーションまでの時間（ミリ秒）
  escalatedTo   String?   // エスカレーション先ユーザーID
  escalatedAt   DateTime?

  // ステータス
  status      ApprovalStatus @default(PENDING)

  // 統計
  approvalCount Int     @default(0)
  rejectionCount Int    @default(0)

  // タイムスタンプ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  actions     ApprovalAction[]

  @@index([status, deadline])
  @@index([entityType, entityId])
  @@index([status, createdAt])
  @@map("approval_requests")
}

// 承認アクション
model ApprovalAction {
  id          String   @id @default(cuid())

  // 承認リクエスト
  requestId   String
  request     ApprovalRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  // アクション実行者
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // アクション
  action      ApprovalActionType
  comment     String?  @db.Text

  // 条件付き承認
  conditions  Json?    // 条件（修正要求等）

  // タイムスタンプ
  createdAt   DateTime @default(now())

  @@index([requestId])
  @@index([userId])
  @@map("approval_actions")
}

// 自動化ルール
model AutomationRule {
  id          String   @id @default(cuid())

  // 基本情報
  name        String
  description String?  @db.Text

  // トリガー
  triggerEvent String  // product.created, order.completed, inventory.low等

  // 設定
  isActive    Boolean  @default(true)
  priority    Int      @default(0) // 高い方が優先

  // 条件
  conditions  Json     @default("[]") // 条件配列
  conditionLogic ConditionLogic @default(AND) // AND/OR

  // アクション
  actions     Json     @default("[]") // アクション配列

  // 制限
  rateLimit   Int?     // 一定期間の実行回数制限
  rateLimitPeriod Int? // 制限期間（秒）
  cooldownPeriod Int?  // クールダウン期間（秒）

  // 通知設定
  notifyOnSuccess Boolean @default(false)
  notifyOnFailure Boolean @default(true)
  notifyUserIds String[] // 通知先ユーザーID

  // オーナー
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)

  // 統計
  totalExecutions Int  @default(0)
  successfulExecutions Int @default(0)
  failedExecutions Int @default(0)
  lastExecutedAt DateTime?

  // タイムスタンプ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  executions  AutomationExecution[]

  @@index([triggerEvent, isActive])
  @@index([isActive, priority])
  @@map("automation_rules")
}

// 自動化ルール実行ログ
model AutomationExecution {
  id          String   @id @default(cuid())

  // ルール
  ruleId      String
  rule        AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  // トリガー情報
  triggerEvent String
  triggerData Json     @default("{}") // イベントデータ

  // 対象エンティティ
  entityType  String?
  entityId    String?

  // 条件評価
  conditionsMet Boolean @default(true)
  conditionResults Json? // 各条件の評価結果

  // アクション実行
  actionsExecuted Json @default("[]") // 実行したアクションと結果

  // ステータス
  status      AutomationExecutionStatus

  // 実行情報
  startedAt   DateTime @default(now())
  completedAt DateTime?
  duration    Int?     // ミリ秒

  // エラー情報
  errorCode   String?
  errorMessage String? @db.Text

  // タイムスタンプ
  createdAt   DateTime @default(now())

  @@index([ruleId, createdAt])
  @@index([triggerEvent, createdAt])
  @@index([entityType, entityId])
  @@index([status])
  @@map("automation_executions")
}

// ========================================
// Phase 36: AI機能強化
// ========================================

// AIモデル設定
model AiModel {
  id          String   @id @default(cuid())

  // 基本情報
  name        String
  description String?
  modelType   AiModelType
  provider    AiProvider @default(OPENAI)

  // モデル設定
  modelId     String   // gpt-4o, gpt-3.5-turbo等
  apiEndpoint String?  // カスタムエンドポイント
  config      Json     @default("{}") // temperature, max_tokens等

  // プロンプト
  systemPrompt String? @db.Text
  promptTemplate String? @db.Text

  // バージョン
  version     String   @default("1.0")
  isLatest    Boolean  @default(true)

  // ステータス
  isActive    Boolean  @default(true)

  // パフォーマンス統計
  totalPredictions Int @default(0)
  averageLatency Float? // 平均レイテンシ（ミリ秒）
  accuracy    Float?   // 精度（0-1）
  lastEvaluatedAt DateTime?

  // コスト追跡
  totalInputTokens Int @default(0)
  totalOutputTokens Int @default(0)
  totalCost   Float    @default(0)

  // タイムスタンプ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  predictions AiPredictionLog[]
  trainingJobs AiTrainingJob[]
  pricePredictions PricePrediction[]
  demandForecasts DemandForecast[]
  recommendations ProductRecommendation[]

  @@index([modelType, isActive])
  @@index([provider, modelId])
  @@map("ai_models")
}

// 価格予測
model PricePrediction {
  id          String   @id @default(cuid())

  // AIモデル
  modelId     String?
  model       AiModel? @relation(fields: [modelId], references: [id], onDelete: SetNull)

  // 対象商品
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // マーケットプレイス
  marketplace Marketplace

  // 予測結果
  currentPrice Float    // 現在価格
  predictedPrice Float  // 予測価格
  confidence  Float     // 確信度（0-1）
  priceRange  Json?     // { "min": 10.0, "max": 20.0 }

  // 予測の根拠
  factors     Json      @default("[]") // 影響要因と重み
  reasoning   String?   @db.Text // AI生成の説明

  // 推奨アクション
  recommendedAction PriceRecommendedAction?
  recommendedPrice Float?

  // 競合分析
  competitorCount Int   @default(0)
  averageCompetitorPrice Float?
  lowestCompetitorPrice Float?

  // 市場データ
  marketDemand Float?   // 需要指数（0-1）
  seasonalFactor Float? // 季節性係数

  // 有効期限
  validUntil  DateTime

  // 検証
  actualPrice Float?    // 実際の価格（検証用）
  wasAccurate Boolean?  // 予測が正確だったか
  accuracy    Float?    // 予測精度

  // タイムスタンプ
  predictedAt DateTime  @default(now())
  createdAt   DateTime  @default(now())

  @@index([productId, marketplace])
  @@index([marketplace, predictedAt])
  @@index([validUntil])
  @@map("price_predictions")
}

// 需要予測
model DemandForecast {
  id          String   @id @default(cuid())

  // AIモデル
  modelId     String?
  model       AiModel? @relation(fields: [modelId], references: [id], onDelete: SetNull)

  // 予測対象
  targetType  DemandForecastTarget
  targetId    String?  // カテゴリID、ブランドID、商品ID等
  targetName  String?  // カテゴリ名、ブランド名等
  marketplace Marketplace?

  // 予測期間
  forecastPeriod ForecastPeriod
  startDate   DateTime
  endDate     DateTime

  // 予測結果
  predictedDemand Float   // 予測需要（販売数）
  confidence  Float       // 確信度（0-1）
  demandRange Json?       // { "min": 10, "max": 50 }

  // トレンド
  trend       DemandTrend
  trendStrength Float?    // トレンド強度（0-1）
  growthRate  Float?      // 成長率（%）

  // 季節性
  seasonalIndex Float?    // 季節性指数
  isSeasonalPeak Boolean @default(false)

  // 影響要因
  factors     Json       @default("[]") // 影響要因

  // 推奨在庫
  recommendedStock Int?
  reorderPoint Int?      // 発注点

  // 検証
  actualDemand Float?    // 実際の需要（検証用）
  wasAccurate Boolean?
  accuracy    Float?

  // タイムスタンプ
  forecastedAt DateTime @default(now())
  createdAt   DateTime  @default(now())

  @@index([targetType, targetId])
  @@index([marketplace, forecastPeriod])
  @@index([startDate, endDate])
  @@map("demand_forecasts")
}

// 商品推薦
model ProductRecommendation {
  id          String   @id @default(cuid())

  // AIモデル
  modelId     String?
  model       AiModel? @relation(fields: [modelId], references: [id], onDelete: SetNull)

  // 推薦タイプ
  recommendationType RecommendationType

  // 入力情報
  inputData   Json     // 推薦生成に使用したデータ

  // 推薦商品
  recommendations Json @default("[]") // [{ productId, score, reason }]

  // スコア情報
  totalCandidates Int  @default(0) // 候補総数
  topScore    Float?   // 最高スコア

  // 対象ユーザー/商品
  userId      String?  // パーソナライズ推薦の場合
  sourceProductId String? // 関連商品推薦の場合
  category    String?  // カテゴリ推薦の場合

  // マーケットプレイス
  marketplace Marketplace?

  // 配信状態
  isDelivered Boolean @default(false)
  deliveredAt DateTime?

  // 効果測定
  impressions Int      @default(0)
  clicks      Int      @default(0)
  conversions Int      @default(0)
  revenue     Float    @default(0)

  // 有効期限
  validUntil  DateTime

  // タイムスタンプ
  generatedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([recommendationType, marketplace])
  @@index([userId, createdAt])
  @@index([validUntil])
  @@map("product_recommendations")
}

// AI学習ジョブ
model AiTrainingJob {
  id          String   @id @default(cuid())

  // AIモデル
  modelId     String
  model       AiModel  @relation(fields: [modelId], references: [id], onDelete: Cascade)

  // ジョブ情報
  jobType     AiTrainingJobType
  name        String
  description String?

  // 学習データ
  datasetConfig Json   @default("{}") // データセット設定
  datasetSize Int      @default(0)

  // ハイパーパラメータ
  hyperparameters Json @default("{}")

  // 実行情報
  status      AiTrainingStatus @default(PENDING)
  progress    Float    @default(0) // 進捗（0-100）

  startedAt   DateTime?
  completedAt DateTime?
  duration    Int?     // ミリ秒

  // 結果
  metrics     Json?    // { accuracy, loss, etc. }
  outputModelId String? // 学習後のモデルID
  artifactUrl String?  // 成果物のURL

  // エラー情報
  errorMessage String? @db.Text

  // コスト
  estimatedCost Float?
  actualCost  Float?

  // タイムスタンプ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([modelId, status])
  @@index([status, createdAt])
  @@map("ai_training_jobs")
}

// AI予測ログ
model AiPredictionLog {
  id          String   @id @default(cuid())

  // AIモデル
  modelId     String
  model       AiModel  @relation(fields: [modelId], references: [id], onDelete: Cascade)

  // リクエスト
  predictionType AiPredictionType
  input       Json     // 入力データ

  // レスポンス
  output      Json?    // 出力データ
  confidence  Float?   // 確信度

  // パフォーマンス
  latency     Int?     // レイテンシ（ミリ秒）
  inputTokens Int      @default(0)
  outputTokens Int     @default(0)
  cost        Float    @default(0)

  // ステータス
  status      AiPredictionStatus
  errorMessage String?

  // キャッシュ
  cacheHit    Boolean  @default(false)
  cacheKey    String?

  // タイムスタンプ
  requestedAt DateTime @default(now())
  completedAt DateTime?

  @@index([modelId, predictionType])
  @@index([predictionType, requestedAt])
  @@index([status])
  @@map("ai_prediction_logs")
}

// 価格最適化設定
model PriceOptimization {
  id          String   @id @default(cuid())

  // 対象
  targetType  PriceOptimizationTarget
  targetId    String?  // カテゴリID、ブランドID、商品ID等
  marketplace Marketplace?

  // 最適化戦略
  strategy    PriceOptimizationStrategy

  // 制約
  minPrice    Float?   // 最低価格
  maxPrice    Float?   // 最高価格
  minMargin   Float?   // 最低マージン率（%）
  maxDiscount Float?   // 最大割引率（%）

  // 目標
  targetMetric PriceOptimizationMetric @default(PROFIT)
  targetValue Float?   // 目標値

  // ルール
  rules       Json     @default("[]") // 追加ルール

  // 自動更新
  autoUpdate  Boolean  @default(false)
  updateFrequency Int? // 更新頻度（分）
  lastUpdatedAt DateTime?

  // 競合監視
  monitorCompetitors Boolean @default(true)
  competitorThreshold Float? // 競合価格との差異閾値（%）

  // ステータス
  isActive    Boolean  @default(true)

  // 統計
  totalOptimizations Int @default(0)
  averagePriceChange Float?
  revenueImpact Float?

  // タイムスタンプ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([targetType, targetId])
  @@index([marketplace, isActive])
  @@map("price_optimizations")
}

// 競合価格
model CompetitorPrice {
  id          String   @id @default(cuid())

  // 自社商品
  productId   String?
  product     Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  // 競合情報
  competitorName String
  competitorUrl String?
  marketplace String   // eBay, Amazon, etc.

  // 商品マッチング
  matchedTitle String?
  matchConfidence Float? // マッチング確信度（0-1）

  // 価格情報
  price       Float
  currency    String   @default("USD")
  shippingCost Float?
  totalPrice  Float?   // 価格 + 送料

  // 在庫状態
  inStock     Boolean  @default(true)
  stockQuantity Int?

  // 販売者情報
  sellerRating Float?
  sellerReviews Int?

  // 収集情報
  collectedAt DateTime @default(now())
  source      String   // manual, api, scraper

  // タイムスタンプ
  createdAt   DateTime @default(now())

  @@index([productId, marketplace])
  @@index([competitorName, marketplace])
  @@index([collectedAt])
  @@map("competitor_prices")
}

// ========================================
// Phase 35-36 Enums
// ========================================

enum WorkflowTriggerType {
  MANUAL      // 手動起動
  EVENT       // イベント駆動
  SCHEDULE    // スケジュール
  CONDITION   // 条件達成時
  API         // API経由
}

enum WorkflowTriggerSource {
  USER        // ユーザー
  SYSTEM      // システム
  SCHEDULE    // スケジュール
  WEBHOOK     // Webhook
  API         // API
  AUTOMATION  // 自動化ルール
}

enum WorkflowStepType {
  ACTION      // アクション実行
  CONDITION   // 条件分岐
  APPROVAL    // 承認
  DELAY       // 待機
  NOTIFICATION // 通知
  LOOP        // ループ
  PARALLEL    // 並列処理
  SCRIPT      // カスタムスクリプト
  AI          // AI処理
  INTEGRATION // 外部連携
}

enum WorkflowExecutionStatus {
  PENDING
  RUNNING
  WAITING_APPROVAL
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
  TIMEOUT
}

enum WorkflowStepStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  SKIPPED
  WAITING
}

enum ApprovalRequestType {
  PRODUCT_LISTING    // 商品出品承認
  PRICE_CHANGE       // 価格変更承認
  BULK_OPERATION     // 一括操作承認
  REFUND             // 返金承認
  ORDER_CANCELLATION // 注文キャンセル承認
  INVENTORY_ADJUSTMENT // 在庫調整承認
  SYSTEM_CHANGE      // システム変更承認
  CUSTOM             // カスタム
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  CANCELLED
  ESCALATED
}

enum ApprovalActionType {
  APPROVE
  REJECT
  REQUEST_CHANGES
  DELEGATE
  ESCALATE
  COMMENT
}

enum ConditionLogic {
  AND
  OR
}

enum AutomationExecutionStatus {
  SUCCESS
  PARTIAL_SUCCESS
  FAILED
  SKIPPED
}

enum AiModelType {
  PRICE_PREDICTION    // 価格予測
  DEMAND_FORECAST     // 需要予測
  PRODUCT_RECOMMENDATION // 商品推薦
  TRANSLATION         // 翻訳
  ATTRIBUTE_EXTRACTION // 属性抽出
  IMAGE_ANALYSIS      // 画像分析
  SENTIMENT_ANALYSIS  // 感情分析
  CUSTOM              // カスタム
}

enum AiProvider {
  OPENAI
  ANTHROPIC
  GOOGLE
  AZURE
  CUSTOM
}

enum PriceRecommendedAction {
  INCREASE
  DECREASE
  MAINTAIN
  REVIEW
}

enum DemandForecastTarget {
  PRODUCT     // 個別商品
  CATEGORY    // カテゴリ
  BRAND       // ブランド
  MARKETPLACE // マーケットプレイス全体
  OVERALL     // 全体
}

enum ForecastPeriod {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
}

enum DemandTrend {
  INCREASING
  DECREASING
  STABLE
  VOLATILE
}

enum RecommendationType {
  SIMILAR_PRODUCTS    // 類似商品
  FREQUENTLY_BOUGHT   // よく一緒に購入
  TRENDING            // トレンド
  PERSONALIZED        // パーソナライズ
  CROSS_SELL          // クロスセル
  UP_SELL             // アップセル
  NEW_ARRIVALS        // 新着
  BEST_SELLERS        // ベストセラー
}

enum AiTrainingJobType {
  FINE_TUNING         // ファインチューニング
  EMBEDDING           // 埋め込み生成
  EVALUATION          // モデル評価
  DATA_PREPARATION    // データ準備
}

enum AiTrainingStatus {
  PENDING
  PREPARING
  TRAINING
  EVALUATING
  COMPLETED
  FAILED
  CANCELLED
}

enum AiPredictionType {
  PRICE
  DEMAND
  RECOMMENDATION
  TRANSLATION
  ATTRIBUTE
  IMAGE
  SENTIMENT
  CUSTOM
}

enum AiPredictionStatus {
  SUCCESS
  FAILED
  TIMEOUT
  RATE_LIMITED
}

enum PriceOptimizationTarget {
  PRODUCT     // 個別商品
  CATEGORY    // カテゴリ
  BRAND       // ブランド
  GLOBAL      // 全体
}

enum PriceOptimizationStrategy {
  COMPETITIVE         // 競合価格追従
  PROFIT_MAXIMIZATION // 利益最大化
  MARKET_PENETRATION  // 市場浸透
  DYNAMIC             // 動的価格設定
  RULE_BASED          // ルールベース
}

enum PriceOptimizationMetric {
  PROFIT      // 利益
  REVENUE     // 売上
  MARGIN      // マージン
  VOLUME      // 販売数
}
