// Prisma Schema for Auto Listing System
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// 仕入元情報
// ========================================
model Source {
  id        String     @id @default(cuid())
  type      SourceType
  name      String
  url       String?
  isActive  Boolean    @default(true)
  metadata  Json       @default("{}")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  products Product[]

  @@map("sources")
}

enum SourceType {
  MERCARI
  YAHOO_AUCTION
  YAHOO_FLEA
  RAKUMA
  RAKUTEN
  AMAZON
  TAKAYAMA
  JOSHIN
  OTHER
}

// ========================================
// 統一商品モデル
// ========================================
model Product {
  id String @id @default(cuid())

  // ソース情報
  sourceId     String
  source       Source @relation(fields: [sourceId], references: [id])
  sourceItemId String // 元サイトの商品ID
  sourceUrl    String
  sourceHash   String? // 差分検知用ハッシュ

  // 基本情報（原文）
  title       String
  description String @db.Text
  price       Int // 仕入価格（円）

  // 翻訳済み情報
  titleEn       String?
  descriptionEn String? @db.Text

  // 商品属性
  category   String?
  brand      String?
  condition  String?
  weight     Int? // グラム
  attributes Json   @default("{}") // AI抽出属性

  // 画像
  images          String[] // 元画像URL
  processedImages String[] // 白抜き後URL（MinIO/S3）

  // セラー情報
  sellerId   String?
  sellerName String?

  // ステータス
  status            ProductStatus @default(PENDING_SCRAPE)
  translationStatus ProcessStatus @default(PENDING)
  imageStatus       ProcessStatus @default(PENDING)
  lastError         String?       @db.Text

  // タイムスタンプ
  scrapedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  listings Listing[]
  jobLogs  JobLog[]

  @@unique([sourceId, sourceItemId])
  @@index([status])
  @@index([sourceHash])
  @@index([createdAt])
  @@map("products")
}

enum ProductStatus {
  PENDING_SCRAPE
  SCRAPED
  PROCESSING_IMAGES
  TRANSLATING
  READY_TO_REVIEW
  APPROVED
  PUBLISHING
  ACTIVE
  SOLD
  OUT_OF_STOCK
  ERROR
  DELETED
}

enum ProcessStatus {
  PENDING
  PROCESSING
  COMPLETED
  ERROR
}

// ========================================
// 出品情報（マーケットプレイス別）
// ========================================
model Listing {
  id String @id @default(cuid())

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  marketplace          Marketplace
  marketplaceListingId String? // eBay/Joom の出品ID

  // 価格情報
  listingPrice Float // 出品価格（USD）
  shippingCost Float? // 送料
  currency     String @default("USD")

  // マーケット固有データ（JSONB）
  marketplaceData Json @default("{}")

  // ステータス
  status       ListingStatus @default(DRAFT)
  errorMessage String?       @db.Text

  // 在庫自動化制御（Phase 17）
  autoStatusEnabled Boolean   @default(true)  // 自動停止/再開の有効化
  pausedByInventory Boolean   @default(false) // 在庫切れによる自動停止中
  resumeAt          DateTime?                 // 遅延再開予定日時

  // タイムスタンプ
  listedAt  DateTime?
  soldAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // リレーション
  inventoryAlerts InventoryAlert[]
  sales           Sale[]

  @@unique([productId, marketplace])
  @@index([marketplace, status])
  @@index([marketplaceListingId])
  @@index([pausedByInventory, resumeAt])
  @@map("listings")
}

enum Marketplace {
  JOOM
  EBAY
}

enum ListingStatus {
  DRAFT
  PENDING_PUBLISH
  PUBLISHING
  ACTIVE
  PAUSED
  SOLD
  ENDED
  ERROR
}

// ========================================
// ジョブログ
// ========================================
model JobLog {
  id String @id @default(cuid())

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  jobId        String // BullMQ Job ID
  queueName    String
  jobType      String
  status       JobStatus
  payload      Json      @default("{}")
  result       Json?
  errorMessage String?   @db.Text

  startedAt   DateTime
  completedAt DateTime?
  duration    Int? // ミリ秒

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([queueName, status])
  @@index([createdAt])
  @@index([jobId])
  @@map("job_logs")
}

enum JobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  DEAD_LETTER
}

// ========================================
// 価格計算設定
// ========================================
model PriceSetting {
  id String @id @default(cuid())

  name        String      @unique
  marketplace Marketplace

  // 手数料
  platformFeeRate Float // プラットフォーム手数料率
  paymentFeeRate  Float // 決済手数料率

  // マージン
  targetProfitRate Float // 目標利益率
  adRate           Float @default(0) // 広告費率

  // 為替
  exchangeRate   Float // USD/JPY
  exchangeBuffer Float @default(0) // 為替バッファ

  // カテゴリ別設定（オプション）
  categorySettings Json @default("{}")

  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("price_settings")
}

// ========================================
// eBay シッピングポリシー
// ========================================
model ShippingPolicy {
  id String @id @default(cuid())

  name   String
  region String // US, EU, ASIA など

  // 配送方法
  carrier String // ePacket, Cpass, EMS など

  // 送料テーブル（重量別）
  shippingTable Json // { "100": 880, "200": 1060, ... }

  // 燃油サーチャージ
  fuelSurcharge Float @default(0)

  // 関税設定
  dutyThreshold Float? // 関税閾値（USD）
  dutyRate      Float? // 関税率

  // 追加設定
  handlingTime Int    @default(1) // 発送準備日数
  metadata     Json   @default("{}")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([region, carrier])
  @@map("shipping_policies")
}

// ========================================
// 為替レート履歴
// ========================================
model ExchangeRate {
  id String @id @default(cuid())

  fromCurrency String @default("JPY")
  toCurrency   String @default("USD")
  rate         Float

  fetchedAt DateTime @default(now())
  source    String   @default("manual") // manual, api, etc.

  @@index([fromCurrency, toCurrency, fetchedAt])
  @@map("exchange_rates")
}

// ========================================
// 翻訳プロンプト設定
// ========================================
model TranslationPrompt {
  id String @id @default(cuid())

  name        String  @unique // プロンプト名
  category    String? // 対象カテゴリ（nullはデフォルト）
  marketplace String? // joom, ebay, null=共通

  // プロンプト内容
  systemPrompt String @db.Text // システムプロンプト
  userPrompt   String @db.Text // ユーザープロンプトテンプレート

  // 抽出する属性
  extractAttributes String[] // ["brand", "model", "color", ...]

  // 追加指示
  additionalInstructions String? @db.Text
  seoKeywords            String[] // SEO推奨ワード

  // 設定
  priority  Int     @default(0) // 優先度（高いほど優先）
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  templates ListingTemplate[]

  @@index([category, marketplace])
  @@map("translation_prompts")
}

// ========================================
// eBay カテゴリマッピング
// ========================================
model EbayCategoryMapping {
  id String @id @default(cuid())

  sourceCategory String // 元カテゴリ（日本語）
  ebayCategoryId String // eBayカテゴリID
  ebayCategoryName String // eBayカテゴリ名

  // Item Specifics テンプレート
  itemSpecifics Json @default("{}")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  templates ListingTemplate[]

  @@unique([sourceCategory])
  @@map("ebay_category_mappings")
}

// ========================================
// 出品テンプレート
// ========================================
model ListingTemplate {
  id String @id @default(cuid())

  name        String @unique // テンプレート名
  description String? // 説明

  // カテゴリマッピングへの参照
  categoryMappingId String?
  categoryMapping   EbayCategoryMapping? @relation(fields: [categoryMappingId], references: [id])

  // 翻訳プロンプトへの参照
  translationPromptId String?
  translationPrompt   TranslationPrompt? @relation(fields: [translationPromptId], references: [id])

  // 価格設定
  profitRate Float @default(30) // 目標利益率 (%)
  minProfit  Float @default(500) // 最低利益額 (円)

  // 出品設定
  titleTemplate       String? @db.Text // タイトルテンプレート
  descriptionTemplate String? @db.Text // 説明文テンプレート
  conditionMapping    Json    @default("{}") // コンディション変換マップ

  // デフォルト値
  defaultWeight       Int?    // デフォルト重量 (g)
  defaultShippingDays String? // 配送日数

  // 設定
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryMappingId])
  @@map("listing_templates")
}

// ========================================
// マーケットプレイス認証情報
// ========================================
model MarketplaceCredential {
  id String @id @default(cuid())

  marketplace Marketplace
  name        String      @default("default") // アカウント名

  // 認証情報（暗号化推奨）
  credentials Json // { clientId, clientSecret, accessToken, refreshToken, ... }

  // トークン有効期限
  tokenExpiresAt        DateTime?
  refreshTokenExpiresAt DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([marketplace, name])
  @@index([marketplace, isActive])
  @@map("marketplace_credentials")
}

// ========================================
// OAuth状態管理（CSRF対策）
// ========================================
model OAuthState {
  id String @id @default(cuid())

  state     String   @unique
  provider  String // EBAY, JOOM, etc.
  expiresAt DateTime
  metadata  Json     @default("{}")

  createdAt DateTime @default(now())

  @@index([provider, expiresAt])
  @@map("oauth_states")
}

// ========================================
// 通知
// ========================================
model Notification {
  id String @id @default(cuid())

  type      NotificationType
  title     String
  message   String           @db.Text
  severity  NotificationSeverity @default(INFO)

  // 関連データ
  productId String?
  listingId String?
  jobLogId  String?
  metadata  Json @default("{}")

  // ステータス
  isRead    Boolean  @default(false)
  readAt    DateTime?

  createdAt DateTime @default(now())

  @@index([isRead, createdAt])
  @@index([type])
  @@map("notifications")
}

enum NotificationType {
  SCRAPE_COMPLETE
  SCRAPE_FAILED
  TRANSLATE_COMPLETE
  TRANSLATE_FAILED
  IMAGE_COMPLETE
  IMAGE_FAILED
  PUBLISH_COMPLETE
  PUBLISH_FAILED
  OUT_OF_STOCK
  PRICE_CHANGE
  SYSTEM
  // 注文関連
  ORDER_RECEIVED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  ORDER_REFUNDED
  ORDER_DISPUTE
}

enum NotificationSeverity {
  INFO
  WARNING
  ERROR
  SUCCESS
}

// ========================================
// 通知チャンネル設定
// ========================================
model NotificationChannel {
  id String @id @default(cuid())

  channel NotificationChannelType
  name    String // チャンネル名（例: "メイン Slack", "緊急用 LINE"）

  // 認証情報
  webhookUrl String? // Slack, Discord
  token      String? // LINE Notify
  email      String? // メールアドレス（EMAIL チャンネル用）

  // SMTP設定（EMAIL チャンネル用、環境変数のオーバーライド）
  smtpHost   String?
  smtpPort   Int?
  smtpUser   String?
  smtpPass   String?
  smtpSecure Boolean @default(true)

  // 通知設定
  enabledTypes NotificationChannelEventType[] // 有効な通知タイプ
  minSeverity  NotificationSeverity @default(INFO) // 最低重要度

  // マーケットプレイスフィルター（Phase 45）
  // 空配列 = 全マーケットプレイスの通知を受信
  // 特定のマーケットプレイスのみ = そのマーケットの通知のみ受信
  marketplaceFilter Marketplace[] @default([])

  // 状態
  isActive     Boolean   @default(true)
  lastUsedAt   DateTime?
  lastError    String?
  errorCount   Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channel, isActive])
  @@map("notification_channels")
}

enum NotificationChannelType {
  SLACK
  DISCORD
  LINE
  EMAIL
}

enum NotificationChannelEventType {
  // ジョブ関連
  JOB_COMPLETE
  JOB_FAILED
  // 注文関連
  ORDER_RECEIVED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_CANCELLED
  ORDER_REFUNDED
  // 在庫関連
  OUT_OF_STOCK
  PRICE_CHANGE
  INVENTORY_LOW
  // 出品関連
  LISTING_PUBLISHED
  LISTING_ERROR
  LISTING_SOLD
  // システム
  DAILY_REPORT
  SYSTEM_ERROR
  EXCHANGE_RATE
}

// ========================================
// 注文管理
// ========================================
model Order {
  id String @id @default(cuid())

  // マーケットプレイス情報
  marketplace        Marketplace
  marketplaceOrderId String // eBay/Joomの注文ID

  // 購入者情報
  buyerUsername String
  buyerEmail    String?
  buyerName     String?

  // 配送先住所
  shippingAddress Json // { street, city, state, postalCode, country }

  // 金額情報
  subtotal     Float // 商品小計
  shippingCost Float // 送料
  tax          Float @default(0) // 税金
  total        Float // 合計金額
  currency     String @default("USD")

  // マーケット手数料
  marketplaceFee Float @default(0)
  paymentFee     Float @default(0)

  // ステータス
  status        OrderStatus     @default(PENDING)
  paymentStatus PaymentStatus   @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)

  // 追跡情報
  trackingNumber  String?
  trackingCarrier String?
  shippedAt       DateTime?

  // 生データ（デバッグ・参照用）
  rawData Json @default("{}")

  // タイムスタンプ
  orderedAt DateTime // マーケットプレイスでの注文日時
  paidAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 関連
  sales Sale[]

  @@unique([marketplace, marketplaceOrderId])
  @@index([status])
  @@index([marketplace, orderedAt])
  @@index([buyerUsername])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  DISPUTE
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  RETURNED
}

// ========================================
// 売上明細
// ========================================
model Sale {
  id String @id @default(cuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id])
  productId String?

  // 商品情報
  sku          String
  title        String
  quantity     Int    @default(1)
  unitPrice    Float
  totalPrice   Float

  // 利益計算
  costPrice    Float? // 仕入価格（円）
  profitJpy    Float? // 利益（円）
  profitRate   Float? // 利益率（%）

  // マーケットプレイス商品ID
  marketplaceItemId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([listingId])
  @@index([productId])
  @@index([sku])
  @@map("sales")
}

// ========================================
// Webhookイベント（履歴・デバッグ用）
// ========================================
model WebhookEvent {
  id String @id @default(cuid())

  // ソース情報
  provider  String // EBAY, JOOM
  eventType String // ORDER_CREATED, PAYMENT_COMPLETE, etc.

  // ペイロード
  payload       Json
  headers       Json @default("{}")
  signature     String?

  // 処理状態（Phase 15強化）
  status           WebhookEventStatus @default(PENDING)
  processedAt      DateTime?
  errorMessage     String?            @db.Text
  retryCount       Int                @default(0)
  maxRetries       Int                @default(5)
  lastAttemptedAt  DateTime?
  nextRetryAt      DateTime?

  // 関連
  orderId   String?
  listingId String?

  // 生成されたメッセージ
  customerMessages CustomerMessage[]

  createdAt DateTime @default(now())

  @@index([provider, eventType])
  @@index([status])
  @@index([status, nextRetryAt])
  @@index([createdAt])
  @@map("webhook_events")
}

enum WebhookEventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  FATAL      // リトライ上限到達または回復不能エラー
  IGNORED
}

// ========================================
// アラートルール（Phase 26）
// ========================================
model AlertRule {
  id                 String   @id @default(cuid())
  name               String
  eventType          String
  conditions         Json     @default("[]")
  severity           String   @default("info")
  channels           String[]
  cooldownMinutes    Int      @default(30)
  batchWindowMinutes Int      @default(5)
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([eventType])
  @@index([isActive])
  @@map("alert_rules")
}

// ========================================
// アラートログ（Phase 26）
// ========================================
model AlertLog {
  id        String    @id @default(cuid())
  ruleId    String?
  eventType String
  severity  String
  title     String
  message   String    @db.Text
  metadata  Json?
  channels  String[]
  status    String    @default("pending")
  batchId   String?
  sentAt    DateTime?
  errorMsg  String?
  createdAt DateTime  @default(now())

  @@index([eventType, createdAt])
  @@index([status])
  @@index([batchId])
  @@map("alert_logs")
}

// ========================================
// スケジュールレポート（Phase 32）
// ========================================
model ScheduledReport {
  id        String @id @default(cuid())
  name      String
  reportType String // 'daily' | 'weekly' | 'monthly' | 'custom'

  // スケジュール設定
  cronExpression String           // cron式（例: "0 9 * * *" = 毎日9時）
  timezone       String @default("Asia/Tokyo")
  isActive       Boolean @default(true)

  // レポート設定
  format        String @default("markdown") // 'json' | 'markdown' | 'csv'
  includeCharts Boolean @default(false)
  customQuery   Json?  // カスタムフィルター条件

  // 配信設定
  deliveryChannels String[] // チャンネルID or 'email:xxx@example.com'
  emailRecipients  String[] // メールアドレス
  emailSubject     String?

  // 実行履歴
  lastRunAt      DateTime?
  lastRunStatus  String?   // 'success' | 'failed'
  lastRunError   String?
  nextRunAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, nextRunAt])
  @@index([reportType])
  @@map("scheduled_reports")
}

// スケジュールレポート実行ログ
model ScheduledReportLog {
  id        String   @id @default(cuid())
  reportId  String
  status    String   // 'running' | 'success' | 'failed'
  startedAt DateTime @default(now())
  endedAt   DateTime?
  duration  Int?     // 実行時間（ミリ秒）
  error     String?
  metadata  Json?    // 結果サマリーなど

  @@index([reportId, startedAt])
  @@map("scheduled_report_logs")
}

// ========================================
// 価格履歴（Phase 28）
// ========================================
model PriceHistory {
  id         String   @id @default(cuid())
  listingId  String
  price      Float
  currency   String   @default("USD")
  source     String   // 'manual' | 'rule' | 'ai' | 'competitor' | 'initial'
  metadata   Json?    // 追加情報（変更理由など）
  recordedAt DateTime @default(now())

  @@index([listingId, recordedAt])
  @@index([recordedAt])
  @@map("price_histories")
}

// ========================================
// 競合価格ログ（Phase 28）
// ========================================
model CompetitorPriceLog {
  id                   String   @id @default(cuid())
  competitorIdentifier String   // 競合商品識別子（URL or ID）
  listingId            String?  // 関連する自社出品
  productId            String?  // 関連する自社商品
  marketplace          String   // 競合のマーケットプレイス
  price                Float
  currency             String   @default("USD")
  title                String?  // 競合商品タイトル
  url                  String?  // 競合商品URL
  metadata             Json?    // 追加データ
  recordedAt           DateTime @default(now())

  // Phase 29: 拡張フィールド
  conditionRank    String?  // コンディションランク (A/B/C/D/unknown)
  matchConfidence  Float?   // マッチング確度 (0-1)
  isVerified       Boolean  @default(false) // 人間による検証済み
  verifiedBy       String?  // 検証者
  verifiedAt       DateTime? // 検証日時
  sellerRating     Float?   // 出品者評価
  stockStatus      String?  // 在庫状態 (in_stock/low_stock/out_of_stock)
  shippingCost     Float?   // 送料
  priceChange      Float?   // 前回からの価格変動
  priceChangePercent Float? // 前回からの価格変動率

  // トラッカー参照
  trackerId        String?
  tracker          CompetitorTracker? @relation(fields: [trackerId], references: [id])

  @@index([listingId, recordedAt])
  @@index([productId, recordedAt])
  @@index([competitorIdentifier, recordedAt])
  @@index([recordedAt])
  @@index([trackerId])
  @@index([isVerified])
  @@map("competitor_price_logs")
}

// ========================================
// 競合トラッキング設定（Phase 29）
// ========================================
model CompetitorTracker {
  id                   String   @id @default(cuid())
  listingId            String?  // 関連する自社出品
  productId            String?  // 関連する自社商品
  competitorIdentifier String   // 競合商品識別子
  marketplace          String   // 競合のマーケットプレイス
  url                  String   // 競合商品URL
  title                String?  // 競合商品タイトル

  // マッチング情報
  matchMethod          String   @default("manual") // manual/keyword/barcode/ai
  matchConfidence      Float    @default(1.0) // マッチング確度
  isVerified           Boolean  @default(false) // 人間による検証済み
  verifiedBy           String?
  verifiedAt           DateTime?

  // トラッキング設定
  isActive             Boolean  @default(true)
  checkInterval        Int      @default(360) // チェック間隔（分）
  alertOnPriceDrop     Boolean  @default(true)
  alertOnPriceRise     Boolean  @default(false)
  alertThresholdPercent Float   @default(5.0) // アラート閾値（%）
  autoAdjustPrice      Boolean  @default(false) // 自動価格調整

  // 最終チェック情報
  lastPrice            Float?
  lastCheckedAt        DateTime?
  lastError            String?
  consecutiveErrors    Int      @default(0)

  // タイムスタンプ
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // リレーション
  priceLogs            CompetitorPriceLog[]

  @@unique([listingId, competitorIdentifier])
  @@index([listingId])
  @@index([productId])
  @@index([isActive])
  @@index([lastCheckedAt])
  @@map("competitor_trackers")
}

// ========================================
// 競合アラート（Phase 29）
// ========================================
model CompetitorAlert {
  id               String   @id @default(cuid())
  trackerId        String
  listingId        String?
  productId        String?

  // アラート内容
  alertType        String   // price_drop/price_rise/out_of_stock/new_competitor
  severity         String   @default("medium") // low/medium/high/critical
  title            String
  message          String   @db.Text

  // 価格情報
  ourPrice         Float?
  competitorPrice  Float?
  priceDiff        Float?
  priceDiffPercent Float?

  // ステータス
  status           String   @default("pending") // pending/acknowledged/resolved/dismissed
  acknowledgedBy   String?
  acknowledgedAt   DateTime?
  resolvedAt       DateTime?

  // メタデータ
  metadata         Json?
  createdAt        DateTime @default(now())

  @@index([listingId])
  @@index([productId])
  @@index([status])
  @@index([alertType])
  @@index([createdAt])
  @@map("competitor_alerts")
}

// ========================================
// 価格推奨（Phase 28）
// ========================================
model PriceRecommendation {
  id               String   @id @default(cuid())
  listingId        String
  productId        String?

  // 価格情報
  currentPrice     Float
  recommendedPrice Float
  minPrice         Float?   // ルールによる下限
  maxPrice         Float?   // ルールによる上限

  // 推奨の詳細
  confidence       Float    @default(0.5) // 0-1 信頼度
  reason           Json     // 推奨根拠（JSON）
  impact           Json?    // 影響試算（JSON）
  ruleId           String?  // 適用されたルールID

  // ステータス
  status           PriceRecommendationStatus @default(PENDING)
  expiresAt        DateTime

  // 処理履歴
  approvedBy       String?  // 承認者
  approvedAt       DateTime?
  appliedAt        DateTime?
  rejectedReason   String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([listingId, status])
  @@index([status, expiresAt])
  @@index([createdAt])
  @@map("price_recommendations")
}

enum PriceRecommendationStatus {
  PENDING    // 承認待ち
  APPROVED   // 承認済み（適用待ち）
  REJECTED   // 却下
  APPLIED    // 適用済み
  EXPIRED    // 期限切れ
  CANCELLED  // キャンセル
}

// ========================================
// 価格ルール（Phase 28）
// ========================================
model PricingRule {
  id          String   @id @default(cuid())
  name        String
  description String?

  // ルールタイプ
  type        PricingRuleType

  // ルール定義
  conditions  Json     // 適用条件（JSON配列）
  actions     Json     // アクション定義（JSON配列）

  // 適用範囲
  marketplace String?  // null = 全マーケットプレイス
  category    String?  // null = 全カテゴリ

  // 優先度と状態
  priority    Int      @default(0) // 高いほど優先
  isActive    Boolean  @default(true)

  // 安全設定
  safetyConfig Json?   // サーキットブレーカー設定

  // 統計
  appliedCount Int     @default(0)
  lastAppliedAt DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type, isActive])
  @@index([priority])
  @@map("pricing_rules")
}

enum PricingRuleType {
  COMPETITOR_FOLLOW  // 競合追従
  MIN_MARGIN         // 最低利益率維持
  MAX_DISCOUNT       // 最大値下げ制限
  DEMAND_BASED       // 需要ベース
  TIME_BASED         // 時間ベース（滞留日数など）
  CUSTOM             // カスタム
}

// ========================================
// 価格変更ログ（Phase 28）
// ========================================
model PriceChangeLog {
  id               String   @id @default(cuid())
  listingId        String
  recommendationId String?

  // 価格変更
  oldPrice         Float
  newPrice         Float
  currency         String   @default("USD")
  changePercent    Float    // 変更率（%）

  // 変更理由
  source           String   // 'manual' | 'rule' | 'ai' | 'auto'
  ruleId           String?
  reason           String?

  // プラットフォーム更新
  platformUpdated  Boolean  @default(false)
  platformError    String?

  createdAt        DateTime @default(now())

  @@index([listingId, createdAt])
  @@index([source, createdAt])
  @@map("price_change_logs")
}

// ========================================
// マーケットプレイス同期設定（Phase 44-B）
// ========================================
model MarketplaceSyncSetting {
  id             String    @id @default(cuid())
  marketplace    String    // 'JOOM' | 'EBAY'
  syncType       String    // 'INVENTORY' | 'ORDER' | 'PRICE'
  cronExpression String    // cron式
  isEnabled      Boolean   @default(true)
  lastRunAt      DateTime?
  nextRunAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([marketplace, syncType])
  @@index([isEnabled])
  @@map("marketplace_sync_settings")
}

// ========================================
// 在庫履歴（Phase 41）
// ========================================
model InventoryLog {
  id          String   @id @default(cuid())
  productId   String
  listingId   String?

  // 在庫・価格情報
  price       Int      // 仕入価格（円）
  stock       Int      @default(1) // 在庫数
  isAvailable Boolean  @default(true)

  // 変動検知
  priceChanged   Boolean @default(false)
  stockChanged   Boolean @default(false)
  previousPrice  Int?
  previousStock  Int?

  // メタデータ
  sourceUrl   String?
  checkedAt   DateTime @default(now())
  metadata    Json     @default("{}")

  @@index([productId, checkedAt])
  @@index([checkedAt])
  @@map("inventory_logs")
}

// ========================================
// 自動化判定用ログ（Phase 41）
// ========================================
model ShadowLog {
  id        String   @id @default(cuid())

  // サービス・操作
  service   String   // 'profit-guard' | 'order-processor' | 'inventory-sync'
  operation String   // 'check' | 'process' | 'decide'

  // 入力・出力
  input     Json     // 入力データ
  output    Json     // 出力データ（判定結果など）

  // 判定結果
  decision      String?  // 'approve' | 'reject' | 'hold'
  decisionReason String?
  isDryRun      Boolean  @default(true)

  // パフォーマンス
  durationMs    Int?

  createdAt DateTime @default(now())

  @@index([service, createdAt])
  @@index([decision, createdAt])
  @@map("shadow_logs")
}

// ========================================
// 利益率閾値設定（Phase 41）
// ========================================
model ProfitThreshold {
  id          String   @id @default(cuid())

  marketplace String   // 'JOOM' | 'EBAY' | 'ALL'
  category    String?  // カテゴリ（nullはデフォルト）

  // 閾値
  minProfitRate     Float @default(10)  // 最低利益率 (%)
  minProfitAmount   Int   @default(500) // 最低利益額（円）
  alertProfitRate   Float @default(15)  // アラート閾値 (%)

  // 設定
  isActive    Boolean  @default(true)
  isDryRun    Boolean  @default(true) // Dry Runモード

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([marketplace, category])
  @@map("profit_thresholds")
}

// ========================================
// 通知イベント（Phase 45+）
// ========================================
model NotificationEvent {
  id          String   @id @default(cuid())
  type        String   // ORDER_RECEIVED, PROFIT_ALERT, STOCK_OUT, etc.
  channel     String   // SLACK, DISCORD, WEBHOOK
  status      String   @default("PENDING") // PENDING, SENT, FAILED, ACTION_TAKEN
  payload     Json     // 通知内容
  referenceId String?  // 注文ID、商品IDなど
  referenceType String? // ORDER, PRODUCT, LISTING
  actionTaken String?  // 実行されたアクション
  actionBy    String?  // アクション実行者
  sentAt      DateTime?
  error       String?
  retryCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type, status])
  @@index([referenceId, referenceType])
  @@index([createdAt])
  @@map("notification_events")
}

// ========================================
// メッセージテンプレート（Phase 16）
// ========================================
model MessageTemplate {
  id          String   @id @default(cuid())

  // テンプレート識別
  name        String   @unique // テンプレート名（例: order_confirmation_en）
  description String?  // 説明

  // イベントトリガー
  triggerEvent MessageTriggerEvent // ORDER_CONFIRMED, SHIPPED, DELIVERED, etc.
  marketplace  Marketplace?        // null = 全マーケットプレイス

  // テンプレート内容
  language    String   @default("en") // en, ja, etc.
  subject     String   // 件名テンプレート
  body        String   @db.Text // 本文テンプレート（プレースホルダー対応）
  bodyHtml    String?  @db.Text // HTML版本文（オプション）

  // プレースホルダー定義
  // {{buyer_name}}, {{order_id}}, {{tracking_number}}, etc.
  placeholders String[] // 使用可能なプレースホルダー一覧

  // 設定
  isActive    Boolean  @default(true)
  priority    Int      @default(0) // 同一イベントで複数テンプレートがある場合の優先度

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  customerMessages CustomerMessage[]

  @@unique([triggerEvent, marketplace, language])
  @@index([triggerEvent, isActive])
  @@map("message_templates")
}

enum MessageTriggerEvent {
  ORDER_CONFIRMED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  ORDER_REFUNDED
  TRACKING_UPDATED
  CUSTOM
}

// ========================================
// 顧客メッセージ（Phase 16）
// ========================================
model CustomerMessage {
  id            String   @id @default(cuid())

  // 関連情報
  orderId       String?
  listingId     String?
  webhookEventId String?
  webhookEvent  WebhookEvent? @relation(fields: [webhookEventId], references: [id])

  templateId    String?
  template      MessageTemplate? @relation(fields: [templateId], references: [id])

  // 宛先情報
  marketplace   Marketplace
  buyerUsername String
  buyerEmail    String?

  // メッセージ内容（レンダリング済み）
  subject       String
  body          String   @db.Text
  bodyHtml      String?  @db.Text

  // 送信状態
  status        MessageStatus @default(PENDING)
  sendingAttempts Int         @default(0)
  maxAttempts   Int           @default(3)
  lastAttemptedAt DateTime?
  sentAt        DateTime?
  errorMessage  String?       @db.Text

  // マーケットプレイス応答
  marketplaceMessageId String? // 送信後のメッセージID
  marketplaceResponse Json?    // APIレスポンス

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([orderId])
  @@index([status])
  @@index([status, lastAttemptedAt])
  @@index([marketplace, buyerUsername])
  @@map("customer_messages")
}

enum MessageStatus {
  PENDING
  SENDING
  SENT
  FAILED
  FATAL  // リトライ上限到達または回復不能エラー
}

// ========================================
// 在庫アラート（Phase 17）
// ========================================
model InventoryAlert {
  id          String   @id @default(cuid())

  // 関連
  productId   String?
  listingId   String?
  listing     Listing? @relation(fields: [listingId], references: [id])

  // イベント情報
  alertType   InventoryAlertType
  severity    AlertSeverity      @default(MEDIUM)

  // 在庫状態（変動前後）
  previousStock     Int?
  currentStock      Int?
  previousAvailable Boolean?
  currentAvailable  Boolean?

  // 判定理由
  reason            String   @db.Text // 例: "在庫数が0になったため自動停止"
  thresholdUsed     Int?              // 判定に使用した閾値

  // アクション
  actionTaken       InventoryAlertAction?
  actionDetails     Json?             // 詳細情報（遅延時間等）

  // 通知
  notificationSent  Boolean  @default(false)
  notificationId    String?  // 送信した通知のID

  // 抑制情報
  suppressed        Boolean  @default(false) // スパム抑制でスキップ
  suppressReason    String?

  createdAt         DateTime @default(now())

  @@index([productId, createdAt])
  @@index([listingId, createdAt])
  @@index([alertType, createdAt])
  @@index([actionTaken, createdAt])
  @@map("inventory_alerts")
}

enum InventoryAlertType {
  STOCK_OUT           // 在庫切れ
  STOCK_LOW           // 在庫僅少
  STOCK_RECOVERED     // 在庫復活
  LISTING_PAUSED      // リスティング停止
  LISTING_RESUMED     // リスティング再開
  PRICE_CHANGED       // 価格変動
  AVAILABILITY_CHANGED // 販売状態変更
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum InventoryAlertAction {
  PAUSE_LISTING       // リスティング停止
  RESUME_LISTING      // リスティング再開
  SCHEDULE_RESUME     // 遅延再開スケジュール
  NOTIFY_ONLY         // 通知のみ
  NONE                // アクションなし
}

// ========================================
// 売上サマリー（Phase 18）
// ========================================
model SalesSummary {
  id            String   @id @default(cuid())

  // 集計期間
  periodType    SalesPeriodType  // DAILY, WEEKLY, MONTHLY
  periodStart   DateTime
  periodEnd     DateTime

  // フィルター条件
  marketplace   Marketplace?     // null = 全マーケットプレイス
  category      String?          // null = 全カテゴリ

  // 売上サマリー
  orderCount    Int      @default(0)
  itemCount     Int      @default(0)  // 販売数量
  grossRevenue  Float    @default(0)  // 売上総額（USD）
  shippingTotal Float    @default(0)  // 送料総額
  feeTotal      Float    @default(0)  // 手数料総額
  netRevenue    Float    @default(0)  // 純売上

  // 利益サマリー（原価データがある場合）
  costTotal     Float?           // 仕入総額（円）
  profitTotal   Float?           // 利益総額（円）
  profitRate    Float?           // 利益率（%）

  // ベストセラー（JSON）
  topProducts   Json     @default("[]") // [{productId, title, quantity, revenue}]
  topCategories Json     @default("[]") // [{category, quantity, revenue}]

  // メタデータ
  calculatedAt  DateTime @default(now())
  isComplete    Boolean  @default(false) // 集計完了フラグ

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([periodType, periodStart, marketplace, category])
  @@index([periodType, periodStart])
  @@index([marketplace, periodStart])
  @@map("sales_summaries")
}

enum SalesPeriodType {
  DAILY
  WEEKLY
  MONTHLY
}

// ========================================
// Phase 19: データエクスポート
// ========================================

model ExportJob {
  id            String   @id @default(cuid())

  // エクスポート種別
  exportType    ExportType
  format        ExportFormat   @default(CSV)

  // フィルター条件
  filters       Json     @default("{}")  // {startDate, endDate, marketplace, status, etc.}

  // 実行状態
  status        ExportJobStatus @default(PENDING)
  progress      Int      @default(0)     // 0-100
  totalRows     Int?
  processedRows Int      @default(0)

  // ファイル情報
  fileName      String?
  filePath      String?              // S3/ローカルパス
  fileSize      Int?                 // bytes
  downloadUrl   String?              // 署名付きURL
  expiresAt     DateTime?            // ダウンロード期限

  // エラー情報
  errorMessage  String?  @db.Text

  // スケジュール設定（定期エクスポート用）
  isScheduled   Boolean  @default(false)
  cronExpression String?
  nextRunAt     DateTime?

  // メタデータ
  requestedBy   String?              // ユーザーID/APIキー
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([exportType, status])
  @@index([status, createdAt])
  @@index([isScheduled, nextRunAt])
  @@map("export_jobs")
}

enum ExportType {
  ORDERS           // 注文データ
  PRODUCTS         // 商品データ
  LISTINGS         // 出品データ
  SALES_SUMMARY    // 売上サマリー
  INVENTORY        // 在庫データ
  AUDIT_LOG        // 監査ログ
  CUSTOMER_MESSAGES // 顧客メッセージ
}

enum ExportFormat {
  CSV
  EXCEL
  JSON
}

enum ExportJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ========================================
// Phase 20: 監査ログ
// ========================================

model AuditLog {
  id            String   @id @default(cuid())

  // 操作者情報
  actorType     ActorType        // USER, SYSTEM, API, WEBHOOK
  actorId       String?          // ユーザーID or APIキーID
  actorName     String?          // 表示名
  ipAddress     String?

  // 操作対象
  entityType    AuditEntityType  // PRODUCT, LISTING, ORDER, etc.
  entityId      String?          // 対象のID
  entityName    String?          // 対象の名前（検索用）

  // 操作内容
  action        AuditAction      // CREATE, UPDATE, DELETE, etc.
  description   String   @db.Text // 操作の説明

  // 変更内容
  previousValue Json?            // 変更前の値
  newValue      Json?            // 変更後の値
  changedFields String[]         // 変更されたフィールド名

  // メタデータ
  metadata      Json     @default("{}")  // 追加情報（リクエストID、ユーザーエージェント等）
  severity      AuditSeverity @default(INFO)

  createdAt     DateTime @default(now())

  @@index([entityType, entityId])
  @@index([actorType, actorId])
  @@index([action, createdAt])
  @@index([severity, createdAt])
  @@index([createdAt])
  @@map("audit_logs")
}

enum ActorType {
  USER
  SYSTEM
  API
  WEBHOOK
  SCHEDULER
}

enum AuditEntityType {
  PRODUCT
  LISTING
  ORDER
  SALE
  INVENTORY_ALERT
  WEBHOOK_EVENT
  CUSTOMER_MESSAGE
  PRICE_RECOMMENDATION
  EXPORT_JOB
  SETTINGS
  MARKETPLACE_CREDENTIAL
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  PUBLISH
  UNPUBLISH
  PAUSE
  RESUME
  APPROVE
  REJECT
  EXPORT
  IMPORT
  SYNC
  SEND
  LOGIN
  LOGOUT
}

enum AuditSeverity {
  DEBUG
  INFO
  WARNING
  ERROR
  CRITICAL
}

// ========================================
// Phase 21: システム設定管理
// ========================================

model SystemSetting {
  id            String   @id @default(cuid())

  // 設定キー（ユニーク）
  key           String   @unique
  category      SettingCategory  @default(GENERAL)

  // 設定値
  value         String   @db.Text
  valueType     SettingValueType @default(STRING)
  defaultValue  String?  @db.Text

  // メタデータ
  label         String?          // 表示名
  description   String?  @db.Text // 説明
  isSecret      Boolean  @default(false)  // シークレット値（マスク表示）
  isReadOnly    Boolean  @default(false)  // 読み取り専用
  validationRule String?          // バリデーションルール（JSON Schema等）

  // 変更履歴
  version       Int      @default(1)
  lastChangedBy String?
  lastChangedAt DateTime @default(now())

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 設定履歴
  history       SettingHistory[]

  @@index([category])
  @@index([key])
  @@map("system_settings")
}

model SettingHistory {
  id            String   @id @default(cuid())

  settingId     String
  setting       SystemSetting @relation(fields: [settingId], references: [id], onDelete: Cascade)

  // 変更内容
  previousValue String?  @db.Text
  newValue      String   @db.Text
  version       Int

  // 変更者
  changedBy     String?
  changedAt     DateTime @default(now())
  changeReason  String?

  @@index([settingId, changedAt])
  @@map("setting_histories")
}

enum SettingCategory {
  GENERAL        // 一般設定
  SCHEDULER      // スケジューラー設定
  NOTIFICATION   // 通知設定
  MARKETPLACE    // マーケットプレイス設定
  PRICING        // 価格設定
  INVENTORY      // 在庫設定
  EXPORT         // エクスポート設定
  SECURITY       // セキュリティ設定
  INTEGRATION    // 外部連携設定
}

enum SettingValueType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  ARRAY
  SECRET
}

// ========================================
// Phase 22: API使用量・レート制限管理
// ========================================

model ApiKey {
  id            String   @id @default(cuid())

  // キー情報
  name          String           // キー名
  keyHash       String   @unique // ハッシュ化されたAPIキー
  keyPrefix     String           // キーの先頭部分（表示用）

  // 権限
  permissions   String[]         // 許可されたエンドポイント/操作
  rateLimit     Int      @default(1000)  // 1時間あたりのリクエスト上限
  dailyLimit    Int?             // 1日あたりのリクエスト上限

  // ステータス
  isActive      Boolean  @default(true)
  expiresAt     DateTime?

  // メタデータ
  description   String?
  createdBy     String?
  lastUsedAt    DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 使用量記録
  usageLogs     ApiUsageLog[]

  @@index([keyHash])
  @@index([isActive, expiresAt])
  @@map("api_keys")
}

model ApiUsageLog {
  id            String   @id @default(cuid())

  // APIキー（nullの場合は認証なしリクエスト）
  apiKeyId      String?
  apiKey        ApiKey?  @relation(fields: [apiKeyId], references: [id])

  // リクエスト情報
  endpoint      String           // エンドポイントパス
  method        String           // HTTP メソッド
  statusCode    Int              // レスポンスステータス
  responseTime  Int              // レスポンス時間（ミリ秒）

  // クライアント情報
  ipAddress     String?
  userAgent     String?

  // 使用量
  requestSize   Int?             // リクエストサイズ（bytes）
  responseSize  Int?             // レスポンスサイズ（bytes）

  // エラー情報
  errorCode     String?
  errorMessage  String?

  createdAt     DateTime @default(now())

  @@index([apiKeyId, createdAt])
  @@index([endpoint, createdAt])
  @@index([createdAt])
  @@map("api_usage_logs")
}

model RateLimitRecord {
  id            String   @id @default(cuid())

  // 識別子（APIキーID or IPアドレス）
  identifier    String
  identifierType RateLimitIdentifierType

  // カウンター
  windowStart   DateTime         // ウィンドウ開始時刻
  windowSize    Int              // ウィンドウサイズ（秒）
  requestCount  Int      @default(0)

  // 制限情報
  isBlocked     Boolean  @default(false)
  blockedUntil  DateTime?
  blockReason   String?

  updatedAt     DateTime @updatedAt

  @@unique([identifier, windowStart])
  @@index([identifier, windowStart])
  @@index([isBlocked, blockedUntil])
  @@map("rate_limit_records")
}

model ApiUsageSummary {
  id            String   @id @default(cuid())

  // 集計期間
  periodType    UsagePeriodType  // HOURLY, DAILY, MONTHLY
  periodStart   DateTime
  periodEnd     DateTime

  // 対象
  apiKeyId      String?          // null = 全体
  endpoint      String?          // null = 全エンドポイント

  // 統計
  totalRequests Int      @default(0)
  successCount  Int      @default(0)
  errorCount    Int      @default(0)
  avgResponseTime Float?
  maxResponseTime Int?
  totalRequestSize  BigInt?
  totalResponseSize BigInt?

  // 上位エンドポイント
  topEndpoints  Json     @default("[]")

  calculatedAt  DateTime @default(now())

  @@unique([periodType, periodStart, apiKeyId, endpoint])
  @@index([periodType, periodStart])
  @@index([apiKeyId, periodStart])
  @@map("api_usage_summaries")
}

enum RateLimitIdentifierType {
  API_KEY
  IP_ADDRESS
  USER_ID
}

enum UsagePeriodType {
  HOURLY
  DAILY
  MONTHLY
}

// ========================================
// Phase 23: ユーザー管理/RBAC
// ========================================

model User {
  id            String   @id @default(cuid())

  // 認証情報
  email         String   @unique
  passwordHash  String?          // nullの場合はOAuth専用
  emailVerified Boolean  @default(false)
  emailVerifiedAt DateTime?

  // プロフィール
  name          String?
  avatar        String?

  // ステータス
  status        UserStatus @default(ACTIVE)
  lastLoginAt   DateTime?
  lastLoginIp   String?

  // 二要素認証
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  // リレーション
  roles         UserRole[]
  sessions      UserSession[]
  apiKeys       UserApiKey[]
  auditLogs     UserAuditLog[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@map("users")
}

model Role {
  id            String   @id @default(cuid())

  // ロール情報
  name          String   @unique
  displayName   String
  description   String?

  // 権限
  permissions   Permission[]

  // システムロール（削除不可）
  isSystem      Boolean  @default(false)

  // リレーション
  users         UserRole[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([name])
  @@map("roles")
}

model Permission {
  id            String   @id @default(cuid())

  // 権限情報
  resource      String           // 対象リソース（products, orders, etc.）
  action        PermissionAction // 操作種別

  // リレーション
  roleId        String
  role          Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())

  @@unique([roleId, resource, action])
  @@index([resource, action])
  @@map("permissions")
}

model UserRole {
  id            String   @id @default(cuid())

  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  roleId        String
  role          Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  // 付与情報
  grantedBy     String?
  grantedAt     DateTime @default(now())
  expiresAt     DateTime?        // 期限付きロール

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model UserSession {
  id            String   @id @default(cuid())

  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // セッション情報
  token         String   @unique
  refreshToken  String?  @unique
  userAgent     String?
  ipAddress     String?

  // 有効期限
  expiresAt     DateTime
  refreshExpiresAt DateTime?

  // ステータス
  isActive      Boolean  @default(true)
  revokedAt     DateTime?
  revokedReason String?

  createdAt     DateTime @default(now())
  lastUsedAt    DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([isActive, expiresAt])
  @@map("user_sessions")
}

model UserApiKey {
  id            String   @id @default(cuid())

  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // キー情報
  name          String
  keyHash       String   @unique
  keyPrefix     String

  // 権限（ユーザーの権限をオーバーライド）
  scopes        String[]         // 許可されたスコープ
  permissions   Json     @default("[]") // カスタム権限

  // ステータス
  isActive      Boolean  @default(true)
  expiresAt     DateTime?
  lastUsedAt    DateTime?

  // 使用制限
  rateLimit     Int      @default(1000)
  dailyLimit    Int?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([keyHash])
  @@map("user_api_keys")
}

model UserAuditLog {
  id            String   @id @default(cuid())

  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 操作情報
  action        String           // login, logout, password_change, etc.
  description   String   @db.Text

  // コンテキスト
  ipAddress     String?
  userAgent     String?
  metadata      Json     @default("{}")

  // 結果
  success       Boolean  @default(true)
  errorMessage  String?

  createdAt     DateTime @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@map("user_audit_logs")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  MANAGE      // 全権限
  EXPORT
  IMPORT
  APPROVE
  PUBLISH
}

// ========================================
// Phase 24: Webhook管理の強化
// ========================================

model WebhookEndpoint {
  id            String   @id @default(cuid())

  // エンドポイント情報
  name          String
  url           String
  description   String?

  // 認証設定
  authType      WebhookAuthType @default(NONE)
  authConfig    Json     @default("{}")  // {secret, header, token, etc.}

  // 署名設定
  signatureEnabled Boolean @default(true)
  signatureSecret  String?         // HMAC署名用シークレット
  signatureHeader  String  @default("X-Webhook-Signature")
  signatureAlgorithm String @default("sha256")

  // イベント設定
  events        WebhookEventType[]
  filters       Json     @default("{}")  // イベントフィルター条件

  // リトライ設定
  retryEnabled  Boolean  @default(true)
  maxRetries    Int      @default(5)
  retryDelayMs  Int      @default(1000)
  retryBackoffMultiplier Float @default(2.0)

  // タイムアウト
  timeoutMs     Int      @default(30000)

  // ステータス
  isActive      Boolean  @default(true)
  lastDeliveryAt DateTime?
  lastDeliveryStatus String?
  consecutiveFailures Int @default(0)
  disabledAt    DateTime?
  disabledReason String?

  // 統計
  totalDeliveries Int     @default(0)
  successfulDeliveries Int @default(0)
  failedDeliveries Int    @default(0)

  // リレーション
  deliveries    WebhookDelivery[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isActive])
  @@index([events])
  @@map("webhook_endpoints")
}

model WebhookDelivery {
  id            String   @id @default(cuid())

  endpointId    String
  endpoint      WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  // イベント情報
  eventType     String
  eventId       String?          // 元イベントのID
  payload       Json

  // リクエスト情報
  requestHeaders Json    @default("{}")
  requestBody   String   @db.Text

  // レスポンス情報
  responseStatus Int?
  responseHeaders Json?
  responseBody  String?  @db.Text
  responseTimeMs Int?

  // 配信状態
  status        WebhookDeliveryStatus @default(PENDING)
  attemptCount  Int      @default(0)
  maxAttempts   Int      @default(5)
  nextRetryAt   DateTime?

  // エラー情報
  errorType     String?          // timeout, connection_error, http_error, etc.
  errorMessage  String?  @db.Text

  // 署名
  signature     String?

  deliveredAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([endpointId, createdAt])
  @@index([status, nextRetryAt])
  @@index([eventType, createdAt])
  @@map("webhook_deliveries")
}

model WebhookSecret {
  id            String   @id @default(cuid())

  // プロバイダー情報
  provider      String   @unique  // EBAY, JOOM, STRIPE, etc.

  // シークレット情報
  secret        String           // 署名検証用シークレット
  algorithm     String   @default("sha256")
  headerName    String   @default("X-Webhook-Signature")

  // 検証設定
  verifyTimestamp Boolean @default(true)
  timestampToleranceSeconds Int @default(300)

  // ステータス
  isActive      Boolean  @default(true)
  lastVerifiedAt DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([provider])
  @@map("webhook_secrets")
}

enum WebhookAuthType {
  NONE
  BASIC
  BEARER
  API_KEY
  HMAC
  CUSTOM
}

enum WebhookEventType {
  // 注文関連
  ORDER_CREATED
  ORDER_UPDATED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  ORDER_REFUNDED
  // 商品関連
  PRODUCT_CREATED
  PRODUCT_UPDATED
  PRODUCT_DELETED
  // 出品関連
  LISTING_PUBLISHED
  LISTING_UPDATED
  LISTING_ENDED
  LISTING_SOLD
  // 在庫関連
  INVENTORY_LOW
  INVENTORY_OUT
  INVENTORY_UPDATED
  // 価格関連
  PRICE_CHANGED
  PRICE_RECOMMENDATION
  // システム関連
  SYSTEM_ERROR
  SYSTEM_ALERT
}

enum WebhookDeliveryStatus {
  PENDING
  SENDING
  DELIVERED
  FAILED
  RETRYING
  EXHAUSTED    // リトライ上限到達
}
