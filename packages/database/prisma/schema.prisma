// Prisma Schema for Auto Listing System
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// 仕入元情報
// ========================================
model Source {
  id        String     @id @default(cuid())
  type      SourceType
  name      String
  url       String?
  isActive  Boolean    @default(true)
  metadata  Json       @default("{}")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  products Product[]

  @@map("sources")
}

enum SourceType {
  MERCARI
  YAHOO_AUCTION
  YAHOO_FLEA
  RAKUMA
  RAKUTEN
  AMAZON
  TAKAYAMA
  JOSHIN
  OTHER
}

// ========================================
// 統一商品モデル
// ========================================
model Product {
  id String @id @default(cuid())

  // ソース情報
  sourceId     String
  source       Source @relation(fields: [sourceId], references: [id])
  sourceItemId String // 元サイトの商品ID
  sourceUrl    String
  sourceHash   String? // 差分検知用ハッシュ

  // 基本情報（原文）
  title       String
  description String @db.Text
  price       Int // 仕入価格（円）

  // 翻訳済み情報
  titleEn       String?
  descriptionEn String? @db.Text

  // 商品属性
  category   String?
  brand      String?
  condition  String?
  weight     Int? // グラム
  attributes Json   @default("{}") // AI抽出属性

  // 画像
  images          String[] // 元画像URL
  processedImages String[] // 白抜き後URL（MinIO/S3）

  // セラー情報
  sellerId   String?
  sellerName String?

  // ステータス
  status            ProductStatus @default(PENDING_SCRAPE)
  translationStatus ProcessStatus @default(PENDING)
  imageStatus       ProcessStatus @default(PENDING)
  lastError         String?       @db.Text

  // タイムスタンプ
  scrapedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  listings Listing[]
  jobLogs  JobLog[]

  @@unique([sourceId, sourceItemId])
  @@index([status])
  @@index([sourceHash])
  @@index([createdAt])
  @@map("products")
}

enum ProductStatus {
  PENDING_SCRAPE
  SCRAPED
  PROCESSING_IMAGES
  TRANSLATING
  READY_TO_REVIEW
  APPROVED
  PUBLISHING
  ACTIVE
  SOLD
  OUT_OF_STOCK
  ERROR
  DELETED
}

enum ProcessStatus {
  PENDING
  PROCESSING
  COMPLETED
  ERROR
}

// ========================================
// 出品情報（マーケットプレイス別）
// ========================================
model Listing {
  id String @id @default(cuid())

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  marketplace          Marketplace
  marketplaceListingId String? // eBay/Joom の出品ID

  // 価格情報
  listingPrice Float // 出品価格（USD）
  shippingCost Float? // 送料
  currency     String @default("USD")

  // マーケット固有データ（JSONB）
  marketplaceData Json @default("{}")

  // ステータス
  status       ListingStatus @default(DRAFT)
  errorMessage String?       @db.Text

  // タイムスタンプ
  listedAt  DateTime?
  soldAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([productId, marketplace])
  @@index([marketplace, status])
  @@index([marketplaceListingId])
  @@map("listings")
}

enum Marketplace {
  JOOM
  EBAY
}

enum ListingStatus {
  DRAFT
  PENDING_PUBLISH
  PUBLISHING
  ACTIVE
  PAUSED
  SOLD
  ENDED
  ERROR
}

// ========================================
// ジョブログ
// ========================================
model JobLog {
  id String @id @default(cuid())

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  jobId        String // BullMQ Job ID
  queueName    String
  jobType      String
  status       JobStatus
  payload      Json      @default("{}")
  result       Json?
  errorMessage String?   @db.Text

  startedAt   DateTime
  completedAt DateTime?
  duration    Int? // ミリ秒

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([queueName, status])
  @@index([createdAt])
  @@index([jobId])
  @@map("job_logs")
}

enum JobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  DEAD_LETTER
}

// ========================================
// 価格計算設定
// ========================================
model PriceSetting {
  id String @id @default(cuid())

  name        String      @unique
  marketplace Marketplace

  // 手数料
  platformFeeRate Float // プラットフォーム手数料率
  paymentFeeRate  Float // 決済手数料率

  // マージン
  targetProfitRate Float // 目標利益率
  adRate           Float @default(0) // 広告費率

  // 為替
  exchangeRate   Float // USD/JPY
  exchangeBuffer Float @default(0) // 為替バッファ

  // カテゴリ別設定（オプション）
  categorySettings Json @default("{}")

  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("price_settings")
}

// ========================================
// eBay シッピングポリシー
// ========================================
model ShippingPolicy {
  id String @id @default(cuid())

  name   String
  region String // US, EU, ASIA など

  // 配送方法
  carrier String // ePacket, Cpass, EMS など

  // 送料テーブル（重量別）
  shippingTable Json // { "100": 880, "200": 1060, ... }

  // 燃油サーチャージ
  fuelSurcharge Float @default(0)

  // 関税設定
  dutyThreshold Float? // 関税閾値（USD）
  dutyRate      Float? // 関税率

  // 追加設定
  handlingTime Int    @default(1) // 発送準備日数
  metadata     Json   @default("{}")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([region, carrier])
  @@map("shipping_policies")
}

// ========================================
// 為替レート履歴
// ========================================
model ExchangeRate {
  id String @id @default(cuid())

  fromCurrency String @default("JPY")
  toCurrency   String @default("USD")
  rate         Float

  fetchedAt DateTime @default(now())
  source    String   @default("manual") // manual, api, etc.

  @@index([fromCurrency, toCurrency, fetchedAt])
  @@map("exchange_rates")
}

// ========================================
// 翻訳プロンプト設定
// ========================================
model TranslationPrompt {
  id String @id @default(cuid())

  name        String  @unique // プロンプト名
  category    String? // 対象カテゴリ（nullはデフォルト）
  marketplace String? // joom, ebay, null=共通

  // プロンプト内容
  systemPrompt String @db.Text // システムプロンプト
  userPrompt   String @db.Text // ユーザープロンプトテンプレート

  // 抽出する属性
  extractAttributes String[] // ["brand", "model", "color", ...]

  // 追加指示
  additionalInstructions String? @db.Text
  seoKeywords            String[] // SEO推奨ワード

  // 設定
  priority  Int     @default(0) // 優先度（高いほど優先）
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  templates ListingTemplate[]

  @@index([category, marketplace])
  @@map("translation_prompts")
}

// ========================================
// eBay カテゴリマッピング
// ========================================
model EbayCategoryMapping {
  id String @id @default(cuid())

  sourceCategory String // 元カテゴリ（日本語）
  ebayCategoryId String // eBayカテゴリID
  ebayCategoryName String // eBayカテゴリ名

  // Item Specifics テンプレート
  itemSpecifics Json @default("{}")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  templates ListingTemplate[]

  @@unique([sourceCategory])
  @@map("ebay_category_mappings")
}

// ========================================
// 出品テンプレート
// ========================================
model ListingTemplate {
  id String @id @default(cuid())

  name        String @unique // テンプレート名
  description String? // 説明

  // カテゴリマッピングへの参照
  categoryMappingId String?
  categoryMapping   EbayCategoryMapping? @relation(fields: [categoryMappingId], references: [id])

  // 翻訳プロンプトへの参照
  translationPromptId String?
  translationPrompt   TranslationPrompt? @relation(fields: [translationPromptId], references: [id])

  // 価格設定
  profitRate Float @default(30) // 目標利益率 (%)
  minProfit  Float @default(500) // 最低利益額 (円)

  // 出品設定
  titleTemplate       String? @db.Text // タイトルテンプレート
  descriptionTemplate String? @db.Text // 説明文テンプレート
  conditionMapping    Json    @default("{}") // コンディション変換マップ

  // デフォルト値
  defaultWeight       Int?    // デフォルト重量 (g)
  defaultShippingDays String? // 配送日数

  // 設定
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryMappingId])
  @@map("listing_templates")
}

// ========================================
// マーケットプレイス認証情報
// ========================================
model MarketplaceCredential {
  id String @id @default(cuid())

  marketplace Marketplace
  name        String      @default("default") // アカウント名

  // 認証情報（暗号化推奨）
  credentials Json // { clientId, clientSecret, accessToken, refreshToken, ... }

  // トークン有効期限
  tokenExpiresAt        DateTime?
  refreshTokenExpiresAt DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([marketplace, name])
  @@index([marketplace, isActive])
  @@map("marketplace_credentials")
}

// ========================================
// OAuth状態管理（CSRF対策）
// ========================================
model OAuthState {
  id String @id @default(cuid())

  state     String   @unique
  provider  String // EBAY, JOOM, etc.
  expiresAt DateTime
  metadata  Json     @default("{}")

  createdAt DateTime @default(now())

  @@index([provider, expiresAt])
  @@map("oauth_states")
}

// ========================================
// 通知
// ========================================
model Notification {
  id String @id @default(cuid())

  type      NotificationType
  title     String
  message   String           @db.Text
  severity  NotificationSeverity @default(INFO)

  // 関連データ
  productId String?
  listingId String?
  jobLogId  String?
  metadata  Json @default("{}")

  // ステータス
  isRead    Boolean  @default(false)
  readAt    DateTime?

  createdAt DateTime @default(now())

  @@index([isRead, createdAt])
  @@index([type])
  @@map("notifications")
}

enum NotificationType {
  SCRAPE_COMPLETE
  SCRAPE_FAILED
  TRANSLATE_COMPLETE
  TRANSLATE_FAILED
  IMAGE_COMPLETE
  IMAGE_FAILED
  PUBLISH_COMPLETE
  PUBLISH_FAILED
  OUT_OF_STOCK
  PRICE_CHANGE
  SYSTEM
  // 注文関連
  ORDER_RECEIVED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  ORDER_REFUNDED
  ORDER_DISPUTE
}

enum NotificationSeverity {
  INFO
  WARNING
  ERROR
  SUCCESS
}

// ========================================
// 通知チャンネル設定
// ========================================
model NotificationChannel {
  id String @id @default(cuid())

  channel NotificationChannelType
  name    String // チャンネル名（例: "メイン Slack", "緊急用 LINE"）

  // 認証情報
  webhookUrl String? // Slack, Discord
  token      String? // LINE Notify
  email      String? // メールアドレス（EMAIL チャンネル用）

  // SMTP設定（EMAIL チャンネル用、環境変数のオーバーライド）
  smtpHost   String?
  smtpPort   Int?
  smtpUser   String?
  smtpPass   String?
  smtpSecure Boolean @default(true)

  // 通知設定
  enabledTypes NotificationChannelEventType[] // 有効な通知タイプ
  minSeverity  NotificationSeverity @default(INFO) // 最低重要度

  // マーケットプレイスフィルター（Phase 45）
  // 空配列 = 全マーケットプレイスの通知を受信
  // 特定のマーケットプレイスのみ = そのマーケットの通知のみ受信
  marketplaceFilter Marketplace[] @default([])

  // 状態
  isActive     Boolean   @default(true)
  lastUsedAt   DateTime?
  lastError    String?
  errorCount   Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channel, isActive])
  @@map("notification_channels")
}

enum NotificationChannelType {
  SLACK
  DISCORD
  LINE
  EMAIL
}

enum NotificationChannelEventType {
  // ジョブ関連
  JOB_COMPLETE
  JOB_FAILED
  // 注文関連
  ORDER_RECEIVED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_CANCELLED
  ORDER_REFUNDED
  // 在庫関連
  OUT_OF_STOCK
  PRICE_CHANGE
  INVENTORY_LOW
  // 出品関連
  LISTING_PUBLISHED
  LISTING_ERROR
  LISTING_SOLD
  // システム
  DAILY_REPORT
  SYSTEM_ERROR
  EXCHANGE_RATE
}

// ========================================
// 注文管理
// ========================================
model Order {
  id String @id @default(cuid())

  // マーケットプレイス情報
  marketplace        Marketplace
  marketplaceOrderId String // eBay/Joomの注文ID

  // 購入者情報
  buyerUsername String
  buyerEmail    String?
  buyerName     String?

  // 配送先住所
  shippingAddress Json // { street, city, state, postalCode, country }

  // 金額情報
  subtotal     Float // 商品小計
  shippingCost Float // 送料
  tax          Float @default(0) // 税金
  total        Float // 合計金額
  currency     String @default("USD")

  // マーケット手数料
  marketplaceFee Float @default(0)
  paymentFee     Float @default(0)

  // ステータス
  status        OrderStatus     @default(PENDING)
  paymentStatus PaymentStatus   @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)

  // 追跡情報
  trackingNumber  String?
  trackingCarrier String?
  shippedAt       DateTime?

  // 生データ（デバッグ・参照用）
  rawData Json @default("{}")

  // タイムスタンプ
  orderedAt DateTime // マーケットプレイスでの注文日時
  paidAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 関連
  sales Sale[]

  @@unique([marketplace, marketplaceOrderId])
  @@index([status])
  @@index([marketplace, orderedAt])
  @@index([buyerUsername])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  DISPUTE
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  RETURNED
}

// ========================================
// 売上明細
// ========================================
model Sale {
  id String @id @default(cuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  listingId String?
  productId String?

  // 商品情報
  sku          String
  title        String
  quantity     Int    @default(1)
  unitPrice    Float
  totalPrice   Float

  // 利益計算
  costPrice    Float? // 仕入価格（円）
  profitJpy    Float? // 利益（円）
  profitRate   Float? // 利益率（%）

  // マーケットプレイス商品ID
  marketplaceItemId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([listingId])
  @@index([productId])
  @@index([sku])
  @@map("sales")
}

// ========================================
// Webhookイベント（履歴・デバッグ用）
// ========================================
model WebhookEvent {
  id String @id @default(cuid())

  // ソース情報
  provider  String // EBAY, JOOM
  eventType String // ORDER_CREATED, PAYMENT_COMPLETE, etc.

  // ペイロード
  payload       Json
  headers       Json @default("{}")
  signature     String?

  // 処理状態
  status        WebhookEventStatus @default(PENDING)
  processedAt   DateTime?
  errorMessage  String?            @db.Text
  retryCount    Int                @default(0)

  // 関連
  orderId   String?
  listingId String?

  createdAt DateTime @default(now())

  @@index([provider, eventType])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_events")
}

enum WebhookEventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  IGNORED
}

// ========================================
// アラートルール（Phase 26）
// ========================================
model AlertRule {
  id                 String   @id @default(cuid())
  name               String
  eventType          String
  conditions         Json     @default("[]")
  severity           String   @default("info")
  channels           String[]
  cooldownMinutes    Int      @default(30)
  batchWindowMinutes Int      @default(5)
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([eventType])
  @@index([isActive])
  @@map("alert_rules")
}

// ========================================
// アラートログ（Phase 26）
// ========================================
model AlertLog {
  id        String    @id @default(cuid())
  ruleId    String?
  eventType String
  severity  String
  title     String
  message   String    @db.Text
  metadata  Json?
  channels  String[]
  status    String    @default("pending")
  batchId   String?
  sentAt    DateTime?
  errorMsg  String?
  createdAt DateTime  @default(now())

  @@index([eventType, createdAt])
  @@index([status])
  @@index([batchId])
  @@map("alert_logs")
}

// ========================================
// スケジュールレポート（Phase 32）
// ========================================
model ScheduledReport {
  id        String @id @default(cuid())
  name      String
  reportType String // 'daily' | 'weekly' | 'monthly' | 'custom'

  // スケジュール設定
  cronExpression String           // cron式（例: "0 9 * * *" = 毎日9時）
  timezone       String @default("Asia/Tokyo")
  isActive       Boolean @default(true)

  // レポート設定
  format        String @default("markdown") // 'json' | 'markdown' | 'csv'
  includeCharts Boolean @default(false)
  customQuery   Json?  // カスタムフィルター条件

  // 配信設定
  deliveryChannels String[] // チャンネルID or 'email:xxx@example.com'
  emailRecipients  String[] // メールアドレス
  emailSubject     String?

  // 実行履歴
  lastRunAt      DateTime?
  lastRunStatus  String?   // 'success' | 'failed'
  lastRunError   String?
  nextRunAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, nextRunAt])
  @@index([reportType])
  @@map("scheduled_reports")
}

// スケジュールレポート実行ログ
model ScheduledReportLog {
  id        String   @id @default(cuid())
  reportId  String
  status    String   // 'running' | 'success' | 'failed'
  startedAt DateTime @default(now())
  endedAt   DateTime?
  duration  Int?     // 実行時間（ミリ秒）
  error     String?
  metadata  Json?    // 結果サマリーなど

  @@index([reportId, startedAt])
  @@map("scheduled_report_logs")
}

// ========================================
// 価格履歴（Phase 28）
// ========================================
model PriceHistory {
  id         String   @id @default(cuid())
  listingId  String
  price      Float
  currency   String   @default("USD")
  source     String   // 'manual' | 'rule' | 'ai' | 'competitor' | 'initial'
  metadata   Json?    // 追加情報（変更理由など）
  recordedAt DateTime @default(now())

  @@index([listingId, recordedAt])
  @@index([recordedAt])
  @@map("price_histories")
}

// ========================================
// 競合価格ログ（Phase 28）
// ========================================
model CompetitorPriceLog {
  id                   String   @id @default(cuid())
  competitorIdentifier String   // 競合商品識別子（URL or ID）
  listingId            String?  // 関連する自社出品
  productId            String?  // 関連する自社商品
  marketplace          String   // 競合のマーケットプレイス
  price                Float
  currency             String   @default("USD")
  title                String?  // 競合商品タイトル
  url                  String?  // 競合商品URL
  metadata             Json?    // 追加データ
  recordedAt           DateTime @default(now())

  // Phase 29: 拡張フィールド
  conditionRank    String?  // コンディションランク (A/B/C/D/unknown)
  matchConfidence  Float?   // マッチング確度 (0-1)
  isVerified       Boolean  @default(false) // 人間による検証済み
  verifiedBy       String?  // 検証者
  verifiedAt       DateTime? // 検証日時
  sellerRating     Float?   // 出品者評価
  stockStatus      String?  // 在庫状態 (in_stock/low_stock/out_of_stock)
  shippingCost     Float?   // 送料
  priceChange      Float?   // 前回からの価格変動
  priceChangePercent Float? // 前回からの価格変動率

  // トラッカー参照
  trackerId        String?
  tracker          CompetitorTracker? @relation(fields: [trackerId], references: [id])

  @@index([listingId, recordedAt])
  @@index([productId, recordedAt])
  @@index([competitorIdentifier, recordedAt])
  @@index([recordedAt])
  @@index([trackerId])
  @@index([isVerified])
  @@map("competitor_price_logs")
}

// ========================================
// 競合トラッキング設定（Phase 29）
// ========================================
model CompetitorTracker {
  id                   String   @id @default(cuid())
  listingId            String?  // 関連する自社出品
  productId            String?  // 関連する自社商品
  competitorIdentifier String   // 競合商品識別子
  marketplace          String   // 競合のマーケットプレイス
  url                  String   // 競合商品URL
  title                String?  // 競合商品タイトル

  // マッチング情報
  matchMethod          String   @default("manual") // manual/keyword/barcode/ai
  matchConfidence      Float    @default(1.0) // マッチング確度
  isVerified           Boolean  @default(false) // 人間による検証済み
  verifiedBy           String?
  verifiedAt           DateTime?

  // トラッキング設定
  isActive             Boolean  @default(true)
  checkInterval        Int      @default(360) // チェック間隔（分）
  alertOnPriceDrop     Boolean  @default(true)
  alertOnPriceRise     Boolean  @default(false)
  alertThresholdPercent Float   @default(5.0) // アラート閾値（%）
  autoAdjustPrice      Boolean  @default(false) // 自動価格調整

  // 最終チェック情報
  lastPrice            Float?
  lastCheckedAt        DateTime?
  lastError            String?
  consecutiveErrors    Int      @default(0)

  // タイムスタンプ
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // リレーション
  priceLogs            CompetitorPriceLog[]

  @@unique([listingId, competitorIdentifier])
  @@index([listingId])
  @@index([productId])
  @@index([isActive])
  @@index([lastCheckedAt])
  @@map("competitor_trackers")
}

// ========================================
// 競合アラート（Phase 29）
// ========================================
model CompetitorAlert {
  id               String   @id @default(cuid())
  trackerId        String
  listingId        String?
  productId        String?

  // アラート内容
  alertType        String   // price_drop/price_rise/out_of_stock/new_competitor
  severity         String   @default("medium") // low/medium/high/critical
  title            String
  message          String   @db.Text

  // 価格情報
  ourPrice         Float?
  competitorPrice  Float?
  priceDiff        Float?
  priceDiffPercent Float?

  // ステータス
  status           String   @default("pending") // pending/acknowledged/resolved/dismissed
  acknowledgedBy   String?
  acknowledgedAt   DateTime?
  resolvedAt       DateTime?

  // メタデータ
  metadata         Json?
  createdAt        DateTime @default(now())

  @@index([listingId])
  @@index([productId])
  @@index([status])
  @@index([alertType])
  @@index([createdAt])
  @@map("competitor_alerts")
}

// ========================================
// 価格推奨（Phase 28）
// ========================================
model PriceRecommendation {
  id               String   @id @default(cuid())
  listingId        String
  productId        String?

  // 価格情報
  currentPrice     Float
  recommendedPrice Float
  minPrice         Float?   // ルールによる下限
  maxPrice         Float?   // ルールによる上限

  // 推奨の詳細
  confidence       Float    @default(0.5) // 0-1 信頼度
  reason           Json     // 推奨根拠（JSON）
  impact           Json?    // 影響試算（JSON）
  ruleId           String?  // 適用されたルールID

  // ステータス
  status           PriceRecommendationStatus @default(PENDING)
  expiresAt        DateTime

  // 処理履歴
  approvedBy       String?  // 承認者
  approvedAt       DateTime?
  appliedAt        DateTime?
  rejectedReason   String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([listingId, status])
  @@index([status, expiresAt])
  @@index([createdAt])
  @@map("price_recommendations")
}

enum PriceRecommendationStatus {
  PENDING    // 承認待ち
  APPROVED   // 承認済み（適用待ち）
  REJECTED   // 却下
  APPLIED    // 適用済み
  EXPIRED    // 期限切れ
  CANCELLED  // キャンセル
}

// ========================================
// 価格ルール（Phase 28）
// ========================================
model PricingRule {
  id          String   @id @default(cuid())
  name        String
  description String?

  // ルールタイプ
  type        PricingRuleType

  // ルール定義
  conditions  Json     // 適用条件（JSON配列）
  actions     Json     // アクション定義（JSON配列）

  // 適用範囲
  marketplace String?  // null = 全マーケットプレイス
  category    String?  // null = 全カテゴリ

  // 優先度と状態
  priority    Int      @default(0) // 高いほど優先
  isActive    Boolean  @default(true)

  // 安全設定
  safetyConfig Json?   // サーキットブレーカー設定

  // 統計
  appliedCount Int     @default(0)
  lastAppliedAt DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type, isActive])
  @@index([priority])
  @@map("pricing_rules")
}

enum PricingRuleType {
  COMPETITOR_FOLLOW  // 競合追従
  MIN_MARGIN         // 最低利益率維持
  MAX_DISCOUNT       // 最大値下げ制限
  DEMAND_BASED       // 需要ベース
  TIME_BASED         // 時間ベース（滞留日数など）
  CUSTOM             // カスタム
}

// ========================================
// 価格変更ログ（Phase 28）
// ========================================
model PriceChangeLog {
  id               String   @id @default(cuid())
  listingId        String
  recommendationId String?

  // 価格変更
  oldPrice         Float
  newPrice         Float
  currency         String   @default("USD")
  changePercent    Float    // 変更率（%）

  // 変更理由
  source           String   // 'manual' | 'rule' | 'ai' | 'auto'
  ruleId           String?
  reason           String?

  // プラットフォーム更新
  platformUpdated  Boolean  @default(false)
  platformError    String?

  createdAt        DateTime @default(now())

  @@index([listingId, createdAt])
  @@index([source, createdAt])
  @@map("price_change_logs")
}

// ========================================
// マーケットプレイス同期設定（Phase 44-B）
// ========================================
model MarketplaceSyncSetting {
  id             String    @id @default(cuid())
  marketplace    String    // 'JOOM' | 'EBAY'
  syncType       String    // 'INVENTORY' | 'ORDER' | 'PRICE'
  cronExpression String    // cron式
  isEnabled      Boolean   @default(true)
  lastRunAt      DateTime?
  nextRunAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([marketplace, syncType])
  @@index([isEnabled])
  @@map("marketplace_sync_settings")
}
