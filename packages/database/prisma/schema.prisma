// Prisma Schema for Auto Listing System
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// 仕入元情報
// ========================================
model Source {
  id        String     @id @default(cuid())
  type      SourceType
  name      String
  url       String?
  isActive  Boolean    @default(true)
  metadata  Json       @default("{}")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  products Product[]

  @@map("sources")
}

enum SourceType {
  MERCARI
  YAHOO_AUCTION
  YAHOO_FLEA
  RAKUMA
  RAKUTEN
  AMAZON
  TAKAYAMA
  JOSHIN
  OTHER
}

// ========================================
// 統一商品モデル
// ========================================
model Product {
  id String @id @default(cuid())

  // ソース情報
  sourceId     String
  source       Source @relation(fields: [sourceId], references: [id])
  sourceItemId String // 元サイトの商品ID
  sourceUrl    String
  sourceHash   String? // 差分検知用ハッシュ

  // 基本情報（原文）
  title       String
  description String @db.Text
  price       Int // 仕入価格（円）

  // 翻訳済み情報
  titleEn       String?
  descriptionEn String? @db.Text

  // 商品属性
  category   String?
  brand      String?
  condition  String?
  weight     Int? // グラム
  attributes Json   @default("{}") // AI抽出属性

  // 画像
  images          String[] // 元画像URL
  processedImages String[] // 白抜き後URL（MinIO/S3）

  // セラー情報
  sellerId   String?
  sellerName String?

  // ステータス
  status            ProductStatus @default(PENDING_SCRAPE)
  translationStatus ProcessStatus @default(PENDING)
  imageStatus       ProcessStatus @default(PENDING)
  lastError         String?       @db.Text

  // タイムスタンプ
  scrapedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  listings Listing[]
  jobLogs  JobLog[]

  @@unique([sourceId, sourceItemId])
  @@index([status])
  @@index([sourceHash])
  @@index([createdAt])
  @@map("products")
}

enum ProductStatus {
  PENDING_SCRAPE
  SCRAPED
  PROCESSING_IMAGES
  TRANSLATING
  READY_TO_REVIEW
  APPROVED
  PUBLISHING
  ACTIVE
  SOLD
  OUT_OF_STOCK
  ERROR
  DELETED
}

enum ProcessStatus {
  PENDING
  PROCESSING
  COMPLETED
  ERROR
}

// ========================================
// 出品情報（マーケットプレイス別）
// ========================================
model Listing {
  id String @id @default(cuid())

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  marketplace          Marketplace
  marketplaceListingId String? // eBay/Joom の出品ID

  // 価格情報
  listingPrice Float // 出品価格（USD）
  shippingCost Float? // 送料
  currency     String @default("USD")

  // マーケット固有データ（JSONB）
  marketplaceData Json @default("{}")

  // ステータス
  status       ListingStatus @default(DRAFT)
  errorMessage String?       @db.Text

  // タイムスタンプ
  listedAt  DateTime?
  soldAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([productId, marketplace])
  @@index([marketplace, status])
  @@index([marketplaceListingId])
  @@map("listings")
}

enum Marketplace {
  JOOM
  EBAY
}

enum ListingStatus {
  DRAFT
  PENDING_PUBLISH
  PUBLISHING
  ACTIVE
  PAUSED
  SOLD
  ENDED
  ERROR
}

// ========================================
// ジョブログ
// ========================================
model JobLog {
  id String @id @default(cuid())

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  jobId        String // BullMQ Job ID
  queueName    String
  jobType      String
  status       JobStatus
  payload      Json      @default("{}")
  result       Json?
  errorMessage String?   @db.Text

  startedAt   DateTime
  completedAt DateTime?
  duration    Int? // ミリ秒

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([queueName, status])
  @@index([createdAt])
  @@index([jobId])
  @@map("job_logs")
}

enum JobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  DEAD_LETTER
}

// ========================================
// 価格計算設定
// ========================================
model PriceSetting {
  id String @id @default(cuid())

  name        String      @unique
  marketplace Marketplace

  // 手数料
  platformFeeRate Float // プラットフォーム手数料率
  paymentFeeRate  Float // 決済手数料率

  // マージン
  targetProfitRate Float // 目標利益率
  adRate           Float @default(0) // 広告費率

  // 為替
  exchangeRate   Float // USD/JPY
  exchangeBuffer Float @default(0) // 為替バッファ

  // カテゴリ別設定（オプション）
  categorySettings Json @default("{}")

  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("price_settings")
}

// ========================================
// eBay シッピングポリシー
// ========================================
model ShippingPolicy {
  id String @id @default(cuid())

  name   String
  region String // US, EU, ASIA など

  // 配送方法
  carrier String // ePacket, Cpass, EMS など

  // 送料テーブル（重量別）
  shippingTable Json // { "100": 880, "200": 1060, ... }

  // 燃油サーチャージ
  fuelSurcharge Float @default(0)

  // 関税設定
  dutyThreshold Float? // 関税閾値（USD）
  dutyRate      Float? // 関税率

  // 追加設定
  handlingTime Int    @default(1) // 発送準備日数
  metadata     Json   @default("{}")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([region, carrier])
  @@map("shipping_policies")
}

// ========================================
// 為替レート履歴
// ========================================
model ExchangeRate {
  id String @id @default(cuid())

  fromCurrency String @default("JPY")
  toCurrency   String @default("USD")
  rate         Float

  fetchedAt DateTime @default(now())
  source    String   @default("manual") // manual, api, etc.

  @@index([fromCurrency, toCurrency, fetchedAt])
  @@map("exchange_rates")
}

// ========================================
// 翻訳プロンプト設定
// ========================================
model TranslationPrompt {
  id String @id @default(cuid())

  name        String  @unique // プロンプト名
  category    String? // 対象カテゴリ（nullはデフォルト）
  marketplace String? // joom, ebay, null=共通

  // プロンプト内容
  systemPrompt String @db.Text // システムプロンプト
  userPrompt   String @db.Text // ユーザープロンプトテンプレート

  // 抽出する属性
  extractAttributes String[] // ["brand", "model", "color", ...]

  // 追加指示
  additionalInstructions String? @db.Text
  seoKeywords            String[] // SEO推奨ワード

  // 設定
  priority  Int     @default(0) // 優先度（高いほど優先）
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  templates ListingTemplate[]

  @@index([category, marketplace])
  @@map("translation_prompts")
}

// ========================================
// eBay カテゴリマッピング
// ========================================
model EbayCategoryMapping {
  id String @id @default(cuid())

  sourceCategory String // 元カテゴリ（日本語）
  ebayCategoryId String // eBayカテゴリID
  ebayCategoryName String // eBayカテゴリ名

  // Item Specifics テンプレート
  itemSpecifics Json @default("{}")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  templates ListingTemplate[]

  @@unique([sourceCategory])
  @@map("ebay_category_mappings")
}

// ========================================
// 出品テンプレート
// ========================================
model ListingTemplate {
  id String @id @default(cuid())

  name        String @unique // テンプレート名
  description String? // 説明

  // カテゴリマッピングへの参照
  categoryMappingId String?
  categoryMapping   EbayCategoryMapping? @relation(fields: [categoryMappingId], references: [id])

  // 翻訳プロンプトへの参照
  translationPromptId String?
  translationPrompt   TranslationPrompt? @relation(fields: [translationPromptId], references: [id])

  // 価格設定
  profitRate Float @default(30) // 目標利益率 (%)
  minProfit  Float @default(500) // 最低利益額 (円)

  // 出品設定
  titleTemplate       String? @db.Text // タイトルテンプレート
  descriptionTemplate String? @db.Text // 説明文テンプレート
  conditionMapping    Json    @default("{}") // コンディション変換マップ

  // デフォルト値
  defaultWeight       Int?    // デフォルト重量 (g)
  defaultShippingDays String? // 配送日数

  // 設定
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryMappingId])
  @@map("listing_templates")
}

// ========================================
// マーケットプレイス認証情報
// ========================================
model MarketplaceCredential {
  id String @id @default(cuid())

  marketplace Marketplace
  name        String      @default("default") // アカウント名

  // 認証情報（暗号化推奨）
  credentials Json // { clientId, clientSecret, accessToken, refreshToken, ... }

  // トークン有効期限
  tokenExpiresAt        DateTime?
  refreshTokenExpiresAt DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([marketplace, name])
  @@index([marketplace, isActive])
  @@map("marketplace_credentials")
}

// ========================================
// OAuth状態管理（CSRF対策）
// ========================================
model OAuthState {
  id String @id @default(cuid())

  state     String   @unique
  provider  String // EBAY, JOOM, etc.
  expiresAt DateTime
  metadata  Json     @default("{}")

  createdAt DateTime @default(now())

  @@index([provider, expiresAt])
  @@map("oauth_states")
}

// ========================================
// 通知
// ========================================
model Notification {
  id String @id @default(cuid())

  type      NotificationType
  title     String
  message   String           @db.Text
  severity  NotificationSeverity @default(INFO)

  // 関連データ
  productId String?
  listingId String?
  jobLogId  String?
  metadata  Json @default("{}")

  // ステータス
  isRead    Boolean  @default(false)
  readAt    DateTime?

  createdAt DateTime @default(now())

  @@index([isRead, createdAt])
  @@index([type])
  @@map("notifications")
}

enum NotificationType {
  SCRAPE_COMPLETE
  SCRAPE_FAILED
  TRANSLATE_COMPLETE
  TRANSLATE_FAILED
  IMAGE_COMPLETE
  IMAGE_FAILED
  PUBLISH_COMPLETE
  PUBLISH_FAILED
  OUT_OF_STOCK
  PRICE_CHANGE
  SYSTEM
  // 注文関連
  ORDER_RECEIVED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  ORDER_REFUNDED
  ORDER_DISPUTE
}

enum NotificationSeverity {
  INFO
  WARNING
  ERROR
  SUCCESS
}

// ========================================
// 注文管理
// ========================================
model Order {
  id String @id @default(cuid())

  // マーケットプレイス情報
  marketplace        Marketplace
  marketplaceOrderId String // eBay/Joomの注文ID

  // 購入者情報
  buyerUsername String
  buyerEmail    String?
  buyerName     String?

  // 配送先住所
  shippingAddress Json // { street, city, state, postalCode, country }

  // 金額情報
  subtotal     Float // 商品小計
  shippingCost Float // 送料
  tax          Float @default(0) // 税金
  total        Float // 合計金額
  currency     String @default("USD")

  // マーケット手数料
  marketplaceFee Float @default(0)
  paymentFee     Float @default(0)

  // ステータス
  status        OrderStatus     @default(PENDING)
  paymentStatus PaymentStatus   @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)

  // 追跡情報
  trackingNumber  String?
  trackingCarrier String?
  shippedAt       DateTime?

  // 生データ（デバッグ・参照用）
  rawData Json @default("{}")

  // タイムスタンプ
  orderedAt DateTime // マーケットプレイスでの注文日時
  paidAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 関連
  sales Sale[]

  @@unique([marketplace, marketplaceOrderId])
  @@index([status])
  @@index([marketplace, orderedAt])
  @@index([buyerUsername])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  DISPUTE
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  RETURNED
}

// ========================================
// 売上明細
// ========================================
model Sale {
  id String @id @default(cuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  listingId String?
  productId String?

  // 商品情報
  sku          String
  title        String
  quantity     Int    @default(1)
  unitPrice    Float
  totalPrice   Float

  // 利益計算
  costPrice    Float? // 仕入価格（円）
  profitJpy    Float? // 利益（円）
  profitRate   Float? // 利益率（%）

  // マーケットプレイス商品ID
  marketplaceItemId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([listingId])
  @@index([productId])
  @@index([sku])
  @@map("sales")
}

// ========================================
// Webhookイベント（履歴・デバッグ用）
// ========================================
model WebhookEvent {
  id String @id @default(cuid())

  // ソース情報
  provider  String // EBAY, JOOM
  eventType String // ORDER_CREATED, PAYMENT_COMPLETE, etc.

  // ペイロード
  payload       Json
  headers       Json @default("{}")
  signature     String?

  // 処理状態
  status        WebhookEventStatus @default(PENDING)
  processedAt   DateTime?
  errorMessage  String?            @db.Text
  retryCount    Int                @default(0)

  // 関連
  orderId   String?
  listingId String?

  createdAt DateTime @default(now())

  @@index([provider, eventType])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_events")
}

enum WebhookEventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  IGNORED
}
