// Prisma Schema - Enrichment Pipeline


// ========================================
// Phase 39: エンリッチメントエンジン
// ========================================

// エンリッチメントタスク（翻訳・属性抽出・検証の統合管理）
model EnrichmentTask {
  id String @id @default(cuid())

  // 対象商品
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // 全体ステータス
  status   EnrichmentStatus @default(PENDING)
  priority Int              @default(0)

  // 各処理のステータス
  translationStatus EnrichmentStepStatus @default(PENDING)
  attributeStatus   EnrichmentStepStatus @default(PENDING)
  validationStatus  EnrichmentStepStatus @default(PENDING)
  imageStatus       EnrichmentStepStatus @default(PENDING)

  // 翻訳結果
  translations Json? // {en: {title, description}, ru: {title, description}}

  // 属性抽出結果
  attributes Json? // {brand, color, size, material, condition, itemSpecifics, confidence}

  // 検証結果
  validation       Json? // {passed, flags[], reviewNotes}
  validationResult ValidationResult @default(PENDING)

  // 画像処理結果
  bufferedImages  String[] // S3/MinIOに保存した画像URL
  optimizedImages String[] // 最適化済み画像URL

  // 価格計算結果
  pricing Json? // {costJpy, exchangeRate, profitRate, shippingCost, platformFee, finalPriceUsd}

  // エラー情報
  lastError  String? @db.Text
  errorCount Int     @default(0)
  maxRetries Int     @default(3)

  // 処理時間
  startedAt   DateTime?
  completedAt DateTime?
  duration    Int? // ミリ秒

  // タイムスタンプ
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // リレーション
  steps       EnrichmentStep[]
  joomListing JoomListing?

  @@unique([productId])
  @@index([status, priority])
  @@index([validationResult])
  @@index([createdAt])
  @@map("enrichment_tasks")
}


// エンリッチメントステップ履歴
model EnrichmentStep {
  id String @id @default(cuid())

  // タスク
  taskId String
  task   EnrichmentTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // ステップ情報
  stepType  EnrichmentStepType
  stepOrder Int

  // 実行状態
  status      EnrichmentStepStatus @default(PENDING)
  attempt     Int                  @default(1)
  maxAttempts Int                  @default(3)

  // 入出力
  input  Json? // 入力データ
  output Json? // 出力データ

  // エラー
  errorMessage String? @db.Text
  errorCode    String?

  // 処理時間
  startedAt   DateTime?
  completedAt DateTime?
  duration    Int? // ミリ秒

  // タイムスタンプ
  createdAt DateTime @default(now())

  @@index([taskId, stepType])
  @@index([status])
  @@map("enrichment_steps")
}


// 禁制品キーワード
model ProhibitedKeyword {
  id String @id @default(cuid())

  // キーワード
  keyword  String
  category ProhibitedCategory
  severity ProhibitedSeverity @default(HIGH)

  // マッチング設定
  matchType     KeywordMatchType @default(CONTAINS)
  caseSensitive Boolean          @default(false)

  // 対象言語
  languages String[] // ja, en, ru等

  // 説明
  description String?
  reason      String? // 禁止理由

  // ステータス
  isActive Boolean @default(true)

  // タイムスタンプ
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category, isActive])
  @@index([keyword])
  @@map("prohibited_keywords")
}


// ========================================
// Phase 39-40 Enums
// ========================================

enum EnrichmentStatus {
  PENDING // 待機中
  PROCESSING // 処理中
  READY_TO_REVIEW // レビュー待ち
  APPROVED // 承認済み
  REJECTED // 却下
  PUBLISHING // 出品中
  PUBLISHED // 出品完了
  FAILED // 失敗
}

enum EnrichmentStepStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

enum EnrichmentStepType {
  TRANSLATION // 翻訳
  ATTRIBUTE_EXTRACTION // 属性抽出
  CONTENT_VALIDATION // コンテンツ検証
  IMAGE_DOWNLOAD // 画像ダウンロード
  IMAGE_OPTIMIZATION // 画像最適化
  IMAGE_UPLOAD // 画像アップロード
  PRICE_CALCULATION // 価格計算
  JOOM_PUBLISH // Joom出品
}

enum ValidationResult {
  PENDING // 未検証
  APPROVED // 承認
  REJECTED // 却下（禁制品）
  REVIEW_REQUIRED // 要確認
}

enum ProhibitedCategory {
  BATTERY // 電池関連
  HAZARDOUS // 危険物
  CITES // ワシントン条約
  TRADEMARK // 商標侵害
  ADULT // 成人向け
  PHARMACEUTICAL // 医薬品
  WEAPON // 武器
  COUNTERFEIT // 偽造品
  OTHER // その他
}

enum ProhibitedSeverity {
  LOW // 低（警告のみ）
  MEDIUM // 中（レビュー必要）
  HIGH // 高（自動却下）
  CRITICAL // 致命的（即却下）
}

enum KeywordMatchType {
  EXACT // 完全一致
  CONTAINS // 部分一致
  STARTS_WITH // 前方一致
  REGEX // 正規表現
}

